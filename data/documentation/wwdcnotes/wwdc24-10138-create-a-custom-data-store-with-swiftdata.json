{"schemaVersion":{"minor":3,"major":0,"patch":0},"metadata":{"title":"Create a custom data store with SwiftData","roleHeading":"WWDC24","role":"sampleCode","modules":[{"name":"WWDC Notes"}]},"kind":"article","identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC24-10138-Create-a-custom-data-store-with-SwiftData","interfaceLanguage":"swift"},"primaryContentSections":[{"content":[{"type":"heading","level":1,"text":"Key Takeaways","anchor":"Key-Takeaways"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"‚ÄºÔ∏è The New Data Store Protocol"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"üèÑüèΩ‚Äç‚ôÇÔ∏è Use custom persistence backends"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"üå©Ô∏è SwiftData storage in the cloud"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"üß∞ JSON as an archival persistent store"}],"type":"paragraph"}]}]},{"type":"row","numberOfColumns":2,"columns":[{"content":[{"type":"paragraph","inlineContent":[{"identifier":"WWDC24-10138-Overview1","type":"image"}]}],"size":1},{"content":[{"inlineContent":[{"type":"image","identifier":"WWDC24-10138-Overview2"}],"type":"paragraph"}],"size":1}]},{"type":"row","numberOfColumns":2,"columns":[{"size":1,"content":[{"inlineContent":[{"type":"image","identifier":"WWDC24-10138-Overview3"}],"type":"paragraph"}]},{"size":1,"content":[{"inlineContent":[{"identifier":"WWDC24-10138-Overview4","type":"image"}],"type":"paragraph"}]}]},{"type":"heading","level":1,"text":"Presenter","anchor":"Presenter"},{"type":"paragraph","inlineContent":[{"text":"Luvena Huo, SwiftData Engineer","type":"text"}]},{"type":"heading","level":1,"text":"Overview","anchor":"Overview"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"The View consumes data from a Model in a ModelContext."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"The ModelContext reads and writes data using a ModelContainer with an associated Store.","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"The Store fetch and save data (from the persistence backend) required to support the persistent models.","type":"text"}]}]}]},{"type":"heading","level":2,"text":"The Store in SwiftData ecoverse:","anchor":"The-Store-in-SwiftData-ecoverse"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The ModelContext instantiates persistent models with associated persistent identifiers and track changes to be saved to the permanent Store."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"text":"Remaping","type":"text"}]},{"type":"text","text":": is the process of assigning a permanent persistent identifier to a temporary one. The temporary persistent identifiers are generated when changes are translated by the View in the ModelContext to objects not yet persisted to the Store."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Snapshots"}]},{"type":"text","text":": are used as a method of communication between the ModelContext and the Store (and viceversa). Snapshots are "},{"type":"emphasis","inlineContent":[{"type":"text","text":"‚Äúsendable, codable containers of the values in the model at that point in time‚Äù"}]},{"type":"text","text":"."}]}]}]},{"type":"heading","level":1,"text":"The New DataStore Protocol","anchor":"The-New-DataStore-Protocol"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Allows the ModelContext to R&W model data to "},{"type":"strong","inlineContent":[{"type":"text","text":"any storage format"}]},{"type":"text","text":"."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"There are 3 protocols related to a store:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Data Store ","type":"text"},{"inlineContent":[{"type":"text","text":"Configuration"}],"type":"strong"},{"text":": describe the store.","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Data Store ","type":"text"},{"inlineContent":[{"type":"text","text":"Snapshot"}],"type":"strong"},{"text":": communication protocol between the Store and the ModelContext. Data Store fetch request & Data Store fetch result. Associated snapshots & remapping.","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"type":"text","text":"Data Store"}],"type":"strong"},{"text":": functionality needed by the ModelContext to use the Data Store.","type":"text"}]}]}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Additional protocols: History protocol (check related session notes)."}]}]}]},{"type":"heading","level":1,"text":"JSON Store type as an example","anchor":"JSON-Store-type-as-an-example"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Example of using "},{"type":"strong","inlineContent":[{"text":"JSON","type":"text"}]},{"type":"text","text":" as a file to persist the models. This is an "},{"type":"strong","inlineContent":[{"text":"archival store","type":"text"}]},{"type":"text","text":", meaning that the entire file is loaded & saved when performing R||W operations to the Store."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The data is stored as an "},{"type":"strong","inlineContent":[{"type":"text","text":"array of snapshots"}]},{"type":"text","text":" in the file."}]},{"type":"heading","level":2,"text":"Steps","anchor":"Steps"},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Reference","type":"text"}]},{"text":" using associated types.","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Declare ","type":"text"},{"inlineContent":[{"type":"text","text":"snapshot usage"}],"type":"strong"},{"text":".","type":"text"}]}]}]},{"type":"codeListing","syntax":"swift","code":["final class JSONStoreConfiguration: DataStoreConfiguration {","    \/\/ (1): cross reference","    typealias StoreType = JSONStore","    ...","}","","final class JSONStore: DataStore {","    \/\/ (1): cross reference","    typealias Configuration = JSONStoreConfiguration","    \/\/ (2): no need to customize the default data encoding\/decoding","    typealias Snapshot = DefaultSnapshot","    ...","}"]},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Implement the ","type":"text"},{"inlineContent":[{"text":"required methods","type":"text"}],"type":"strong"},{"text":": fetch & save. You need to implement these two methods to make the Store usable by the ModelContext.","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Implement "},{"inlineContent":[{"text":"fetch","type":"text"}],"type":"strong"},{"type":"text","text":" (R): load data from the store & return results."}],"type":"paragraph"}]}],"start":3},{"type":"codeListing","syntax":"swift","code":["class JSONStore: DataStore {","    func fetch<T>(_ request: DataStoreFetchRequest<T>) throws -> DataStoreFetchResult<T, DefaultSnapshot> where T : PersistentModel {","        ","        \/\/ (1): load data from the store","        let decoder = JSONDecoder ()","        let data = try Data(contentsof: configuration.fileURL)","        let trips = try decoder decode ([DefaultSnapshot].self, from: data)","","        \/\/ (2): return results","        return DataStoreFetchResult(descriptor: request.descriptor, fetchedSnapshots: trips)","    }","}"]},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Implement ","type":"text"},{"inlineContent":[{"text":"save","type":"text"}],"type":"strong"},{"text":" (CUD): write the snapshots into the JSON file.","type":"text"}]}]}],"start":5},{"type":"paragraph","inlineContent":[{"type":"text","text":"Steps:"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Read the current content of the file: ","type":"text"},{"inlineContent":[{"text":"read()","type":"text"}],"type":"strong"}],"type":"paragraph"}]}]},{"type":"codeListing","syntax":"swift","code":["var snapshotsByIdentifier = [PersistentIdentifier: DefaultSnapshot]()","try self.read().forEach { snapshotsByIdentifier[$0.persistentIdentifier] = $0 }"]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"type":"text","text":"Assigning"}],"type":"strong"},{"type":"text","text":" and "},{"inlineContent":[{"text":"remapping","type":"text"}],"type":"strong"},{"type":"text","text":" identifiers (create or update from temporary to permanent ones)."}]}]}]},{"type":"codeListing","syntax":"swift","code":["var remappedIdentifiers = [PersistentIdentifier: PersistentIdentifier]()","for snapshot in request. inserted {","    let entityName = snapshot.persistentIdentifier.entityName","    let permanentIdentifier = try PersistentIdentifier.identifier(for: identifier, entityName: entityName, primaryKey: UUID())","    let snapshotCopy = snapshot.copy(persistentIdentifier: permanentIdentifier)","    remappedIdentifiers[snapshot.persistentIdentifier] = permanentIdentifier","    snapshotsByIdentifier[permanentIdentifier] = snapshotCopy","}"]},{"type":"codeListing","syntax":"swift","code":["for snapshot in request.updated {","    snapshotsByIdentifier[snapshot.persistentIdentifier] = snapshot","ÔΩù"]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Remove deleted"}]},{"text":" snapshots.","type":"text"}]}]}]},{"type":"codeListing","syntax":"swift","code":["for snapshot in request.deleted {","    snapshotsByIdentifier[snapshot.persistentIdentifier] = nil","}"]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"Save","type":"text"}],"type":"strong"},{"text":" working snapshot copy to disk.","type":"text"}]}]}]},{"type":"codeListing","syntax":"swift","code":["for snapshot in request.updated {","let snapshots = snapshotsByIdentifier.values.map(‚Äπ $0 })","let encoder = JSONEncoder()","let jsonData = try encoder. encode(snapshots)","try jsonData.write(to: configuration.fileURL)"]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Return the ","type":"text"},{"type":"strong","inlineContent":[{"type":"text","text":"save()"}]},{"text":" operation result with the remapped persistent identifiers.","type":"text"}],"type":"paragraph"}]}]},{"type":"codeListing","syntax":"swift","code":["return DataStoreSaveChangesResult(for: self.identifier,","remappedIdentifiers: remappedIdentifiers)"]},{"type":"heading","level":2,"text":"Written By","anchor":"Written-By"},{"type":"row","numberOfColumns":5,"columns":[{"size":1,"content":[{"inlineContent":[{"identifier":"n3twr","type":"image"}],"type":"paragraph"}]},{"size":4,"content":[{"level":3,"text":"Juan","anchor":"Juan","type":"heading"},{"inlineContent":[{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/n3twr","isActive":true,"overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"type":"reference","overridingTitle":"Contributed Notes"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/github.com\/n3twr","isActive":true,"type":"reference"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/","isActive":true,"type":"reference"}],"type":"paragraph"}]}]},{"type":"thematicBreak"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Missing anything? Corrections? "},{"isActive":true,"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}]},{"type":"heading","level":2,"text":"Related Sessions","anchor":"Related-Sessions"},{"style":"list","type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC24-10075-Track-model-changes-with-SwiftData-history"]},{"type":"small","inlineContent":[{"type":"strong","inlineContent":[{"text":"Legal Notice","type":"text"}]}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright ¬© 2012 ‚Äì 2025 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}],"kind":"content"}],"sampleCodeDownload":{"action":{"identifier":"https:\/\/developer.apple.com\/wwdc24\/10138","type":"reference","overridingTitle":"Watch Video","isActive":true},"kind":"sampleDownload"},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc24-10138-create-a-custom-data-store-with-swiftdata"]}],"sections":[],"abstract":[{"type":"text","text":"Combine the power of SwiftData‚Äôs expressive, declarative modeling API with your own persistence backend. Learn how to build a custom data store and explore how to progressively add persistence features in your app. To get the most out of this session, watch ‚ÄúMeet SwiftData‚Äù and ‚ÄúModel your schema with SwiftData‚Äù from WWDC23."}],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC24"]]},"references":{"WWDC24-10138-Overview3":{"variants":[{"url":"\/images\/WWDCNotes\/WWDC24-10138-Overview3.jpg","traits":["1x","light"]}],"alt":null,"identifier":"WWDC24-10138-Overview3","type":"image"},"WWDCNotes.png":{"identifier":"WWDCNotes.png","type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDCNotes.png"}],"alt":null},"doc://WWDCNotes/documentation/WWDCNotes":{"url":"\/documentation\/wwdcnotes","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","type":"topic","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"role":"collection","abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"kind":"symbol","title":"WWDC Notes"},"n3twr.jpeg":{"alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/n3twr.jpeg"}],"type":"image","identifier":"n3twr.jpeg"},"https://":{"titleInlineContent":[{"text":"Blog","type":"text"}],"url":"https:\/\/","identifier":"https:\/\/","type":"link","title":"Blog"},"https://github.com/n3twr":{"identifier":"https:\/\/github.com\/n3twr","type":"link","title":"GitHub","titleInlineContent":[{"text":"GitHub","type":"text"}],"url":"https:\/\/github.com\/n3twr"},"https://developer.apple.com/wwdc24/10138":{"url":"https:\/\/developer.apple.com\/wwdc24\/10138","checksum":null,"type":"download","identifier":"https:\/\/developer.apple.com\/wwdc24\/10138"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC24":{"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC24","abstract":[{"type":"text","text":"Xcode 16, Swift 6, iOS 18, macOS 15 (Sequoia), tvOS 18, visionOS 2, watchOS 11."},{"type":"text","text":" "},{"type":"text","text":"New APIs: Swift Testing, "},{"type":"codeVoice","code":"FinanceKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"TabletopKit"},{"type":"text","text":", and more."}],"images":[{"identifier":"WWDC24-Icon.png","type":"icon"},{"identifier":"WWDC24.jpeg","type":"card"}],"url":"\/documentation\/wwdcnotes\/wwdc24","kind":"article","role":"collectionGroup","title":"WWDC24"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}],"url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"link","title":"Contributions are welcome!"},"n3twr":{"alt":"Profile image of Juan","variants":[{"url":"\/images\/WWDCNotes\/n3twr.jpeg","traits":["1x","light"]}],"type":"image","identifier":"n3twr"},"doc://WWDCNotes/documentation/WWDCNotes/n3twr":{"type":"topic","url":"\/documentation\/wwdcnotes\/n3twr","abstract":[{"type":"text","text":"No Bio on GitHub"}],"kind":"article","images":[{"type":"card","identifier":"n3twr.jpeg"},{"type":"icon","identifier":"n3twr.jpeg"}],"title":"Juan (3 notes)","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/n3twr"},"WWDC24-10138-Overview2":{"identifier":"WWDC24-10138-Overview2","type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC24-10138-Overview2.jpg"}],"alt":null},"WWDC24.jpeg":{"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC24.jpeg"}],"alt":null,"identifier":"WWDC24.jpeg","type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC24-10075-Track-model-changes-with-SwiftData-history":{"kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC24-10075-Track-model-changes-with-SwiftData-history","role":"sampleCode","abstract":[{"text":"Reveal the history of your model‚Äôs changes with SwiftData! Use the history API to understand when data store changes occurred, and learn how to use this information to build features like remote server sync and out-of-process change handing in your app. We‚Äôll also cover how you can build support for the history API into a custom data store.","type":"text"}],"url":"\/documentation\/wwdcnotes\/wwdc24-10075-track-model-changes-with-swiftdata-history","title":"Track model changes with SwiftData history","type":"topic"},"WWDC24-10138-Overview4":{"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC24-10138-Overview4.jpg"}],"alt":null,"identifier":"WWDC24-10138-Overview4","type":"image"},"WWDC24-Icon.png":{"alt":null,"variants":[{"url":"\/images\/WWDCNotes\/WWDC24-Icon.png","traits":["1x","light"]}],"type":"image","identifier":"WWDC24-Icon.png"},"WWDC24-10138-Overview1":{"identifier":"WWDC24-10138-Overview1","type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC24-10138-Overview1.jpg"}],"alt":null}}}