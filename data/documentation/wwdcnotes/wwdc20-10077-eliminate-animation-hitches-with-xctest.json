{"metadata":{"title":"Eliminate animation hitches with XCTest","roleHeading":"WWDC20","modules":[{"name":"WWDC Notes"}],"role":"sampleCode"},"kind":"article","sections":[],"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10077-Eliminate-animation-hitches-with-XCTest","interfaceLanguage":"swift"},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20"]]},"abstract":[{"text":"Animations can dramatically enhance the user experience of your app, provide a sense of direct manipulation, and help people to better understand the results of their actions. Animation hitches can break that experience. Discover how to use XCTest to detect interruptions to smooth scrolling and animations, and learn how to catch regressions before they affect the people relying on your app.","type":"text"}],"sampleCodeDownload":{"action":{"overridingTitle":"Watch Video (13 min)","type":"reference","identifier":"https:\/\/developer.apple.com\/wwdc20\/10077","isActive":true},"kind":"sampleDownload"},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc20-10077-eliminate-animation-hitches-with-xctest"]}],"schemaVersion":{"minor":3,"major":0,"patch":0},"primaryContentSections":[{"content":[{"text":"Hitches","type":"heading","level":2,"anchor":"Hitches"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Scrolling animation sometimes appears to jitter, those jitters in Xcode are called hitches"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"A ","type":"text"},{"type":"emphasis","inlineContent":[{"text":"hitch","type":"text"}]},{"text":" is a frame that is displayed on the screen later than expected.","type":"text"},{"text":" ","type":"text"},{"type":"image","identifier":"WWDC20-10077-frame_delay"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"iPhones and iPads have screens with 60Hz refresh rate, iPad Pros go up to 120Hz. 60Hz means that each frame should stay on screen for 16.67ms, 120Hz means 8.33ms"}]}]},{"content":[{"inlineContent":[{"text":"VSYNC is what usually manages swapping frames on screen, we see a hitch when a frame misses its expected VSYNC","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Hitch Metrics","type":"heading","level":2,"anchor":"Hitch-Metrics"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Hitch time: how many ms a frame is late","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Hitch ratio: Hitch time in ms per second for a given duration of hitches for a given duration (for a test, scroll event or transition)"}]}]},{"content":[{"inlineContent":[{"text":"Hitch time isn’t accurate as the desired screen refresh rate isn’t always 60 or 120fps, it can be perfectly fine for VSYNC to swipe zero frames for an idle screen","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"This is why we use Hitch ratio, it’s consistent across different cases and tests","type":"text"}]}]}],"type":"unorderedList"},{"text":"User impact targets for hitch ratio:","type":"heading","level":3,"anchor":"User-impact-targets-for-hitch-ratio"},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC20-10077-hitch_ratio_targets"}]},{"name":"Note","content":[{"inlineContent":[{"type":"text","text":"You should always aim to have <= 5ms\/s hitch ratio"}],"type":"paragraph"}],"type":"aside","style":"note"},{"text":"Measuring Hitches","type":"heading","level":2,"anchor":"Measuring-Hitches"},{"items":[{"content":[{"inlineContent":[{"text":"It’s possible to measure hitches in development and production environment (production for iOS 14 only) using different tools:","type":"text"},{"text":"\n","type":"text"},{"identifier":"WWDC20-10077-hitch_measurement_tools","type":"image"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"XCTest Metrics is used to measure hitches in development environment, while MetricKit and Xcode Organizer can show you measures from the customers devices directly","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"XCTest Metrics has many tests you can use to measure different parts of your application, the one we’re concerned with here is ","type":"text"},{"code":"XCTOSSignPostMetric","type":"codeVoice"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"codeVoice","code":"XCTOSSignPostMetric"},{"type":"text","text":" used to measure animation duration in previous versions of Xcode, new in Xcode 12, this metric will provide 5 additional information:"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Total count of hitches"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Total duration of hitches"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Hitch time ratio"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Frame rate"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Frame count"}]}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"To collect these metrics, you should write a test case that collects "},{"type":"codeVoice","code":"os_signpost"},{"type":"text","text":" intervals with the new"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"In Xcode 11, this produced a non-animation "},{"type":"codeVoice","code":"os_signpost"},{"type":"text","text":" intervals:"}],"type":"paragraph"}]}],"type":"unorderedList"},{"syntax":"swift","type":"codeListing","code":["os_signpost(.begin, log: logHandle, name: \"performInterval\")","os_signpost(.end, log: logHandle, name: \"performInterval\")"]},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Now in Xcode 12, you can use the "},{"type":"codeVoice","code":".animationBegin"},{"type":"text","text":" instead to specify the extra metrics related to animation:"}],"type":"paragraph"}]}],"type":"unorderedList"},{"syntax":"swift","type":"codeListing","code":["os_signpost(.animationBegin, log: logHandle, name: \"performAnimationInterval\")","os_signpost(.end, log: logHandle, name: \"performAnimationInterval\")"]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"You can also use one of the predefined "},{"code":"UIKit","type":"codeVoice"},{"type":"text","text":" instrumented intervals for testing around navigation transitions and scrolling, these are sub-metrics provided on the XCTOSSignpostMetric class."}]}]}],"type":"unorderedList"},{"syntax":"swift","type":"codeListing","code":["extension XCTOSSignpostMetric {","\t open class var navigationTransitionMetric: XCTMetric { get }","\t open class var customNavigationTransitionMetric: XCTMetric { get }","\t open class var scrollDecelerationMetric: XCTMetric { get }","\t open class var scrollDraggingMetric: XCTMetric { get }","}"]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Here is a sample test case that launches the app, taps on "},{"inlineContent":[{"type":"text","text":"”Meal Planner”"}],"type":"emphasis"},{"type":"text","text":" and measures the scrolling animation in a "},{"type":"codeVoice","code":".fast"},{"type":"text","text":" velocity:"}]}]}],"type":"unorderedList"},{"syntax":"swift","type":"codeListing","code":["\/\/ Measure scrolling animation performance using a Performance XCTest","func testScrollingAnimationPerformance() throws {","\tapp.launch()","\tapp.staticTexts[\"Meal Planner\"].tap()","\tlet foodCollection = app.collectionViews.firstMatch","","\tmeasure(metrics: [XCTOSSignpostMetric.scrollDecelerationMetric]) {","\tfoodCollection.swipeUp(velocity: .fast)","\t}","}"]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"To avoid swiping between different content in the 5 iterations of the measure block, we can reset the application state during measurements:"}]}]}],"type":"unorderedList"},{"syntax":"swift","type":"codeListing","code":["func testScrollingAnimationPerformance() throws { ","\tapp.launch()","\tapp.staticTexts[\"Meal Planner\"].tap()","\tlet foodCollection = app.collectionViews.firstMatch","","\tlet measureOptions = XCTMeasureOptions()","\tmeasureOptions.invocationOptions = [.manuallyStop]","","\tmeasure(metrics: [XCTOSSignpostMetric.scrollDecelerationMetric],","\t\toptions: measureOptions) {","\tfoodCollection.swipeUp(velocity: .fast)","\tstopMeasuring()","\tfoodCollection.swipeDown(velocity: .fast)","\t}","}"]},{"text":"Tips for creating performance tests:","type":"heading","level":4,"anchor":"Tips-for-creating-performance-tests"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Create a separate test scheme for your Performance XCTest"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Use "},{"code":"Release","type":"codeVoice"},{"type":"text","text":"  Build Configuration and uncheck Debug executable"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Switch off Automatic Screenshots and Code Coverage"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Turn off all diagnostic options, checkers, sanitizers and memory management","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Written By","type":"heading","level":2,"anchor":"Written-By"},{"columns":[{"content":[{"type":"paragraph","inlineContent":[{"identifier":"ATahhan","type":"image"}]}],"size":1},{"content":[{"type":"heading","anchor":"Ammar-AlTahhan","level":3,"text":"Ammar AlTahhan"},{"type":"paragraph","inlineContent":[{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/ATahhan","type":"reference","overridingTitle":"Contributed Notes","overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"isActive":true},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/github.com\/ATahhan","type":"reference","isActive":true},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/","type":"reference","isActive":true}]}],"size":4}],"type":"row","numberOfColumns":5},{"type":"thematicBreak"},{"type":"paragraph","inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","isActive":true}]},{"text":"Related Sessions","type":"heading","level":2,"anchor":"Related-Sessions"},{"items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10181-Ultimate-application-performance-survival-guide","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10057-Identify-trends-with-the-Power-and-Performance-API","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10076-Diagnose-performance-issues-with-the-Xcode-Organizer","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10081-Whats-new-in-MetricKit","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10164-XCTSkip-your-tests","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10220-Handle-interruptions-and-alerts-in-UI-tests","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10687-Triage-test-failures-with-XCTIssue"],"type":"links","style":"list"},{"type":"small","inlineContent":[{"type":"strong","inlineContent":[{"text":"Legal Notice","type":"text"}]}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}],"kind":"content"}],"references":{"doc://WWDCNotes/documentation/WWDCNotes":{"type":"topic","role":"collection","abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"images":[{"identifier":"WWDCNotes.png","type":"icon"}],"url":"\/documentation\/wwdcnotes","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","title":"WWDC Notes","kind":"symbol"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10687-Triage-test-failures-with-XCTIssue":{"role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10687-Triage-test-failures-with-XCTIssue","abstract":[{"type":"text","text":"Put your test failures to work: Learn how to triage and diagnose uncaught issues in your app using the latest testing APIs in Xcode. We’ll show you how to help ease your testing workflow and put failures into context to help you deliver the best quality product."}],"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc20-10687-triage-test-failures-with-xctissue","type":"topic","title":"Triage test failures with XCTIssue"},"WWDC20-10077-hitch_ratio_targets":{"type":"image","identifier":"WWDC20-10077-hitch_ratio_targets","alt":null,"variants":[{"url":"\/images\/WWDCNotes\/WWDC20-10077-hitch_ratio_targets.png","traits":["1x","light"]}]},"WWDC20.jpeg":{"identifier":"WWDC20.jpeg","type":"image","alt":null,"variants":[{"url":"\/images\/WWDCNotes\/WWDC20.jpeg","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10181-Ultimate-application-performance-survival-guide":{"abstract":[{"type":"text","text":"Performance optimization can seem like a daunting task — with many metrics to track and tools to use. Fear not: Our survival guide to app performance is here to help you understand tooling, metrics, and paradigms that can help smooth your development process and contribute to a great experience for people using your app."}],"kind":"article","type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10181-Ultimate-application-performance-survival-guide","title":"Ultimate application performance survival guide","url":"\/documentation\/wwdcnotes\/wwdc21-10181-ultimate-application-performance-survival-guide"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10081-Whats-new-in-MetricKit":{"title":"What’s new in MetricKit","type":"topic","role":"sampleCode","abstract":[{"type":"text","text":"Quickly detect power and performance regressions and troubleshoot app issues when you adopt MetricKit. Discover the latest trackable metrics for your app, including CPU instructions, animation hitches, and exit reasons. And learn about diagnostics in MetricKit that can help you troubleshoot hangs, crashes, and disk writes."}],"url":"\/documentation\/wwdcnotes\/wwdc20-10081-whats-new-in-metrickit","kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10081-Whats-new-in-MetricKit"},"WWDCNotes.png":{"alt":null,"type":"image","variants":[{"url":"\/images\/WWDCNotes\/WWDCNotes.png","traits":["1x","light"]}],"identifier":"WWDCNotes.png"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10164-XCTSkip-your-tests":{"abstract":[{"text":"Get the test results that matter — and skip the ones that don’t. Discover how you can implement XCTSkip to conditionally avoid tests at runtime. We’ll take you through how to return this new test result and better document tests beyond pass and fail within your test bundle.","type":"text"}],"type":"topic","title":"XCTSkip your tests","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10164-XCTSkip-your-tests","url":"\/documentation\/wwdcnotes\/wwdc20-10164-xctskip-your-tests","kind":"article","role":"sampleCode"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10220-Handle-interruptions-and-alerts-in-UI-tests":{"title":"Handle interruptions and alerts in UI tests","role":"sampleCode","abstract":[{"text":"Learn how to anticipate potential interruptions to your app’s interface and build smart tests to identify them. UI interruptions often appear indeterminately, typically during onboarding or first launch, which can make them hard to track down. Learn how to understand interruptions, write stronger tests with UI interruption handlers, and manage expected alerts.","type":"text"}],"kind":"article","type":"topic","url":"\/documentation\/wwdcnotes\/wwdc20-10220-handle-interruptions-and-alerts-in-ui-tests","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10220-Handle-interruptions-and-alerts-in-UI-tests"},"ATahhan":{"type":"image","identifier":"ATahhan","alt":"Profile image of Ammar AlTahhan","variants":[{"url":"\/images\/WWDCNotes\/ATahhan.jpeg","traits":["1x","light"]}]},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"link","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","title":"Contributions are welcome!","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10076-Diagnose-performance-issues-with-the-Xcode-Organizer":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10076-Diagnose-performance-issues-with-the-Xcode-Organizer","url":"\/documentation\/wwdcnotes\/wwdc20-10076-diagnose-performance-issues-with-the-xcode-organizer","type":"topic","abstract":[{"text":"Analyze aggregated power and performance data from multiple versions of your app with just a few clicks. We’ll introduce you to the latest version of the Xcode Organizer and its interactive interface, where you can easily compare and contrast app metrics across releases. Explore disk write diagnostics and scroll hitch metrics, and learn how you can use these to offer better performance, reduce battery consumption, and improve device health for people using your app.","type":"text"}],"role":"sampleCode","kind":"article","title":"Diagnose performance issues with the Xcode Organizer"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20":{"type":"topic","role":"collectionGroup","abstract":[{"type":"text","text":"Xcode 12, Swift 5.3, iOS 14, macOS 11 (Big Sur), tvOS 14, watchOS 7."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"WidgetKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit Testing"},{"type":"text","text":", and more."}],"images":[{"type":"icon","identifier":"WWDC20-Icon.png"},{"type":"card","identifier":"WWDC20.jpeg"}],"url":"\/documentation\/wwdcnotes\/wwdc20","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20","title":"WWDC20","kind":"article"},"WWDC20-10077-hitch_measurement_tools":{"alt":null,"type":"image","variants":[{"url":"\/images\/WWDCNotes\/WWDC20-10077-hitch_measurement_tools.png","traits":["1x","light"]}],"identifier":"WWDC20-10077-hitch_measurement_tools"},"ATahhan.jpeg":{"type":"image","identifier":"ATahhan.jpeg","alt":null,"variants":[{"url":"\/images\/WWDCNotes\/ATahhan.jpeg","traits":["1x","light"]}]},"https://github.com/ATahhan":{"identifier":"https:\/\/github.com\/ATahhan","type":"link","url":"https:\/\/github.com\/ATahhan","title":"GitHub","titleInlineContent":[{"text":"GitHub","type":"text"}]},"WWDC20-10077-frame_delay":{"alt":null,"type":"image","variants":[{"url":"\/images\/WWDCNotes\/WWDC20-10077-frame_delay.png","traits":["1x","light"]}],"identifier":"WWDC20-10077-frame_delay"},"doc://WWDCNotes/documentation/WWDCNotes/ATahhan":{"role":"sampleCode","images":[{"identifier":"ATahhan.jpeg","type":"card"},{"identifier":"ATahhan.jpeg","type":"icon"}],"url":"\/documentation\/wwdcnotes\/atahhan","title":"Ammar AlTahhan (12 notes)","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/ATahhan","kind":"article","abstract":[{"text":"Software Engineer","type":"text"}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10057-Identify-trends-with-the-Power-and-Performance-API":{"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc20-10057-identify-trends-with-the-power-and-performance-api","abstract":[{"type":"text","text":"Track your app’s performance metrics in custom team dashboards, bug reporting systems, and other custom workflows with the Power and Performance Metrics and Diagnostics API. Explore how you can access the same data that drives the Power and Performance analysis tools in Xcode to quickly identify trends and regressions. Learn how to leverage diagnostic signatures and logs — including call stack trees — to prioritize and debug issues. And discover how you can integrate this API with your development team’s existing tools to troubleshoot issues quickly, offering better overall performance for people who use your app."}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10057-Identify-trends-with-the-Power-and-Performance-API","role":"sampleCode","title":"Identify trends with the Power and Performance API","type":"topic"},"WWDC20-Icon.png":{"type":"image","identifier":"WWDC20-Icon.png","alt":null,"variants":[{"url":"\/images\/WWDCNotes\/WWDC20-Icon.png","traits":["1x","light"]}]},"https://":{"identifier":"https:\/\/","type":"link","url":"https:\/\/","title":"Blog","titleInlineContent":[{"text":"Blog","type":"text"}]},"https://developer.apple.com/wwdc20/10077":{"url":"https:\/\/developer.apple.com\/wwdc20\/10077","type":"download","checksum":null,"identifier":"https:\/\/developer.apple.com\/wwdc20\/10077"}}}