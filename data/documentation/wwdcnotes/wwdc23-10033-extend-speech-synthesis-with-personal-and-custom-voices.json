{"metadata":{"title":"Extend Speech Synthesis with personal and custom voices","roleHeading":"WWDC23","modules":[{"name":"WWDC Notes"}],"role":"sampleCode"},"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10033-Extend-Speech-Synthesis-with-personal-and-custom-voices"},"kind":"article","abstract":[{"type":"text","text":"Bring the latest advancements in Speech Synthesis to your apps. Learn how you can integrate your custom speech synthesizer and voices into iOS and macOS. We’ll show you how SSML is used to generate expressive speech synthesis, and explore how Personal Voice can enable your augmentative and assistive communication app to speak on a person’s behalf in an authentic way."}],"sections":[],"sampleCodeDownload":{"action":{"isActive":true,"identifier":"https:\/\/developer.apple.com\/wwdc23\/10033","type":"reference","overridingTitle":"Watch Video (12 min)"},"kind":"sampleDownload"},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23"]]},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc23-10033-extend-speech-synthesis-with-personal-and-custom-voices"]}],"primaryContentSections":[{"kind":"content","content":[{"anchor":"overview","level":2,"text":"Overview","type":"heading"},{"inlineContent":[{"type":"text","text":"Speaker: Grant Maloney, Accessibility Engineer"}],"type":"paragraph"},{"anchor":"Explore-Speech-Synthesis-Markup-Language-SSML","level":2,"text":"Explore Speech Synthesis Markup Language (SSML)","type":"heading"},{"inlineContent":[{"type":"text","text":"What is SSML?"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"A W3C standard for speech","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Declarative XML document"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Supported on all Platforms"}],"type":"paragraph"}]}],"type":"unorderedList"},{"syntax":"swift","code":["let ssml = \"\"\"","    <speak>","        Hello","        <break time=\"1s\" \/>","        <prosody rate=\"200%\">nice to meet you!<\/prosody>","    <\/speak>","\"\"\"","","guard let ssmlUtterance = AVSpeechUtterance(ssmlRepresentation: ssml) else {","    return","}","","self.synthesizer.speak(ssmlUtterance)"],"type":"codeListing"},{"anchor":"Implement-a-synthesis-provider","level":2,"text":"Implement a synthesis provider","type":"heading"},{"anchor":"What-is-a-speech-synthesizer-and-how-does-it-work","level":3,"text":"What is a speech synthesizer and how does it work?","type":"heading"},{"style":"note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"A speech synthesizer receives some text and information about desired speech properties in the form of SSML and provides an audio representation of that text."}]}],"name":"Note","type":"aside"},{"type":"aside","name":"Note","content":[{"inlineContent":[{"type":"text","text":"Speech Synthesis provider audio unit extensions will be embedded in a host app and will receive speech requests in the form of SSML. The extension will be responsible for rendering audio for the SSML input and optionally returning markers indicating where words occur within those audio buffers. The system will then manage all playback for that speech request. You don’t need to handle any audio session management; it’s managed internally by the Speech Synthesis Provider framework."}],"type":"paragraph"}],"style":"note"},{"type":"heading","text":"Creating a new voice","level":3,"anchor":"Creating-a-new-voice"},{"inlineContent":[{"type":"text","text":"Create a new Audio Unit Extension app project in Xcode, then select the “Speech Synthesizer” Audio Unit Type and provide a four character subtype identifier for your synthesizer, as well as a four character identifier for you as a manufacturer."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"Use an App Group to communicate between the extension and the host app."}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["public class WWDCSynthAudioUnit: AVSpeechSynthesisProviderAudioUnit {","    public override var speechVoices: [AVSpeechSynthesisProviderVoice] {","        get {","            let voices: [String : String] = groupDefaults.value(forKey: \"voices\") as? [String : String] ?? [:]","            return voices.map { key, value in","                return AVSpeechSynthesisProviderVoice(name: value,","                                                identifier: key,","                                          primaryLanguages: [\"en-US\"],","                                        supportedLanguages: [\"en-US\"] )","            }","        }","    }","}"]},{"type":"heading","text":"The synthesis provider","level":4,"anchor":"The-synthesis-provider"},{"inlineContent":[{"type":"text","text":"When some text should be synthesized this function will be called with the SSML."}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["public class WWDCSynthAudioUnit: AVSpeechSynthesisProviderAudioUnit {","    public override func synthesizeSpeechRequest(speechRequest: AVSpeechSynthesisProviderRequest) {","        currentBuffer = getAudioBuffer(for: speechRequest.voice, with: speechRequest.ssmlRepresentation)","        framePosition = 0","    }","","    public override func cancelSpeechRequest() {","        currentBuffer = nil","    }","}"]},{"type":"heading","text":"The render block","level":3,"anchor":"The-render-block"},{"syntax":"swift","type":"codeListing","code":["public class WWDCSynthAudioUnit: AVSpeechSynthesisProviderAudioUnit {","    public override var internalRenderBlock: AUInternalRenderBlock {","       return { [weak self]","           actionFlags, timestamp, frameCount, outputBusNumber, outputAudioBufferList, _, _ in","           guard let self else { return kAudio_ParamError }","","           \/\/ This is the audio buffer we are going to fill up","           var unsafeBuffer = UnsafeMutableAudioBufferListPointer(outputAudioBufferList)[0]","           let frames = unsafeBuffer.mData!.assumingMemoryBound(to: Float32.self)","                ","           var sourceBuffer = UnsafeMutableAudioBufferListPointer(self.currentBuffer!.mutableAudioBufferList)[0]","           let sourceFrames = sourceBuffer.mData!.assumingMemoryBound(to: Float32.self)","","           for frame in 0..<frameCount {","               if frames.count > frame && sourceFrames.count > self.framePosition {","                   frames[Int(frame)] = sourceFrames[Int(self.framePosition)]","                   self.framePosition += 1","                   if self.framePosition >= self.currentBuffer!.frameLength {","                       break","                   }","               }","           }","                ","           return noErr","       }","    }","}"]},{"type":"heading","text":"Sample app for purchasing voices","level":3,"anchor":"Sample-app-for-purchasing-voices"},{"inlineContent":[{"type":"text","text":"Take note of the "},{"type":"codeVoice","code":"AVSpeechSynthesisProviderVoice"},{"type":"text","text":" function "},{"type":"codeVoice","code":"updateSpeechVoices()"},{"type":"text","text":". That is how your app can signal that the set of available voices for your synthesizer has changed and the system voice list should be rebuilt."}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["struct ContentView: View {","    ","    @State var purchasedVoices: [WWDCVoice] = []","    ","    var body: some View {","        List {","            MyAwesomeVoicesSection","            PurchasedVoicesSection","        }","    }","    ","    func purchase(voice: WWDCVoice) {","        \/\/ Append voice to list of purchased voices","        purchasedVoices.append(voice)","        ","        \/\/ Inform system of change in voices","        AVSpeechSynthesisProviderVoice.updateSpeechVoices()","    }","}"]},{"type":"heading","text":"Listen for changes in available system voices","level":3,"anchor":"Listen-for-changes-in-available-system-voices"},{"syntax":"swift","type":"codeListing","code":["struct ContentView: View {","    @State var systemVoices: [AVSpeechSynthesisVoice] = AVSpeechSynthesisVoice.speechVoices()","    ","    var body: some View {","        List {","            MyAwesomeVoicesSection","            PurchasedVoicesSection","            Section(\"System Voices\") {","                ForEach(systemVoices.filter { $0.language == \"en-US\" }) { voice in","                    Text(voice.name)","                }","            }","        }","        .onReceive(NotificationCenter.default","            .publisher(for: AVSpeechSynthesizer.availableVoicesDidChangeNotification)) { _ in","                systemVoices = AVSpeechSynthesisVoice.speechVoices()","        }","    }","}"]},{"type":"heading","text":"Use Personal Voice","level":2,"anchor":"Use-Personal-Voice"},{"type":"aside","name":"Note","content":[{"inlineContent":[{"type":"text","text":"People can now record and recreate their voice on iOS and macOS using the power of their device."}],"type":"paragraph"}],"style":"note"},{"type":"aside","name":"Note","content":[{"inlineContent":[{"type":"text","text":"Your Personal Voice is generated on the device and not on a server. This voice will appear amongst the rest of the System voices and can be used with a new feature called Live Speech. Live Speech is a type-to-speak feature on iOS, iPadOS, macOS, and watchOS that lets a person synthesize speech with their own voice on the fly."}],"type":"paragraph"}],"style":"note"},{"type":"aside","name":"Note","content":[{"inlineContent":[{"text":"You can request access to synthesize speech with these voices using a new request authorization API for Personal Voice. Keep in mind that usage of Personal Voice is sensitive and should be primarily used for augmentative or alternative communication apps.","type":"text"}],"type":"paragraph"}],"style":"note"},{"syntax":"swift","type":"codeListing","code":["struct ContentView: View {","    @State private var personalVoices: [AVSpeechSynthesisVoice] = []","","    func fetchPersonalVoices() async {","        AVSpeechSynthesizer.requestPersonalVoiceAuthorization() { status in","            if status == .authorized {","                personalVoices = AVSpeechSynthesisVoice.speechVoices().filter { $0.voiceTraits.contains(.isPersonalVoice) }","            }","        }","    }","}"]},{"inlineContent":[{"text":"When authorized you can use the Personal Voice:","type":"text"}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["func speakUtterance(string: String) {","    let utterance = AVSpeechUtterance(string: string)","    if let voice = personalVoices.first {","        utterance.voice = voice","        syntheizer.speak(utterance)","    }","}"]},{"type":"heading","text":"Written By","level":2,"anchor":"Written-By"},{"columns":[{"content":[{"type":"paragraph","inlineContent":[{"identifier":"MortenGregersen","type":"image"}]}],"size":1},{"content":[{"type":"heading","level":3,"text":"Morten Bjerg Gregersen","anchor":"Morten-Bjerg-Gregersen"},{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","overridingTitle":"Contributed Notes","overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/MortenGregersen"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/MortenGregersen"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"https:\/\/x.com\/mortengregersen"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"http:\/\/atterdagapps.com"}]}],"size":4}],"type":"row","numberOfColumns":5},{"inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","isActive":true}],"type":"paragraph"},{"type":"heading","text":"Related Sessions","level":2,"anchor":"Related-Sessions"},{"type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10022-Create-a-seamless-speech-experience-in-your-apps"],"style":"list"},{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Legal Notice","type":"text"}]}],"type":"small"},{"inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}],"type":"small"}]}],"schemaVersion":{"major":0,"minor":3,"patch":0},"references":{"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10022-Create-a-seamless-speech-experience-in-your-apps":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10022-Create-a-seamless-speech-experience-in-your-apps","url":"\/documentation\/wwdcnotes\/wwdc20-10022-create-a-seamless-speech-experience-in-your-apps","role":"sampleCode","type":"topic","title":"Create a seamless speech experience in your apps","kind":"article","abstract":[{"type":"text","text":"Augment your app’s accessibility experience with speech synthesis: Discover the best times and places to add speech APIs so that everyone who uses your app can benefit. Learn how to use AVSpeechSynthesizer to complement assistive technologies like VoiceOver, and when to implement alternative APIs. And we’ll show you how to route audio to the appropriate source and create apps that integrate speech seamlessly for all who need or want it."}]},"http://atterdagapps.com":{"title":"Blog","identifier":"http:\/\/atterdagapps.com","titleInlineContent":[{"type":"text","text":"Blog"}],"url":"http:\/\/atterdagapps.com","type":"link"},"https://github.com/MortenGregersen":{"title":"GitHub","identifier":"https:\/\/github.com\/MortenGregersen","titleInlineContent":[{"type":"text","text":"GitHub"}],"url":"https:\/\/github.com\/MortenGregersen","type":"link"},"doc://WWDCNotes/documentation/WWDCNotes":{"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","kind":"symbol","url":"\/documentation\/wwdcnotes","abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"title":"WWDC Notes","images":[{"type":"icon","identifier":"WWDCNotes.png"}],"role":"collection"},"WWDCNotes.png":{"alt":null,"identifier":"WWDCNotes.png","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes.png"}],"type":"image"},"MortenGregersen":{"alt":"Profile image of Morten Bjerg Gregersen","identifier":"MortenGregersen","variants":[{"traits":["1x","light"],"url":"\/images\/MortenGregersen.jpeg"}],"type":"image"},"https://developer.apple.com/wwdc23/10033":{"identifier":"https:\/\/developer.apple.com\/wwdc23\/10033","checksum":null,"url":"https:\/\/developer.apple.com\/wwdc23\/10033","type":"download"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"title":"Contributions are welcome!","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"link"},"https://x.com/mortengregersen":{"title":"X\/Twitter","identifier":"https:\/\/x.com\/mortengregersen","titleInlineContent":[{"type":"text","text":"X\/Twitter"}],"url":"https:\/\/x.com\/mortengregersen","type":"link"},"MortenGregersen.jpeg":{"alt":null,"identifier":"MortenGregersen.jpeg","variants":[{"traits":["1x","light"],"url":"\/images\/MortenGregersen.jpeg"}],"type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/MortenGregersen":{"images":[{"identifier":"MortenGregersen.jpeg","type":"card"},{"identifier":"MortenGregersen.jpeg","type":"icon"}],"title":"Morten Bjerg Gregersen (21 notes)","kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/MortenGregersen","type":"topic","role":"sampleCode","url":"\/documentation\/wwdcnotes\/mortengregersen","abstract":[{"text":"Hi 👋 I am Morten - I live in Denmark 🇩🇰","type":"text"}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23","role":"collectionGroup","title":"WWDC23","abstract":[{"text":"Xcode 15, Swift 5.9, iOS 17, macOS 14 (Sonoma), tvOS 17, visionOS 1, watchOS 10.","type":"text"},{"text":" ","type":"text"},{"text":"New APIs: ","type":"text"},{"type":"codeVoice","code":"SwiftData"},{"text":", ","type":"text"},{"type":"codeVoice","code":"Observation"},{"text":", ","type":"text"},{"type":"codeVoice","code":"StoreKit"},{"text":" views, and more.","type":"text"}],"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc23","images":[{"identifier":"WWDC23-Icon.png","type":"icon"},{"identifier":"WWDC23.jpeg","type":"card"}],"type":"topic"},"WWDC23-Icon.png":{"alt":null,"identifier":"WWDC23-Icon.png","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23-Icon.png"}],"type":"image"},"WWDC23.jpeg":{"alt":null,"identifier":"WWDC23.jpeg","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23.jpeg"}],"type":"image"}}}