{"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10003-There-and-back-again-Data-transfer-on-Apple-Watch"},"metadata":{"roleHeading":"WWDC21","role":"sampleCode","modules":[{"name":"WWDC Notes"}],"title":"There and back again: Data transfer on Apple Watch"},"sampleCodeDownload":{"action":{"type":"reference","overridingTitle":"Watch Video (31 min)","isActive":true,"identifier":"https:\/\/developer.apple.com\/wwdc21\/10003"},"kind":"sampleDownload"},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"sections":[],"schemaVersion":{"patch":0,"major":0,"minor":3},"kind":"article","abstract":[{"type":"text","text":"Advances in Apple Watch give you more ways to communicate to and from your app, and new audiences to consider. Learn what strategies are available for data communication and how to choose the right tool for the job. Compare and contrast the benefits of using technologies such as iCloud Keychain, Watch Connectivity, Core Data, and more."}],"primaryContentSections":[{"content":[{"text":"Data communication tools","level":2,"anchor":"Data-communication-tools","type":"heading"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"iCloud"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"allows us to share data with all our devices"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"gives us server storage"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Keychain with iCloud Synchronization"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"CoreData with CloudKit","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"}]},{"content":[{"inlineContent":[{"type":"text","text":"Watch Connectivity"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"allows to transfer data between paired devices"}]}]}],"type":"unorderedList"}]},{"content":[{"inlineContent":[{"code":"URLSession","type":"codeVoice"},{"text":" and\/or sockets","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"to communicate directly with servers"}]}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"text":"How to choose among the communication options","level":3,"anchor":"How-to-choose-among-the-communication-options","type":"heading"},{"inlineContent":[{"text":"Ask yourself:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Type of data - What kind of data is it?"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Data source and destination - Where is the data now, and where it needs to be?"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Reliance on companion iOS app - Is the interaction reliant on a companion iOS app?"}]}]},{"content":[{"inlineContent":[{"text":"Support Family Setup - Do I want to support Family Setup?","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Timing - when does the data need to be at its destination? Can it wait to let the system optimize performance and battery usage for my customer? How frequently is the data going to change?","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Keychain with iCloud Synchronization (WatchOS 6.2+)","level":3,"anchor":"Keychain-with-iCloud-Synchronization-WatchOS-62+","type":"heading"},{"items":[{"content":[{"inlineContent":[{"text":"Keychain provides secure storage for passwords, keys, and other sensitive credentials","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Keychain can also store other small bits of shared data, such as a user preference, as long as the information isn‚Äôt changing frequently","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Keychain items can be synchronized to all of a person‚Äôs devices"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"The items are synchronized when possible based on network availability, battery, and other system conditions"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"‚ö†Ô∏è customers can disable iCloud Keychain synchronization","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"‚ö†Ô∏è Keychain + iClous is not available in all regions","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"There are two ways you can benefit from iCloud Synchronization in your app, by using:"}]},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Password autofill (with Associated Domains)","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Shared Keychain items","type":"text"}]}]}]}]}],"type":"unorderedList"},{"text":"How to enable Password autofill","level":4,"anchor":"How-to-enable-Password-autofill","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Add the Associated Domains capability to your target","type":"text"}]}]}],"type":"orderedList"},{"inlineContent":[{"identifier":"WWDC21-10003-ps1","type":"image"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"For your Watch app, add the capability to the WatchKit Extension Target"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Add a ","type":"text"},{"code":"webcredentials","type":"codeVoice"},{"text":" entry with your domain name (the ","type":"text"},{"text":"apple-app-site-association","type":"text"},{"text":" file to your web server):","type":"text"}],"type":"paragraph"}]}],"type":"orderedList","start":2},{"code":["{","  \"webcredentials\": {","    \"apps\": [","      \"A123456789.com.example.MyiOSApp\",","      \"A123456789.com.example.MyWatchApp.watchkitapp.watchkitextension\"","    ]","  }","}"],"type":"codeListing","syntax":"xml"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Add "},{"isActive":true,"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/swiftui\/geometryreader\/textcontenttype(_:)-ki0h"},{"type":"text","text":" to your TextFields:"}]}]}],"type":"orderedList","start":4},{"code":["struct LoginView: View {","  @State private var username = \"\"","  @State private var password = \"\"","  ","  var body: some View {","    Form {","      TextField(\"User:\", text: $username)","        .textContentType(.username) \/\/ üëàüèª","      ","      SecureField(\"Password\", text: $password) ","        .textContentType(.password) \/\/ üëàüèª","      ...","    }","  }","}"],"type":"codeListing","syntax":"swift"},{"text":"How to share Keychain items among apps","level":4,"anchor":"How-to-share-Keychain-items-among-apps","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Add Keychain Sharing App Groups Capability to Targets (in all the apps where we want to share these Keychain items):","type":"text"}]}]}],"type":"orderedList"},{"inlineContent":[{"identifier":"WWDC21-10003-ks1","type":"image"}],"type":"paragraph"},{"inlineContent":[{"text":"This is required to share the items, and helps ensure the security and privacy of your customers‚Äô information by preventing access by other apps.","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"For your Watch app, add the capability to your Watch Extension target","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Add apps to common Keychain Group or App Group - all apps that are going to share the Keychain items need to also share this group"}],"type":"paragraph"}]}],"type":"orderedList","start":2},{"inlineContent":[{"type":"text","text":"Example on how to add\/update a Keychain item:"}],"type":"paragraph"},{"code":["func storeToken(_ token: OAuth2Token, for server: String, account: String) throws {","  let query: [String: Any] = [","    kSecClass as String: kSecClassInternetPassword,","    kSecAttrServer as String: server,","    kSecAttrAccount as String: account,","    \/\/                                 üëáüèª this indicates that we want to sync this item in all user devices","    kSecAttrSynchronizable as String: true,","  ]","  ","  let tokenData = try encodeToken(token)","  let attributes: [String: Any] = [kSecValueData as String: tokenData]","  ","  \/\/                üëáüèª update the item if it exists in the keychain","  let status = SecItemUpdate(query as CFDictionary, attributes as CFDictionary)","  ","  guard status != errSecItemNotFound else {","    ","    \/\/     üëáüèª add the item if it doesn't exist in the keychain yet","    try addTokenData(tokenData, for: server, account: account)","    return","  }","  ","  guard status == errSecSuccess else {","    throw OAuthKeychainError.updateError(status)","  }","}","","func addTokenData(_ tokenData: Data, for server: String, account: String) throws {","  let attributes: [String: Any] = [","    kSecClass as String: kSecClassInternetPassword,","    kSecAttrServer as String: server,","    kSecAttrAccount as String: account,","    kSecAttrSynchronizable as String: true,","    kSecValueData as String: tokenData,","  ]","  ","  let status = SecItemAdd(attributes as CFDictionary, nil)","  ","  guard status == errSecSuccess else {","    throw OAuthKeychainError.addError(status)","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"Example on how to retrieve a Keychain item:"}],"type":"paragraph"},{"code":["func retrieveToken(for server: String, account: String) throws -> OAuth2Token? {","  let query: [String: Any] = [","    kSecClass as String: kSecClassInternetPassword,","    kSecAttrServer as String: server,","    kSecAttrAccount as String: account,","    kSecAttrSynchronizable as String: true,","    \/\/ üëáüèª tells whether we want the item attributes returned","    kSecReturnAttributes as String: false,","    \/\/ üëáüèª tells whether we want the item data returned","    kSecReturnData as String: true,","  ]","      ","  var item: CFTypeRef?","  let status = SecItemCopyMatching(query as CFDictionary, &item)","      ","  guard status != errSecItemNotFound else {","    \/\/ No token stored for this server account combination.","    return nil","  }","  ","  guard status == errSecSuccess else {","    throw OAuthKeychainError.retrievalError(status)","  }","  ","  guard let existingItem = item as? [String: Any] else {","    throw OAuthKeychainError.invalidKeychainItemFormat","  }","  ","  guard let tokenData = existingItem[kSecValueData as String] as? Data else {","    throw OAuthKeychainError.missingTokenDataFromKeychainItem","  }","  ","  do {","    return try JSONDecoder().decode(OAuth2Token.self, from: tokenData)","  } catch {","    throw OAuthKeychainError.tokenDecodingError(error.localizedDescription)","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"Example on how to delete a Keychain item:","type":"text"}],"type":"paragraph"},{"code":["func removeToken(for server: String, account: String) throws {","  let query: [String: Any] = [","    kSecClass as String: kSecClassInternetPassword,","    kSecAttrServer as String: server,","    kSecAttrAccount as String: account,","    kSecAttrSynchronizable as String: true,","  ]","","  let status = SecItemDelete(query as CFDictionary)","  ","  guard status == errSecSuccess || status == errSecItemNotFound else {","    throw OAuthKeychainError.deleteError(status)","  }","}"],"type":"codeListing","syntax":"swift"},{"text":"CoreData with CloudKit","level":3,"anchor":"CoreData-with-CloudKit","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"synchronizes your local database to all of your customer‚Äôs other devices that share your app‚Äôs CloudKit container"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"CoreData integration with SwiftUI simplifies accessing and displaying data from your database in your Watch application."}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Synchronization of Core Data changes happens based on network availability and system conditions. Don‚Äôt expect it to be instantaneous, but CloudKit will handle optimizing performance of this synchronization for your app"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Watch Connectivity","level":3,"anchor":"Watch-Connectivity","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"allows you to send data between your Watch app and its companion iPhone app when both devices are within Bluetooth range or on the same Wi-Fi network","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"best for:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"optimizing your customer‚Äôs experience when they have both your phone and Watch apps installed","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"sharing data only available on either Watch or iPhone","type":"text"}]}]}]}]}],"type":"unorderedList"},{"text":"Tips","level":4,"anchor":"Tips","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Activate ","type":"text"},{"code":"WCSession","type":"codeVoice"},{"text":" as early as possible in your app life-cycle - this makes your app available to receive information from its counterpart app as soon as possible","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Understand reachability - None of the background communication requires your counterpart app to be reachable when you send data. But interactive messaging does have reachability requirements"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"All ","type":"text"},{"code":"WCSession","type":"codeVoice"},{"text":" delegate functions are called on a non-main serial queue","type":"text"}]}]}],"type":"unorderedList"},{"text":"Watch Connectivity features","level":4,"anchor":"Watch-Connectivity-features","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Application Context"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"the application context is a single property list dictionary"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"sent to the counterpart app in the background, with the goal of being available when the app wakes up","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"if you update the application context before the previous dictionary is sent (via "},{"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615621-updateapplicationcontext","isActive":true},{"type":"text","text":", it is replaced by the new value"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"useful for keeping content up to date on the counterpart app when you have new data"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"data that may update frequently","type":"text"}],"type":"paragraph"}]}]}]},{"content":[{"inlineContent":[{"text":"User Info transfer","type":"text"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"similar to application context","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"the user info is a single property list dictionary"}]}]},{"content":[{"inlineContent":[{"text":"sent sequentially in the background - instead of being a single dictionary that is replaced each time you update it, each user info dictionary transfer is queued and delivered in the order that you enqueued it","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"we can access the queue (via ","type":"text"},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615627-outstandinguserinfotransfers","type":"reference"},{"text":") and cancel an update","type":"text"}],"type":"paragraph"}]}]}]},{"content":[{"inlineContent":[{"text":"File transfer","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"similar to User Info, but for files"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"delivered in background (similar to the features above)"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"can access the queue (via ","type":"text"},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615641-outstandingfiletransfers","type":"reference"},{"text":") and cancel transfers","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"received files are stored in the Inbox\/Documents directory"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"received files are deleted once "},{"code":"WCSessionDelegate","type":"codeVoice"},{"type":"text","text":"‚Äôs "},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615651-session","type":"reference"},{"type":"text","text":" is called - make sure to move\/process the file before returning from this method"}],"type":"paragraph"}]}],"type":"unorderedList"}]},{"content":[{"inlineContent":[{"type":"text","text":"Transfer current complication user info"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"Send Complication-related data to Watch","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Update up to 50 times\/day with an active Complication"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Sent as soon as possible when budget and connectivity allows","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Check budget with "},{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1771700-remainingcomplicationuserinfotra","type":"reference","isActive":true}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Sent as normal user info transfer when no budget remains","type":"text"}]}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Send message (","type":"text"},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615687-sendmessage","type":"reference"},{"text":")","type":"text"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Interactive messages to the counterpart app"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Send a property list dictionary or data and get a reply","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Counterpart must be reachable","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Keep messages small","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"(in the counter app) implement delegate "},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615677-session","type":"reference"},{"type":"text","text":" and\/or "},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615653-session","type":"reference"}],"type":"paragraph"}]}]}]}],"type":"unorderedList"},{"text":"Reachability","level":4,"anchor":"Reachability","type":"heading"},{"items":[{"content":[{"inlineContent":[{"text":"Both of your apps need to be reachable to send messages","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Check the "},{"type":"codeVoice","code":"WCSession.isReachable"},{"type":"text","text":" property to determine reachability"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Both devices\/app must be in Bluetooth or Wi-Fi range (to be reachable)"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The WatchKit Extension must be running in the foreground or in the background (high priority only)"}]}]},{"content":[{"inlineContent":[{"text":"The iOS counterpart does not have such requirements - If you send a message from your Watch app to your iOS app, and your iOS app is not in the foreground, your iOS app will be activated in the background to receive the message","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"URLSession","level":3,"anchor":"URLSession","type":"heading"},{"items":[{"content":[{"inlineContent":[{"text":"background and foreground configuration sessions available:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"use background sessions as much as possible","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"foreground sessions need to complete while your app is in the foreground or front-most","type":"text"}]}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"text":"Background URL Session","level":4,"anchor":"Background-URL-Session","type":"heading"},{"inlineContent":[{"type":"text","text":"Use background URL session:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"any time communication can be delayed","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"for all large data transfers"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"when updates are initiated by a server (via push notifications)"}],"type":"paragraph"}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"Example on how to send data to a server in the background:"}],"type":"paragraph"},{"code":["class BackgroundURLSession: NSObject, ObservableObject, Identifiable {","  private let sessionIDPrefix = \"com.example.backgroundURLSessionID.\"","  ","  enum Status {","    case notStarted","    case queued","    case inProgress(Double)","    case completed","    case failed(Error)","  }","  ","  private var url: URL","","  \/\/\/ Data to send with the URL request.","  \/\/\/","  \/\/\/ If this is set, the HTTP method for the request will be POST","  var body: Data?","  ","  \/\/\/ Optional content type for the URL request","  var contentType: String?","  ","  private(set) var id = UUID()","  ","  \/\/\/ The current status of the session","  @Published var status = Status.notStarted","  ","  \/\/\/ The downloaded data (populated when status == .completed)","  @Published var downloadedURL: URL?","  ","  private var backgroundTasks = [WKURLSessionRefreshBackgroundTask]()","  ","  private lazy var urlSession: URLSession = {","    let config = URLSessionConfiguration.background(withIdentifier: sessionID)","    \/\/ Set isDiscretionary = true if you are sending or receiving large ","    \/\/ amounts of data. Let Watch users know that their transfers might ","    \/\/ not start until they are connected to Wi-Fi and power.","    config.isDiscretionary = false","    config.sessionSendsLaunchEvents = true","    return URLSession(configuration: config, delegate: self, delegateQueue: nil)","  }()","  ","  private var sessionID: String {","    \"\\(sessionIDPrefix)\\(id.uuidString)\"","  }","  ","  \/\/\/ Initialize the session","  \/\/\/ - Parameter url: The URL for the Background URL Request","  init(url: URL) {","    self.url = url","    super.init()","  }","","  \/\/ Enqueue the URLRequest to send in the background. ","  func enqueueTransfer() {","    var request = URLRequest(url: url)","    request.httpBody = body","    if body != nil {","      request.httpMethod = \"POST\"","    }","    if let contentType = contentType {","      request.setValue(contentType, forHTTPHeaderField: \"Content-type\")","    }","    let task = urlSession.downloadTask(with: request)","","    \/\/ Note that the system will determine the actual time our task starts ","    \/\/ based on background budget, network, and system conditions. Your ","    \/\/ app can receive up to four background refresh tasks per hour, if ","    \/\/ you have a complication on the active watch face, so schedule your ","    \/\/ tasks at least 15 minutes apart to prevent them from being delayed ","    \/\/ by the system.","    task.earliestBeginDate = nextTaskStartDate","","    BackgroundURLSessions.sharedInstance().sessions[sessionID] = self","","    task.resume()","    status = .queued","  }","","  \/\/ Add the Background Refresh Task to the list so it can be set to ","  \/\/ completed when the URL task is done.","  func addBackgroundRefreshTask(_ task: WKURLSessionRefreshBackgroundTask) {","    backgroundTasks.append(task)","  }","}","","extension BackgroundURLSession: URLSessionDownloadDelegate {","  private func saveDownloadedData(_ downloadedURL: URL) {","    \/\/ Move or quickly process this file before you return from this function.","    \/\/ The file is in a temporary location and will be deleted.","  }","  ","  func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didFinishDownloadingTo location: URL) {","    saveDownloadedData(location)","  ","    \/\/ We don't need more updates on this session, so let it go.","    BackgroundURLSessions.sharedInstance().sessions[sessionID] = nil","  ","    DispatchQueue.main.async {","      self.status = .completed","    }","    ","    for task in backgroundTasks {","      task.setTaskCompletedWithSnapshot(false)","    }","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"The system will notify our app when our background request has been processed using a background task sent to our Extension Delegate:"}],"type":"paragraph"},{"code":["class ExtensionDelegate: NSObject, WKExtensionDelegate {","  ","  func applicationDidFinishLaunching() {","    \/\/ For Watch Connectivity, activate your WCSession as early as possible","    WatchConnectivityModel.shared.activateSession()","  }","  ","  func applicationDidBecomeActive() {","    \/\/ Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.","  }","  ","  func applicationWillResignActive() {","    \/\/ Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.","    \/\/ Use this method to pause ongoing tasks, disable timers, etc.","  }","  ","  func handle(_ backgroundTasks: Set<WKRefreshBackgroundTask>) {","    \/\/ Sent when the system needs to launch the application in the background to process tasks. Tasks arrive in a set, so loop through and process each one.","    for task in backgroundTasks {","      \/\/ Use a switch statement to check the task type","      switch task {","        case let backgroundTask as WKApplicationRefreshBackgroundTask:","          \/\/ Be sure to complete the background task once you‚Äôre done.","          backgroundTask.setTaskCompletedWithSnapshot(false)","        case let snapshotTask as WKSnapshotRefreshBackgroundTask:","          \/\/ Snapshot tasks have a unique completion call, make sure to set your expiration date","          snapshotTask.setTaskCompleted(restoredDefaultState: true, estimatedSnapshotExpiration: Date.distantFuture, userInfo: nil)","        case let connectivityTask as WKWatchConnectivityRefreshBackgroundTask:","          \/\/ Be sure to complete the connectivity task once you‚Äôre done.","          connectivityTask.setTaskCompletedWithSnapshot(false)","        case let urlSessionTask as WKURLSessionRefreshBackgroundTask:","          if let session = BackgroundURLSessions.sharedInstance()","                  .sessions[urlSessionTask.sessionIdentifier] {","              session.addBackgroundRefreshTask(urlSessionTask)","          } else {","              \/\/ There is no model for this session, just set it complete","              urlSessionTask.setTaskCompletedWithSnapshot(false)","          }","        case let relevantShortcutTask as WKRelevantShortcutRefreshBackgroundTask:","          \/\/ Be sure to complete the relevant-shortcut task once you're done.","          relevantShortcutTask.setTaskCompletedWithSnapshot(false)","        case let intentDidRunTask as WKIntentDidRunRefreshBackgroundTask:","          \/\/ Be sure to complete the intent-did-run task once you're done.","          intentDidRunTask.setTaskCompletedWithSnapshot(false)","        default:","          \/\/ make sure to complete unhandled task types","          task.setTaskCompletedWithSnapshot(false)","      }","    }","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"Here‚Äôs how we connect this delegate class in a watch app:"}],"type":"paragraph"},{"code":["@main","struct MyWatchApp: App {","  @WKExtensionDelegateAdaptor(ExtensionDelegate.self) var extensionDelegate \/\/ üëàüèª","  ","  @SceneBuilder var body: some Scene {","    ...","  }","}"],"type":"codeListing","syntax":"swift"},{"text":"Foreground URL Session","level":4,"anchor":"Foreground-URL-Session","type":"heading"},{"inlineContent":[{"text":"Use foreground URL session:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"for quick server communication","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"when you require immediate data during app interaction","type":"text"}]}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"Foreground URL sessions have a "},{"type":"text","text":"2.5"},{"type":"text","text":" minute timeout, but you should limit foreground sessions to interactions that are much quicker than that."}],"type":"paragraph"},{"text":"Sockets","level":3,"anchor":"Sockets","type":"heading"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"If you‚Äôre building a streaming audio app, sockets are another option to communicate directly with servers"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"You can use:","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"HTTP Live Streaming (HLS)"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Web Sockets"}],"type":"paragraph"}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"text":"Data communication tools Cheat sheet","level":2,"anchor":"Data-communication-tools-Cheat-sheet","type":"heading"},{"rows":[[[{"type":"paragraph","inlineContent":[]}],[{"type":"paragraph","inlineContent":[{"text":"Source, Destination","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Relies on companion iPhone"}]}],[{"type":"paragraph","inlineContent":[{"text":"Supports Family Setup","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"text":"Best For","type":"text"}]}]],[[{"type":"paragraph","inlineContent":[{"text":"iCloud Keychain synchronization","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"text":"All devices","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"text":"No","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"text":"Yes","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Infrequently changing data"}]}]],[[{"type":"paragraph","inlineContent":[{"text":"Core Data with CloudKit","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"text":"All devices and iCloud","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"No"}]}],[{"type":"paragraph","inlineContent":[{"text":"Yes","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"text":"Structured data","type":"text"}]}]],[[{"type":"paragraph","inlineContent":[{"type":"text","text":"Watch Connectivity"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Paired iPhone and Watch"}]}],[{"type":"paragraph","inlineContent":[{"text":"Yes","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"No"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Optimization"}]}]],[[{"type":"paragraph","inlineContent":[{"text":"URL Sessions","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Server"}]}],[{"type":"paragraph","inlineContent":[{"text":"No","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Yes"}]}],[{"type":"paragraph","inlineContent":[{"text":"Most server communication","type":"text"}]}]],[[{"type":"paragraph","inlineContent":[{"type":"text","text":"Sockets"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Server"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"No"}]}],[{"type":"paragraph","inlineContent":[{"text":"Yes","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"Streaming audio"}]}]]],"type":"table","header":"row"},{"text":"Written By","level":2,"anchor":"Written-By","type":"heading"},{"columns":[{"content":[{"inlineContent":[{"identifier":"zntfdr","type":"image"}],"type":"paragraph"}],"size":1},{"content":[{"type":"heading","anchor":"Federico-Zanetello","level":3,"text":"Federico Zanetello"},{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","isActive":true,"overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"overridingTitle":"Contributed Notes"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"type":"reference","identifier":"https:\/\/github.com\/zntfdr","isActive":true},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"type":"reference","identifier":"https:\/\/zntfdr.dev","isActive":true}]}],"size":4}],"numberOfColumns":5,"type":"row"},{"inlineContent":[{"type":"text","text":"Missing anything? Corrections? "},{"type":"reference","isActive":true,"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}],"type":"paragraph"},{"text":"Related Sessions","level":2,"anchor":"Related-Sessions","type":"heading"},{"style":"list","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10017-Bring-Core-Data-concurrency-to-Swift-and-SwiftUI","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10049-Keep-your-complications-up-to-date","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10115-AutoFill-everywhere","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-716-Streaming-Audio-on-watchOS-6"],"type":"links"},{"inlineContent":[{"inlineContent":[{"type":"text","text":"Legal Notice"}],"type":"strong"}],"type":"small"},{"inlineContent":[{"text":"All content copyright ¬© 2012 ‚Äì 2024 Apple Inc. All rights reserved.","type":"text"},{"text":" ","type":"text"},{"text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries.","type":"text"},{"text":" ","type":"text"},{"text":"This website is not made by, affiliated with, nor endorsed by Apple.","type":"text"}],"type":"small"}],"kind":"content"}],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc21-10003-there-and-back-again-data-transfer-on-apple-watch"]}],"references":{"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10017-Bring-Core-Data-concurrency-to-Swift-and-SwiftUI":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10017-Bring-Core-Data-concurrency-to-Swift-and-SwiftUI","title":"Bring Core Data concurrency to Swift and SwiftUI","kind":"article","role":"sampleCode","abstract":[{"text":"Discover how Core Data is adopting the new concurrency capabilities of Swift 5.5, leading to more concise, efficient, and safe asynchronous code. We‚Äôll show you how to update Core Data in your apps to work with concurrency, and detail the many other improvements throughout the framework that make working with Swift and SwiftUI more expressive and powerful.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc21-10017-bring-core-data-concurrency-to-swift-and-swiftui"},"zntfdr.jpeg":{"identifier":"zntfdr.jpeg","alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/zntfdr.jpeg"}]},"https://developer.apple.com/documentation/swiftui/geometryreader/textcontenttype(_:)-ki0h":{"identifier":"https:\/\/developer.apple.com\/documentation\/swiftui\/geometryreader\/textcontenttype(_:)-ki0h","title":"textContentType","titleInlineContent":[{"code":"textContentType","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/swiftui\/geometryreader\/textcontenttype(_:)-ki0h"},"https://developer.apple.com/documentation/watchconnectivity/wcsession/1615687-sendmessage":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615687-sendmessage","title":"sendMessage(_:replyHandler:errorHandler:)","titleInlineContent":[{"code":"sendMessage(_:replyHandler:errorHandler:)","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615687-sendmessage"},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","role":"sampleCode","kind":"article","images":[{"type":"card","identifier":"zntfdr.jpeg"},{"type":"icon","identifier":"zntfdr.jpeg"}],"abstract":[{"type":"text","text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more."}],"title":"Federico Zanetello (332 notes)","url":"\/documentation\/wwdcnotes\/zntfdr","type":"topic"},"WWDC21.jpeg":{"identifier":"WWDC21.jpeg","alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC21.jpeg"}]},"https://developer.apple.com/documentation/watchconnectivity/wcsessiondelegate/1615653-session":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615653-session","title":"session(_:didReceiveMessageData:replyHandler:)","titleInlineContent":[{"code":"session(_:didReceiveMessageData:replyHandler:)","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615653-session"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10049-Keep-your-complications-up-to-date":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10049-Keep-your-complications-up-to-date","title":"Keep your complications up to date","kind":"article","role":"sampleCode","abstract":[{"text":"Time is of the essence: Discover how your Apple Watch complications can provide relevant information throughout the day and help people get the information they need, when they need it. Learn best practices for capitalizing on your app‚Äôs runtime opportunities, incorporating APIs like background app refresh and URLSession, and implementing well-timed push notifications.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc20-10049-keep-your-complications-up-to-date"},"WWDCNotes.png":{"identifier":"WWDCNotes.png","alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes.png"}]},"https://zntfdr.dev":{"identifier":"https:\/\/zntfdr.dev","title":"Blog","titleInlineContent":[{"text":"Blog","type":"text"}],"type":"link","url":"https:\/\/zntfdr.dev"},"WWDC21-Icon.png":{"identifier":"WWDC21-Icon.png","alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC21-Icon.png"}]},"WWDC21-10003-ps1":{"identifier":"WWDC21-10003-ps1","alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC21-10003-ps1.png"}]},"WWDC21-10003-ks1":{"identifier":"WWDC21-10003-ks1","alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC21-10003-ks1.png"}]},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","title":"Contributions are welcome!","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}],"type":"link","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"https://developer.apple.com/documentation/watchconnectivity/wcsession/1615641-outstandingfiletransfers":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615641-outstandingfiletransfers","title":"outstandingFileTransfers","titleInlineContent":[{"code":"outstandingFileTransfers","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615641-outstandingfiletransfers"},"https://developer.apple.com/documentation/watchconnectivity/wcsession/1615621-updateapplicationcontext":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615621-updateapplicationcontext","title":"updateApplicationContext(_:)","titleInlineContent":[{"code":"updateApplicationContext(_:)","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615621-updateapplicationcontext"},"https://developer.apple.com/documentation/watchconnectivity/wcsession/1615627-outstandinguserinfotransfers":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615627-outstandinguserinfotransfers","title":"outstandingUserInfoTransfers","titleInlineContent":[{"code":"outstandingUserInfoTransfers","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1615627-outstandinguserinfotransfers"},"doc://WWDCNotes/documentation/WWDCNotes":{"url":"\/documentation\/wwdcnotes","role":"collection","type":"topic","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","kind":"symbol","title":"WWDC Notes"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"url":"\/documentation\/wwdcnotes\/wwdc21","role":"collectionGroup","type":"topic","images":[{"type":"icon","identifier":"WWDC21-Icon.png"},{"type":"card","identifier":"WWDC21.jpeg"}],"abstract":[{"type":"text","text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"MusicKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"DocC"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit 2"},{"type":"text","text":", and more."}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21","kind":"article","title":"WWDC21"},"https://developer.apple.com/documentation/watchconnectivity/wcsessiondelegate/1615651-session":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615651-session","title":"session(_:didReceive:)","titleInlineContent":[{"code":"session(_:didReceive:)","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615651-session"},"https://developer.apple.com/wwdc21/10003":{"identifier":"https:\/\/developer.apple.com\/wwdc21\/10003","checksum":null,"type":"download","url":"https:\/\/developer.apple.com\/wwdc21\/10003"},"https://github.com/zntfdr":{"identifier":"https:\/\/github.com\/zntfdr","title":"GitHub","titleInlineContent":[{"text":"GitHub","type":"text"}],"type":"link","url":"https:\/\/github.com\/zntfdr"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10115-AutoFill-everywhere":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10115-AutoFill-everywhere","title":"AutoFill everywhere","kind":"article","role":"sampleCode","abstract":[{"text":"Discover how to implement AutoFill in your app and help people enter their information into fields easily, privately, and securely. Learn how to help the system to give better suggestions that tailor to your app‚Äôs functionality: offer smart location suggestions within a navigation app, for example, or provide a private way to input contact information into fields from the QuickType bar.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc20-10115-autofill-everywhere"},"zntfdr":{"identifier":"zntfdr","alt":"Profile image of Federico Zanetello","type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/zntfdr.jpeg"}]},"https://developer.apple.com/documentation/watchconnectivity/wcsession/1771700-remainingcomplicationuserinfotra":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1771700-remainingcomplicationuserinfotra","title":"remainingComplicationUserInfoTransfers","titleInlineContent":[{"code":"remainingComplicationUserInfoTransfers","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsession\/1771700-remainingcomplicationuserinfotra"},"https://developer.apple.com/documentation/watchconnectivity/wcsessiondelegate/1615677-session":{"identifier":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615677-session","title":"session(_:didReceiveMessage:replyHandler:)","titleInlineContent":[{"code":"session(_:didReceiveMessage:replyHandler:)","type":"codeVoice"}],"type":"link","url":"https:\/\/developer.apple.com\/documentation\/watchconnectivity\/wcsessiondelegate\/1615677-session"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC19-716-Streaming-Audio-on-watchOS-6":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-716-Streaming-Audio-on-watchOS-6","title":"Streaming Audio on watchOS 6","kind":"article","role":"sampleCode","abstract":[{"text":"Streaming audio on Apple Watch allows customers to enjoy your content wherever they go without their iPhone. Learn about the streaming APIs brought over from iOS to allow watchOS apps to create independent audio consumption experiences. Find out how to set up your audio session for streaming and explore best practices to provide the best experience for people moving between different network conditions.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc19-716-streaming-audio-on-watchos-6"}}}