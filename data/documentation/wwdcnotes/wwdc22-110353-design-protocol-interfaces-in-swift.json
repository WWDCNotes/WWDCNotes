{"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc22-110353-design-protocol-interfaces-in-swift"]}],"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110353-Design-protocol-interfaces-in-Swift","interfaceLanguage":"swift"},"abstract":[{"text":"Learn how you can use Swift 5.7 to design advanced abstractions using protocols. Weâ€™ll show you how to use existential types, explore how you can separate implementation from interface with opaque result types, and share the same-type requirements that can help you identify and guarantee relationships between concrete types.","type":"text"}],"metadata":{"modules":[{"name":"WWDC Notes"}],"roleHeading":"WWDC22","title":"Design protocol interfaces in Swift","role":"sampleCode"},"primaryContentSections":[{"content":[{"level":2,"text":"Overview","type":"heading","anchor":"overview"},{"inlineContent":[{"text":"We will use this protocol definition as an example:","type":"text"}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["protocol Animal {","  associatedtype CommodityType: Food","  associatedtype FeedType: AnimalFeed","","  func produce() -> CommodityType","  func eat(_: FeedType)","  var isHungry: Bool { get }","}"]},{"level":2,"text":"Understand type erasure","type":"heading","anchor":"Understand-type-erasure"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"when you call a method returning an associated type on an existential type, the compiler will use type erasure to determine the result type of the call"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"type erasure replaces these associated types with corresponding existential types that have equivalent constraints"}]}]}]},{"level":3,"text":"Type erasure semantics","type":"heading","anchor":"Type-erasure-semantics"},{"level":4,"text":"Producing position","type":"heading","anchor":"Producing-position"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"code":"associatedtype","type":"codeVoice"},{"text":"s appearing in the result of a protocol method declaration are in ","type":"text"},{"text":"producing position","type":"text"},{"text":", because calling the method will produce a value of this type","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"e.g., the "},{"type":"codeVoice","code":"produce()"},{"type":"text","text":" return type in the "},{"type":"codeVoice","code":"Animal"},{"type":"text","text":" protocol definition above"}]}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"The type ","type":"text"},{"code":"any Food","type":"codeVoice"},{"text":" is called the ","type":"text"},{"text":"upper bound","type":"text"},{"text":" of the associated ","type":"text"},{"code":"CommodityType","type":"codeVoice"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"the actual concrete type that is returned from "},{"type":"codeVoice","code":"produce()"},{"type":"text","text":" can safely convert to the upper bound:"}]}]}]},{"syntax":"swift","type":"codeListing","code":["let animals: [any Animal] = [Cow()]","","animals.map { animal in","  animal.produce() \/\/ we're calling `produce()` on an `any Animal` that holds a `Cow` at runtime.","}"]},{"level":4,"text":"Consuming position","type":"heading","anchor":"Consuming-position"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"code":"associatedtype","type":"codeVoice"},{"type":"text","text":"s appearing in the parameter list of a protocol method declaration are in "},{"type":"text","text":"consuming position"},{"type":"text","text":", because calling the method will produce a value of this type"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"the upper bound cannot safely convert to the actual concrete type, because the concrete type is unknown"}],"type":"paragraph"}]}]},{"syntax":"swift","type":"codeListing","code":["let animals = [Cow()]","","animals.map { animal in","  animal.eat(???) \/\/ given an arbitrary `any AnimalFeed`, there is no way to statically guarantee that it stores what Cow needs","}"]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"type erasure does not allow us to work with associated types in consuming position"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"instead, you must unbox the existential "},{"code":"any","type":"codeVoice"},{"type":"text","text":" type by passing it to a function that takes an opaque "},{"code":"some","type":"codeVoice"},{"type":"text","text":" type"}],"type":"paragraph"}]}]},{"level":2,"text":"Hide implementation details","type":"heading","anchor":"Hide-implementation-details"},{"level":3,"text":"Constrained opaque result type","type":"heading","anchor":"Constrained-opaque-result-type"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"new in swift 5.7","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"written by applying type arguments in angle brackets after the protocol name - e.g., "},{"type":"codeVoice","code":"some Collection<any Animal>"}]}]}]},{"level":2,"text":"Identify type relationships","type":"heading","anchor":"Identify-type-relationships"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"every protocol has a ","type":"text"},{"code":"Self","type":"codeVoice"},{"text":" type, which stands for the concrete conforming type","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"we can express the relationship between  "},{"type":"codeVoice","code":"associatedtype"},{"type":"text","text":"s using a same-type requirement, written in a "},{"type":"codeVoice","code":"where"},{"type":"text","text":" clause"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"A same-type requirement expresses a static guarantee that two different, possibly nested associated types must in fact be the same concrete type","type":"text"}]}]}]},{"syntax":"swift","type":"codeListing","code":["protocol AnimalFeed{","  associatedtype CropType: Crop","    where CropType.FeedType == Self \/\/ ðŸ‘ˆðŸ» same-type requirement","  ","  static func grow() -> CropType","}","","protocol Crop {","  associatedtype FeedType: AnimalFeed","    where FeedType.CropType == Self \/\/ ðŸ‘ˆðŸ» same-type requirement","  func harvest() -> FeedType"]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"By understanding your data model, you can use same-type requirements to define equivalences between these different nested associated types","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Generic code can then rely on these relationships when chaining together multiple calls to protocol requirements"}]}]}]},{"level":2,"text":"Written By","type":"heading","anchor":"Written-By"},{"type":"row","columns":[{"size":1,"content":[{"inlineContent":[{"identifier":"zntfdr","type":"image"}],"type":"paragraph"}]},{"size":4,"content":[{"type":"heading","text":"Federico Zanetello","anchor":"Federico-Zanetello","level":3},{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","overridingTitle":"Contributed Notes","overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/zntfdr"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"https:\/\/zntfdr.dev"}]}]}],"numberOfColumns":5},{"inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","isActive":true,"type":"reference"}],"type":"paragraph"},{"level":2,"text":"Related Sessions","type":"heading","anchor":"Related-Sessions"},{"style":"list","type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10168-Generalize-APIs-with-parameter-packs","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110352-Embrace-Swift-generics","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110354-Whats-new-in-Swift"]},{"inlineContent":[{"inlineContent":[{"text":"Legal Notice","type":"text"}],"type":"strong"}],"type":"small"},{"inlineContent":[{"type":"text","text":"All content copyright Â© 2012 â€“ 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}],"type":"small"}],"kind":"content"}],"schemaVersion":{"patch":0,"major":0,"minor":3},"sections":[],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22"]]},"kind":"article","sampleCodeDownload":{"action":{"type":"reference","overridingTitle":"Watch Video (25 min)","identifier":"https:\/\/developer.apple.com\/wwdc22\/110353","isActive":true},"kind":"sampleDownload"},"references":{"https://developer.apple.com/wwdc22/110353":{"identifier":"https:\/\/developer.apple.com\/wwdc22\/110353","checksum":null,"url":"https:\/\/developer.apple.com\/wwdc22\/110353","type":"download"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110352-Embrace-Swift-generics":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110352-Embrace-Swift-generics","url":"\/documentation\/wwdcnotes\/wwdc22-110352-embrace-swift-generics","title":"Embrace Swift generics","role":"sampleCode","type":"topic","kind":"article","abstract":[{"type":"text","text":"Generics are a fundamental tool for writing abstract code in Swift. Learn how you can identify opportunities for abstraction as your code evolves, evaluate strategies for writing one piece of code with many behaviors, and discover language features in Swift 5.7 that can help you make generic code easier to write and understand."}]},"zntfdr":{"variants":[{"url":"\/images\/zntfdr.jpeg","traits":["1x","light"]}],"identifier":"zntfdr","alt":"Profile image of Federico Zanetello","type":"image"},"https://github.com/zntfdr":{"identifier":"https:\/\/github.com\/zntfdr","url":"https:\/\/github.com\/zntfdr","title":"GitHub","type":"link","titleInlineContent":[{"text":"GitHub","type":"text"}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22":{"images":[{"type":"icon","identifier":"WWDC22-Icon.png"},{"type":"card","identifier":"WWDC22.jpeg"}],"url":"\/documentation\/wwdcnotes\/wwdc22","title":"WWDC22","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22","abstract":[{"type":"text","text":"Xcode 14, Swift 5.7, iOS 16, macOS 13 (Ventura), tvOS 16, watchOS 9."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"code":"WeatherKit","type":"codeVoice"},{"type":"text","text":", "},{"code":"ScreenCaptureKit","type":"codeVoice"},{"text":", ","type":"text"},{"type":"codeVoice","code":"Swift Regex"},{"text":", and more.","type":"text"}],"role":"collectionGroup","type":"topic","kind":"article"},"WWDCNotes.png":{"variants":[{"url":"\/images\/WWDCNotes.png","traits":["1x","light"]}],"identifier":"WWDCNotes.png","alt":null,"type":"image"},"WWDC22.jpeg":{"variants":[{"url":"\/images\/WWDC22.jpeg","traits":["1x","light"]}],"identifier":"WWDC22.jpeg","alt":null,"type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110354-Whats-new-in-Swift":{"url":"\/documentation\/wwdcnotes\/wwdc22-110354-whats-new-in-swift","title":"Whatâ€™s new in Swift","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110354-Whats-new-in-Swift","abstract":[{"type":"text","text":"Join us for an update on Swift. Weâ€™ll take you through performance improvements, explore more secure and extensible Swift packages, and share advancements in Swift concurrency. Weâ€™ll also introduce you to Swift Regex, better generics, and other tools built into the language to help you write more flexible & expressive code."}],"role":"sampleCode","type":"topic","kind":"article"},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"images":[{"identifier":"zntfdr.jpeg","type":"card"},{"identifier":"zntfdr.jpeg","type":"icon"}],"type":"topic","url":"\/documentation\/wwdcnotes\/zntfdr","abstract":[{"type":"text","text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more."}],"kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","title":"Federico Zanetello (332 notes)","role":"sampleCode"},"zntfdr.jpeg":{"variants":[{"url":"\/images\/zntfdr.jpeg","traits":["1x","light"]}],"identifier":"zntfdr.jpeg","alt":null,"type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10168-Generalize-APIs-with-parameter-packs":{"url":"\/documentation\/wwdcnotes\/wwdc23-10168-generalize-apis-with-parameter-packs","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10168-Generalize-APIs-with-parameter-packs","abstract":[{"type":"text","text":"Swift parameter packs are a powerful tool to expand what is possible in your generic code while also enabling you to simplify common generic patterns. Weâ€™ll show you how to abstract over types as well as the number of arguments in generic code and simplify common generic patterns to avoid overloads."}],"role":"sampleCode","title":"Generalize APIs with parameter packs","kind":"article","type":"topic"},"WWDC22-Icon.png":{"variants":[{"url":"\/images\/WWDC22-Icon.png","traits":["1x","light"]}],"identifier":"WWDC22-Icon.png","alt":null,"type":"image"},"https://zntfdr.dev":{"identifier":"https:\/\/zntfdr.dev","url":"https:\/\/zntfdr.dev","title":"Blog","type":"link","titleInlineContent":[{"text":"Blog","type":"text"}]},"doc://WWDCNotes/documentation/WWDCNotes":{"abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"type":"topic","kind":"symbol","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"title":"WWDC Notes","role":"collection","url":"\/documentation\/wwdcnotes","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","title":"Contributions are welcome!","type":"link","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}]}}}