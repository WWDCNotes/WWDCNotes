{"kind":"article","identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10101-Customize-ondevice-speech-recognition","interfaceLanguage":"swift"},"abstract":[{"type":"text","text":"Find out how you can improve on-device speech recognition in your app by customizing the underlying model with additional vocabulary. We’ll share how speech recognition works on device and show you how to boost specific words and phrases for more predictable transcription. Learn how you can provide specific pronunciations for words and use template support to quickly generate a full set of custom phrases — all at runtime."}],"sampleCodeDownload":{"kind":"sampleDownload","action":{"isActive":true,"type":"reference","identifier":"https:\/\/developer.apple.com\/wwdc23\/10101","overridingTitle":"Watch Video (7 min)"}},"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc23-10101-customize-ondevice-speech-recognition"]}],"metadata":{"roleHeading":"WWDC23","modules":[{"name":"WWDC Notes"}],"role":"sampleCode","title":"Customize on-device speech recognition"},"schemaVersion":{"major":0,"patch":0,"minor":3},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23"]]},"sections":[],"primaryContentSections":[{"kind":"content","content":[{"anchor":"Previous-Iteration-of-Speech-Recognizer","type":"heading","text":"Previous Iteration of Speech Recognizer","level":3},{"inlineContent":[{"type":"text","text":"By default, when you embed Apple’s Speech framework into your app it uses a general language model to reject transcription candidates that it feels are less likely. This doesn’t work well if your app is geared toward less common verbiage."}],"type":"paragraph"},{"inlineContent":[{"type":"image","identifier":"WWDC23-10101-default-speech-recognition-workflow"}],"type":"paragraph"},{"inlineContent":[{"text":"For example, in a chess app, you may want to tell the app “Play the Albin counter gambit” but this verbiage is so rare in the general language model that it incorrectly interprets this as “Play the album Counter Gambit”.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"identifier":"WWDC23-10101-customized-speech-recognition-workflow","type":"image"}],"type":"paragraph"},{"anchor":"Language-Model-Customization","type":"heading","text":"Language Model Customization","level":3},{"inlineContent":[{"type":"text","text":"New in iOS 17, you’ll be able to customize the behavior of the SFSpeechRecognizer’s language model, tailor it to your application, and improve its accuracy."}],"type":"paragraph"},{"inlineContent":[{"text":"Steps:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Create a collection of training data (during development process)"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Prepare the training data"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Configure a recognition request"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Run it"}]}]}],"type":"orderedList"},{"anchor":"Data-Generation","level":3,"text":"Data Generation","type":"heading"},{"inlineContent":[{"text":"Training data will consist of bits of text that represent phrases your app’s users are likely to speak.","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["  import Speech","","  let data = SFCustomLanguageModelData(","      locale: Locale(identifier: \"en_US\"),","      identifier: \"com.apple.SampleApp\",","      version: \"1.0\"","  ) {","      SFCustomLanguageModelData.PhraseCount(","          phrase: \"Play the Albin counter gambit\",","          count: 10","      )","  }"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"In the above example, we feed our custom phrase into the model 10 times. Experiment often, you could be surpised at how quickly the model learns your phrases."}],"type":"paragraph"},{"inlineContent":[{"text":"Only so much data can be accepted by the system, so balance your need to boost phrases against your overall training data budget.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"Furthermore, you can declare classes of words and put them into a pattern to represent every possible combination."}],"type":"paragraph"},{"syntax":"swift","code":["  SFCustomLanguageModelData.PhraseCountsFromTemplates(","      classes: [","          \"piece\" : [\"pawn\", \"rook\", \"knight\", \"bishop\", \"queen\", \"king\"],","          \"royal\" : [\"queen\", \"king\"],","          \"rank\" : Array(1...8).map({String($0)})","      ]","  ) {","      SFCustomLanguageModelData.TemplatePhraseCountGenerator.Template(","          \"‹piece> to <royal> <piece> <rank>\",","          count: 10000","      )","  }"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"When you are done building up the data object, export it to a file and deploy into your app like any other asset."}],"type":"paragraph"},{"syntax":"swift","code":["  try await data.export(to: URL(filePath: \"\/var\/tmp\/SampleApp.bin\"))"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"If your app makes use of specialized terminology, for example, a medical app that includes the names of pharmaceuticals, you can define both the spelling and pronunciations of those terms, and provide phrase counts that demonstrates their usage."}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Pronunciations are accepted in the form of X-SAMPA strings"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Each locale supports a unique subset of pronunciation symbols","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"syntax":"swift","code":["  SFCustomLanguageModelData.CustomPronunciation(","      grapheme: \"Winawer\",","      phonemes: [\"w I n aU @r\"]","  )","  SFCustomLanguageModelData.PhraseCount(","      phrase: \"Play the Winawer variation\",","      count: 10","  )"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"The model can also be trained at runtime, for example, if you want to train it on commonly used names from the user’s contacts."}],"type":"paragraph"},{"syntax":"swift","code":["  func scrapeDataForLmCustomization() {","      Task.detached {","          let data = SFCustomLanguageModelData(","              locale: Locale(identifier: \"en_US\"),","              identifier: \"SampleApp\", ","              version: \"1.0\"","          ) {","              for (name, timesCalled) in getCallHistory() {","                  SFCustomLanguageModelData.PhraseCount (","                      phrase: \"Call \\(name)\",","                      count: timesCalled","                  )","              }","              \/\/...","          }","      }","  }"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"Once the training data is generated, it is bound to a single locale. If you want to support multiple locales within a single script, you can use standard localization facilities like NSLocalizedString to do so."}],"type":"paragraph"},{"anchor":"Deploying-Your-Model","level":3,"text":"Deploying Your Model","type":"heading"},{"syntax":"swift","code":["  public func prepCustomlm() {","      self.customLmTask = Task.detached {","          self.hasBuiltLm = false","          try await SFSpeechLanguageModel.prepareCustomLanguageModel(","              for: self.assetPath,","              clientIdentifier: \"com.apple.SampleApp\",","              configuration: self.ImConfiguration","          )","          self.hasBuiltLm = true","      ｝","  }"],"type":"codeListing"},{"inlineContent":[{"text":"This method call can have a large amount of associated latency, so it’s best to call it off the main thread, and hide the latency behind some UI, such as a loading screen.","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["  public func startRecording(updateRecognitionText: @escaping (String) -> Void) throws {","      recognitionRequest = SFSpeechAudioBufferRecognitionRequest ()","      \/\/ keep recognition data on device","      recognitionRequest.requires0nDeviceRecognition = true","      recognitionRequest. customizedLanguageModel = self.ImConfiguration","      \/\/...","  }"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"When your app constructs the speech recognition request, you first enforce that the recognition is run on device. Failing to do so will cause requests to be serviced without customization."}],"type":"paragraph"},{"anchor":"Written-By","level":2,"text":"Written By","type":"heading"},{"numberOfColumns":5,"columns":[{"content":[{"type":"paragraph","inlineContent":[{"identifier":"trav-ma","type":"image"}]}],"size":1},{"content":[{"level":3,"type":"heading","text":"Travis Ma","anchor":"Travis-Ma"},{"inlineContent":[{"isActive":true,"overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"overridingTitle":"Contributed Notes","type":"reference","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/trav-ma"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/trav-ma"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"https:\/\/www.travisma.me"}],"type":"paragraph"}],"size":4}],"type":"row"},{"inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"isActive":true,"identifier":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing","type":"reference"}],"type":"paragraph"},{"anchor":"Related-Sessions","level":2,"text":"Related Sessions","type":"heading"},{"items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-256-Advances-in-Speech-Recognition"],"style":"list","type":"links"},{"inlineContent":[{"inlineContent":[{"type":"text","text":"Legal Notice"}],"type":"strong"}],"type":"small"},{"inlineContent":[{"text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved.","type":"text"},{"text":" ","type":"text"},{"text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries.","type":"text"},{"text":" ","type":"text"},{"text":"This website is not made by, affiliated with, nor endorsed by Apple.","type":"text"}],"type":"small"}]}],"references":{"trav-ma":{"type":"image","identifier":"trav-ma","alt":"Profile image of Travis Ma","variants":[{"traits":["1x","light"],"url":"\/images\/trav-ma.jpeg"}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC19-256-Advances-in-Speech-Recognition":{"kind":"article","title":"Advances in Speech Recognition","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-256-Advances-in-Speech-Recognition","url":"\/documentation\/wwdcnotes\/wwdc19-256-advances-in-speech-recognition","abstract":[{"type":"text","text":"Speech Recognizer can now be used locally on iOS or macOS devices with no network connection. Learn how you can bring text-to-speech support to your app while maintaining privacy and eliminating the limitations of server-based processing. Speech recognition API has also been enhanced to provide richer analytics including speaking rate, pause duration, and voice quality."}],"role":"sampleCode"},"https://wwdcnotes.github.io/WWDCNotes/documentation/wwdcnotes/contributing":{"title":"Contributions are welcome!","type":"link","identifier":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing","url":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing","titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}]},"WWDC23-10101-default-speech-recognition-workflow":{"type":"image","identifier":"WWDC23-10101-default-speech-recognition-workflow","alt":"Default Speech Recognition Workflow","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23-10101-default-speech-recognition-workflow.png"}]},"WWDC23-Icon.png":{"type":"image","identifier":"WWDC23-Icon.png","alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23-Icon.png"}]},"https://www.travisma.me":{"title":"Blog","type":"link","identifier":"https:\/\/www.travisma.me","url":"https:\/\/www.travisma.me","titleInlineContent":[{"type":"text","text":"Blog"}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23":{"abstract":[{"type":"text","text":"Xcode 15, Swift 5.9, iOS 17, macOS 14 (Sonoma), tvOS 17, visionOS 1, watchOS 10."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"code":"SwiftData","type":"codeVoice"},{"type":"text","text":", "},{"type":"codeVoice","code":"Observation"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit"},{"type":"text","text":" views, and more."}],"title":"WWDC23","images":[{"type":"icon","identifier":"WWDC23-Icon.png"},{"type":"card","identifier":"WWDC23.jpeg"}],"kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23","url":"\/documentation\/wwdcnotes\/wwdc23","role":"collectionGroup"},"https://github.com/trav-ma":{"title":"GitHub","type":"link","identifier":"https:\/\/github.com\/trav-ma","url":"https:\/\/github.com\/trav-ma","titleInlineContent":[{"type":"text","text":"GitHub"}]},"https://developer.apple.com/wwdc23/10101":{"type":"download","identifier":"https:\/\/developer.apple.com\/wwdc23\/10101","url":"https:\/\/developer.apple.com\/wwdc23\/10101","checksum":null},"doc://WWDCNotes/documentation/WWDCNotes/trav-ma":{"kind":"article","title":"Travis Ma (5 notes)","images":[{"type":"card","identifier":"trav-ma.jpeg"},{"type":"icon","identifier":"trav-ma.jpeg"}],"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/trav-ma","url":"\/documentation\/wwdcnotes\/trav-ma","abstract":[{"type":"text","text":"Software Development Manager for IQVIA’s Mobile team in Arizona."}],"role":"sampleCode"},"trav-ma.jpeg":{"type":"image","identifier":"trav-ma.jpeg","alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/trav-ma.jpeg"}]},"WWDC23-10101-customized-speech-recognition-workflow":{"type":"image","identifier":"WWDC23-10101-customized-speech-recognition-workflow","alt":"Custom Speech Recognition Workflow","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23-10101-customized-speech-recognition-workflow.png"}]},"WWDCNotes.png":{"type":"image","identifier":"WWDCNotes.png","alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes.png"}]},"WWDC23.jpeg":{"type":"image","identifier":"WWDC23.jpeg","alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23.jpeg"}]},"doc://WWDCNotes/documentation/WWDCNotes":{"type":"topic","title":"WWDC Notes","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"kind":"symbol","url":"\/documentation\/wwdcnotes","role":"collection"}}}