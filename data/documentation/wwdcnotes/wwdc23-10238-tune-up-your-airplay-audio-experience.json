{"kind":"article","variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc23-10238-tune-up-your-airplay-audio-experience"],"traits":[{"interfaceLanguage":"swift"}]}],"schemaVersion":{"minor":3,"major":0,"patch":0},"metadata":{"role":"sampleCode","modules":[{"name":"WWDC Notes"}],"roleHeading":"WWDC23","title":"Tune up your AirPlay audio experience"},"sections":[],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23"]]},"abstract":[{"text":"Learn how you can upgrade your app’s AirPlay audio experience to be more robust and responsive. We’ll show you how to adopt enhanced audio buffering with AVQueuePlayer, explore alternatives when building a custom player in your app, and share best practices.","type":"text"}],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10238-Tune-up-your-AirPlay-audio-experience"},"sampleCodeDownload":{"action":{"isActive":true,"overridingTitle":"Watch Video (10 min)","type":"reference","identifier":"https:\/\/developer.apple.com\/wwdc23\/10238"},"kind":"sampleDownload"},"primaryContentSections":[{"content":[{"type":"heading","text":"Airplay Overview","level":2,"anchor":"Airplay-Overview"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"With AirPlay Audio you can stream your favorite music or podcast in perfect sync."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"With AirPlay Video, you can stream your favorite movies and shows."}]}]},{"content":[{"inlineContent":[{"type":"text","text":"With mirroring, you can share photos, personal videos, games, web pages, or spreadsheets."}],"type":"paragraph"}]}]},{"type":"heading","text":"Airplay Enhanced Audio Buffering","level":2,"anchor":"Airplay-Enhanced-Audio-Buffering"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Built with a new and improved protocol keeping Whole home audio in mind.","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Audio streams faster than real-time playback speed in order to minimize playback interruptions.","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Highly responsive on HomePod or iPhone as a remote control.","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Supports multi-channel audio formats, like Dolby ATMOS.","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Intelligent use of Lossless playback for iOS.","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Supports HLS Interstitials."}],"type":"paragraph"}]}]},{"type":"heading","text":"Add Support To Your App","level":2,"anchor":"Add-Support-To-Your-App"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"If playing media is central to your app, set your audio session’s category to "},{"code":".playback","type":"codeVoice"},{"type":"text","text":". This will ensure your app’s media will continue playing when the app is in background."}],"type":"paragraph"}]}]},{"type":"codeListing","code":["let audioSession = AVAudioSession.sharedInstance()","try audioSession.setCategory(. playback ,xmode: . default , policy:.longFormAudio ) "],"syntax":"swift"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"for spoken audio, like podcasts or audiobooks, to set the mode to ","type":"text"},{"code":".spokenAudio","type":"codeVoice"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"set the audio session’s routing policy to "},{"type":"codeVoice","code":".longFormAudio"},{"type":"text","text":". Longform audio is anything other than system sounds, such as music or podcasts."}],"type":"paragraph"}]}]},{"type":"heading","text":"Intelligent Airplay Support","level":2,"anchor":"Intelligent-Airplay-Support"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Add a new key\/value to ","type":"text"},{"code":"info.plist","type":"codeVoice"},{"text":" and set ","type":"text"},{"code":"AVInitialRouteSharingPolicy = LongformAudio","type":"codeVoice"}],"type":"paragraph"}]}]},{"type":"heading","text":"Supporting Airplay","level":3,"anchor":"Supporting-Airplay"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Identify the audio type: add ","type":"text"},{"type":"codeVoice","code":"AVRoutePickerView"},{"text":" to your view hierarchy to include an AirPlay picker in your app.","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Add an Airplay picker: The picker provides people with a list of potential AirPlay devices that they can use with your app."}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Add a media player: "},{"type":"codeVoice","code":"MPNowPlayingInfoCenter"},{"type":"text","text":" and "},{"type":"codeVoice","code":"MPRemoteCommandCenter"},{"type":"text","text":" to receive remote commands, like play, pause, or skip."}],"type":"paragraph"}]}]},{"type":"heading","text":"Supporting Airplay Enhanced Audio Buffering","level":2,"anchor":"Supporting-Airplay-Enhanced-Audio-Buffering"},{"type":"paragraph","inlineContent":[{"code":"AVPLayer","type":"codeVoice"},{"type":"text","text":" or "},{"code":"AVQueuePlayer","type":"codeVoice"},{"type":"text","text":" is the simplest way to support enhanced audio buffering for your app where AVQueuePlayer is highly recommended."}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Create a queue player "},{"code":"let player = AVQueuePlayer()","type":"codeVoice"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Identify a URL that points to local or cloud content that you want to play."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Then create an AVAsset instance with the URL, and create an AVPlayerItem instance with that asset.","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Give the AVPlayerItem to the player and start playback.","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Automatically gets enhanced audio buffering when it is routed to AirPlay."}],"type":"paragraph"}]}]},{"type":"codeListing","code":["let player = AVQueuePlayer()","","let url = URL(string: \"http:\/\/www.examplecontenturl.com\")","let asset = AVAsset(url: url)","let item = AVPlayItem(asset: asset)","","player.insert(item, after: nil)","player.play()",""],"syntax":"swift"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"If your app preprocess on the media data or have a DRM model AVPlayer use","type":"text"},{"code":"AVSampleBufferAudioRenderer and AVSampleBufferRenderSynchronizer","type":"codeVoice"},{"text":" to synchronize multiple queued sample buffers to a single timeline","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"create a serial queue to perform all playback operations on."}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Create the audio renderer and the render synchronizer. The synchronizer is used to establish the media timeline."}],"type":"paragraph"}]}]},{"type":"codeListing","code":["let serializationQueue = DispatchQueue(label: \"sample.buffer.player.serialization.queue\")","let audioRenderer = AVSampleBufferAudioRenderer()","let renderSynchronizer = AVSampleBufferRenderSynchronizer()"],"syntax":"swift"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Add the audio renderer to the render synchronizer ","type":"text"},{"code":"renderSynchronizer.addRenderer(audioRenderer)","type":"codeVoice"},{"text":". This will tell the audio renderer to follow the media timeline.","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"To enqueue audio data, install a callback that will let you know you need more data."}],"type":"paragraph"}]}]},{"type":"codeListing","code":["serializationQueue.async { [weak self] in","    guard let self = self else { return }","    \/\/ Start processing audio data and stop when there's no more data.","    self.audioRenderer.requestMediaDataWhenReady(on: serializationQueue) { [weak self] in","        guard let self = self else { return }","        while self.audioRenderer.isReadyForMoreMediaData {","            let sampleBuffer = self.nextSampleBuffer() \/\/ Returns nil at end of data.","            if let sampleBuffer = sampleBuffer {","                self.audioRenderer.enqueue(sampleBuffer)","            } else {","                \/\/ Tell the renderer to stop requesting audio data.","                audioRenderer.stopRequestingMediaData()","            }","        }","    }","","    \/\/ Start playback at the natural rate of the media.","    self.renderSynchronizer.rate = 1.0","}"],"syntax":"swift"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Both APIs will work for non-AirPlay playback, including local or Bluetooth.","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Developers might want different APIs for AirPlay and non-AirPlay playback. In that case, your app can register to the routeChangeNotification and act accordingly depending on the current route.","type":"text"}]}]}]},{"type":"heading","text":"CarPlay enhanced audio Buffering","level":2,"anchor":"CarPlay-enhanced-audio-Buffering"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"car manufacture support."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Wireless, robust and responsive playback."}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Same APIs support CarPlay."}],"type":"paragraph"}]}]},{"type":"heading","text":"Written By","level":2,"anchor":"Written-By"},{"type":"row","columns":[{"size":1,"content":[{"inlineContent":[{"type":"image","identifier":"RamitSharma991"}],"type":"paragraph"}]},{"size":4,"content":[{"level":3,"text":"Ramit Sharma","anchor":"Ramit-Sharma","type":"heading"},{"inlineContent":[{"overridingTitle":"Contributed Notes","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/RamitSharma991","type":"reference","overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"isActive":true},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/github.com\/RamitSharma991","type":"reference","isActive":true},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/","type":"reference","isActive":true},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/x.com\/iosDev_ramit","type":"reference","isActive":true}],"type":"paragraph"}]}],"numberOfColumns":5},{"type":"paragraph","inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}]},{"type":"heading","text":"Related Sessions","level":2,"anchor":"Related-Sessions"},{"type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10104-Integrate-your-media-app-with-HomePod","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10150-Optimize-CarPlay-for-vehicle-systems","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10275-Explore-AirPlay-with-interstitials"],"style":"list"},{"type":"small","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Legal Notice"}]}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}],"kind":"content"}],"references":{"RamitSharma991.jpeg":{"type":"image","alt":null,"identifier":"RamitSharma991.jpeg","variants":[{"url":"\/images\/RamitSharma991.jpeg","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10104-Integrate-your-media-app-with-HomePod":{"type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10104-Integrate-your-media-app-with-HomePod","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc23-10104-integrate-your-media-app-with-homepod","title":"Integrate your media app with HomePod","abstract":[{"type":"text","text":"Learn how people can interact with your media app directly from HomePod. We’ll show you how to add a media intent to your iPhone or iPad app and help people stream your content to a HomePod speaker over AirPlay simply by using their voice. Explore implementation details and get tips and best practices on how to create a great experience for music, audiobooks, podcasts, meditations, or other media types."}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10150-Optimize-CarPlay-for-vehicle-systems":{"type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10150-Optimize-CarPlay-for-vehicle-systems","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc23-10150-optimize-carplay-for-vehicle-systems","title":"Optimize CarPlay for vehicle systems","abstract":[{"type":"text","text":"Discover how you can integrate CarPlay into modern vehicle systems. We’ll show you how to adjust CarPlay for any high-resolution display — regardless of configuration or size. Learn how you can use CarPlay-supplied metadata and video streams to show information on additional displays, and find out how advances in wireless connectivity, audio, and video encoding can help prepare your vehicle system for the next generation of CarPlay."}]},"WWDC23.jpeg":{"type":"image","alt":null,"identifier":"WWDC23.jpeg","variants":[{"url":"\/images\/WWDC23.jpeg","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes":{"kind":"symbol","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"url":"\/documentation\/wwdcnotes","role":"collection","title":"WWDC Notes"},"WWDCNotes.png":{"type":"image","alt":null,"identifier":"WWDCNotes.png","variants":[{"url":"\/images\/WWDCNotes.png","traits":["1x","light"]}]},"https://github.com/RamitSharma991":{"titleInlineContent":[{"type":"text","text":"GitHub"}],"type":"link","identifier":"https:\/\/github.com\/RamitSharma991","url":"https:\/\/github.com\/RamitSharma991","title":"GitHub"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23":{"title":"WWDC23","role":"collectionGroup","abstract":[{"text":"Xcode 15, Swift 5.9, iOS 17, macOS 14 (Sonoma), tvOS 17, visionOS 1, watchOS 10.","type":"text"},{"text":" ","type":"text"},{"text":"New APIs: ","type":"text"},{"code":"SwiftData","type":"codeVoice"},{"text":", ","type":"text"},{"code":"Observation","type":"codeVoice"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit"},{"type":"text","text":" views, and more."}],"images":[{"type":"icon","identifier":"WWDC23-Icon.png"},{"type":"card","identifier":"WWDC23.jpeg"}],"url":"\/documentation\/wwdcnotes\/wwdc23","type":"topic","kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23"},"WWDC23-Icon.png":{"type":"image","alt":null,"identifier":"WWDC23-Icon.png","variants":[{"url":"\/images\/WWDC23-Icon.png","traits":["1x","light"]}]},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"type":"link","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","title":"Contributions are welcome!"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10275-Explore-AirPlay-with-interstitials":{"type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10275-Explore-AirPlay-with-interstitials","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc23-10275-explore-airplay-with-interstitials","title":"Explore AirPlay with interstitials","abstract":[{"type":"text","text":"Learn how you can use HLS Interstitials with AirPlay to create seamless transitions for your video content between advertisements. We’ll share best practices and tips for creating a great experience when sharing content from Apple devices to popular smart TVs."}]},"https://developer.apple.com/wwdc23/10238":{"type":"download","identifier":"https:\/\/developer.apple.com\/wwdc23\/10238","checksum":null,"url":"https:\/\/developer.apple.com\/wwdc23\/10238"},"https://":{"titleInlineContent":[{"type":"text","text":"Blog"}],"type":"link","identifier":"https:\/\/","url":"https:\/\/","title":"Blog"},"https://x.com/iosDev_ramit":{"titleInlineContent":[{"type":"text","text":"X\/Twitter"}],"type":"link","identifier":"https:\/\/x.com\/iosDev_ramit","url":"https:\/\/x.com\/iosDev_ramit","title":"X\/Twitter"},"doc://WWDCNotes/documentation/WWDCNotes/RamitSharma991":{"role":"sampleCode","kind":"article","url":"\/documentation\/wwdcnotes\/ramitsharma991","type":"topic","images":[{"identifier":"RamitSharma991.jpeg","type":"card"},{"identifier":"RamitSharma991.jpeg","type":"icon"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/RamitSharma991","abstract":[{"text":"Indie iOS Dev. Swift, SwiftUI, Obj-C, UX and related.","type":"text"}],"title":"Ramit Sharma (15 notes)"},"RamitSharma991":{"type":"image","alt":"Profile image of Ramit Sharma","identifier":"RamitSharma991","variants":[{"url":"\/images\/RamitSharma991.jpeg","traits":["1x","light"]}]}}}