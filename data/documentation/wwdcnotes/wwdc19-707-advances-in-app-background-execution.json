{"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-707-Advances-in-App-Background-Execution","interfaceLanguage":"swift"},"metadata":{"role":"sampleCode","title":"Advances in App Background Execution","roleHeading":"WWDC19","modules":[{"name":"WWDC Notes"}]},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19"]]},"schemaVersion":{"major":0,"minor":3,"patch":0},"sections":[],"variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc19-707-advances-in-app-background-execution"],"traits":[{"interfaceLanguage":"swift"}]}],"kind":"article","primaryContentSections":[{"content":[{"level":2,"anchor":"Background-Execution-Best-Practices","type":"heading","text":"Background Execution Best Practices"},{"type":"paragraph","inlineContent":[{"type":"text","text":"If we want something to happen now or almost now, even when the app goes to the background, we need to call:"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"from main app: ","type":"text"},{"identifier":"https:\/\/developer.apple.com\/documentation\/uikit\/uiapplication\/1623031-beginbackgroundtask","isActive":true,"type":"reference"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"from extensions: ","type":"text"},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/foundation\/processinfo\/1617030-performexpiringactivity","type":"reference"}]}]}]},{"type":"paragraph","inlineContent":[{"text":"These objects give us more run time in the case our app is not in the foreground anymore. This api will ensure that our request goes through before the app gets suspended.","type":"text"}]},{"level":2,"anchor":"Discretionary-Background-URL-Session","type":"heading","text":"Discretionary Background URL Session"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Defer the download to later, when is “later” is decided by the system (could be hours!)."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"This is for downloading content that is not high priority (or batch analytics) and to do so when is more proper.","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Allows the system to defer the download until a better time","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Provide information to system for smarter scheduling","type":"text"}]}]}]},{"code":["\/\/ Set up background URL session ","let config = URLSessionConfiguration.background(withIdentifier: \"com.app.attachments\")","let session = URLSession (configuration: config, delegate: ..., delegateQueue: ...)","","\/\/ Set discretionary","config.discretionary = true "],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"We can even set a the earliest time when to start a download and an estimate workload size so the system can make some assumption on when it is the right time to do so."}]},{"type":"paragraph","inlineContent":[{"text":"Note that, if we put it too far in the future, and the user never uses the app again, our task might never be executed.","type":"text"}]},{"code":["\/\/ Set time window","task.earliestBeginDate = Date(timeIntervalSinceNow: 2 * 60 * 60)","","\/\/ Set workload size ","task.countOfBytesClientExpectsToSend = 160","task.countOfBytesClientExpectsToReceive = 4096","task.resume() "],"syntax":"swift","type":"codeListing"},{"level":2,"anchor":"BackgroundTasks-Framework","type":"heading","text":"`BackgroundTasks` Framework"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"New in iOS 13","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Example of tasks that fit perfectly with this framework:"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"Data Syncing","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Database Cleanup"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Backups Upload","type":"text"}]}]}],"type":"unorderedList"}]}]},{"level":3,"anchor":"Background-Processing-Tasks","type":"heading","text":"Background Processing Tasks"},{"type":"paragraph","inlineContent":[{"text":"Features:","type":"text"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Several minutes of runtime at system-friendly times"}]}]},{"content":[{"inlineContent":[{"text":"Option to turn off CPU Monitor for intensive work:","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"at night when the device is charging we can do battery intensive work without worrying","type":"text"}],"type":"paragraph"}]}]},{"level":3,"anchor":"Background-App-Refresh-Task","type":"heading","text":"Background App Refresh Task"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"30 seconds of runtime to update the app every time"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Called based on the user usage pattern: our app will get this refresh task before the user launches the app (again, based on the pattern) so that when the user launches the app all the new content has been downloaded already."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"See "},{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgapprefreshtask"}]}]}]},{"level":2,"anchor":"How-to-use-BackgroundTasks","type":"heading","text":"How to use `BackgroundTasks`"},{"type":"paragraph","inlineContent":[{"text":"We will interact mainly via the ","type":"text"},{"identifier":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgtaskscheduler","isActive":true,"type":"reference"},{"text":", which is the interface to all of this intelligent scheduling.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"To create a request, we will create an instance of either "},{"type":"codeVoice","code":"BGProcessingTaskRequest"},{"type":"text","text":" or "},{"type":"codeVoice","code":"BGAppRefreshTaskRequest"},{"type":"text","text":", based on the task."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"When the system is ready to give us time to do the task, the app will be launched (in the background) with a "},{"type":"codeVoice","code":"BGAppRefreshTask"},{"type":"text","text":" \/ "},{"type":"codeVoice","code":"BGAppProcessingTask"},{"type":"text","text":"."}]},{"type":"paragraph","inlineContent":[{"text":"Once we’re done, we will call ","type":"text"},{"isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgtask\/3142236-settaskcompleted","type":"reference"},{"text":" and let the app be suspended.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Based on the tasks we’ve given to the "},{"code":"BGTaskScheduler","type":"codeVoice"},{"type":"text","text":", our app will be given multiple tasks at the same time. However note that the time allotted for this is the same if it was one or multiple tasks."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"All the tasks will be given to the main app, even when the background task was scheduled by an extension"}]},{"level":2,"anchor":"HOW-TO","type":"heading","text":"HOW-TO"},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"text":"We need to have the background mode capability turned on with background fetch\/processing ticked.","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Set the "},{"type":"codeVoice","code":"info.plist"},{"type":"text","text":" keys to tell iOS we support app background task\/refresh. Add a key “Permitted background task scheduler identifiers”  and use an array of strings as the value. This array contains unique strings that our apps must declare, each string declares a different task that the app wants to perform."}]}]},{"content":[{"inlineContent":[{"text":"Go in the app delegate and deal with the task:","type":"text"}],"type":"paragraph"}]}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"import BackgroundTasks"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Register a background task.","type":"text"}],"type":"paragraph"}]}]},{"code":["BGTaskScheduler.shared.register(","\tforTaskWithIdentifier: \"com.colorfeed.refresh\", ","\tusing: nil) { task in ","  self.handleAppRefresh(task: task as! BGAppRefreshTask)","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"text":"Note how the last block of this function is what will be called when the system decides that it’s time to do the task.","type":"text"},{"text":" ","type":"text"},{"text":"Remember to call ","type":"text"},{"code":"task.setTaskCompleted","type":"codeVoice"},{"text":" once it is done.","type":"text"}]},{"start":4,"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Lastly, schedule the task"}]}]}]},{"code":["func scheduleAppRefresh() {","\tlet request =BGAppRefreshTaskRequest(identifier: \"com.colorfeed.refresh\")","\tdo { ","\t \ttry BGTaskScheduler.shared.submit(request) ","\t} catch { ","\t\tprint(\"Could not schedule app refresh: \\(error)\") ","\t}","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"text":"Some cool properties of these requests:","type":"text"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"codeVoice","code":"earliestBeginDate"},{"text":" tells the system to wait at least the time we pass to this method before calling the task","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"requiresNetworkActivity"},{"type":"text","text":" (for processing only) tells the system to wake up our app for the task only if we have connectivity (or if we don’t need connectivity to do our task)"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"code":"requiresExternalPower","type":"codeVoice"},{"text":" tells the system we’re going to do intensive stuff and use lots of resources. Setting this to ","type":"text"},{"code":"true","type":"codeVoice"},{"text":" also disables CPU Monitor, allowing the app to do intensive work with no throttling.","type":"text"}]}]}]},{"level":2,"anchor":"Debugging","type":"heading","text":"Debugging"},{"type":"paragraph","inlineContent":[{"text":"After scheduling the task, we can mock\/force a system call to activate our scheduled task via the debugger with:","type":"text"}]},{"code":["e -l objc -- (void)[[BGTaskScheduler sharedScheduler] _simulateLaunchForTaskWithIdentifier:@\"TASK_IDENTIFIER\"]"],"syntax":null,"type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"(replace "},{"type":"codeVoice","code":"TASK_IDENTIFIER"},{"type":"text","text":" with the task name."}]},{"level":2,"anchor":"Written-By","type":"heading","text":"Written By"},{"type":"row","numberOfColumns":5,"columns":[{"content":[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"zntfdr"}]}],"size":1},{"content":[{"level":3,"type":"heading","anchor":"Federico-Zanetello","text":"Federico Zanetello"},{"type":"paragraph","inlineContent":[{"overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","isActive":true,"overridingTitle":"Contributed Notes","type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/github.com\/zntfdr","isActive":true,"type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/zntfdr.dev","isActive":true,"type":"reference"}]}],"size":4}]},{"type":"paragraph","inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"isActive":true,"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"reference"}]},{"level":2,"anchor":"Related-Sessions","type":"heading","text":"Related Sessions"},{"type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-417-Improving-Battery-Life-and-Performance"],"style":"list"},{"type":"small","inlineContent":[{"inlineContent":[{"text":"Legal Notice","type":"text"}],"type":"strong"}]},{"type":"small","inlineContent":[{"text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved.","type":"text"},{"text":" ","type":"text"},{"text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries.","type":"text"},{"text":" ","type":"text"},{"text":"This website is not made by, affiliated with, nor endorsed by Apple.","type":"text"}]}],"kind":"content"}],"abstract":[{"text":"Background execution is a powerful tool your app can leverage to provide a great user experience. Learn about best practices to follow when running in the background, especially if you use VoIP or silent pushes, and an all-new scheduling API that enables long running processing and maintenance tasks.","type":"text"}],"sampleCodeDownload":{"kind":"sampleDownload","action":{"isActive":true,"identifier":"https:\/\/developer.apple.com\/wwdc19\/707","overridingTitle":"Watch Video (39 min)","type":"reference"}},"references":{"doc://WWDCNotes/documentation/WWDCNotes/WWDC19-417-Improving-Battery-Life-and-Performance":{"role":"sampleCode","url":"\/documentation\/wwdcnotes\/wwdc19-417-improving-battery-life-and-performance","type":"topic","title":"Improving Battery Life and Performance","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-417-Improving-Battery-Life-and-Performance","abstract":[{"text":"Learn about new ways to find and fix performance issues during daily development, beta testing, and public release on the App Store. Learn how to catch performance issues during daily development by measuring CPU, memory, and more in your XCTests. Discover how to find issues in the field during beta testing and public release using MetricKit. See how the Xcode Organizer now displays the most important metrics from your app aggregated from each version on the App Store.","type":"text"}],"kind":"article"},"https://developer.apple.com/wwdc19/707":{"identifier":"https:\/\/developer.apple.com\/wwdc19\/707","url":"https:\/\/developer.apple.com\/wwdc19\/707","type":"download","checksum":null},"https://developer.apple.com/documentation/backgroundtasks/bgtaskscheduler":{"identifier":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgtaskscheduler","title":"BGTaskScheduler","titleInlineContent":[{"code":"BGTaskScheduler","type":"codeVoice"}],"url":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgtaskscheduler","type":"link"},"doc://WWDCNotes/documentation/WWDCNotes":{"url":"\/documentation\/wwdcnotes","abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"title":"WWDC Notes","type":"topic","images":[{"type":"icon","identifier":"WWDCNotes.png"}],"kind":"symbol","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","role":"collection"},"https://developer.apple.com/documentation/uikit/uiapplication/1623031-beginbackgroundtask":{"identifier":"https:\/\/developer.apple.com\/documentation\/uikit\/uiapplication\/1623031-beginbackgroundtask","title":"UIApplication.beginBackgroundTask(expirationHandler:)","titleInlineContent":[{"type":"codeVoice","code":"UIApplication.beginBackgroundTask(expirationHandler:)"}],"url":"https:\/\/developer.apple.com\/documentation\/uikit\/uiapplication\/1623031-beginbackgroundtask","type":"link"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","title":"Contributions are welcome!","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}],"url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"link"},"https://zntfdr.dev":{"identifier":"https:\/\/zntfdr.dev","title":"Blog","titleInlineContent":[{"type":"text","text":"Blog"}],"url":"https:\/\/zntfdr.dev","type":"link"},"WWDC19.jpeg":{"identifier":"WWDC19.jpeg","variants":[{"url":"\/images\/WWDC19.jpeg","traits":["1x","light"]}],"type":"image","alt":null},"WWDC19-Icon.png":{"identifier":"WWDC19-Icon.png","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC19-Icon.png"}],"type":"image","alt":null},"doc://WWDCNotes/documentation/WWDCNotes/WWDC19":{"title":"WWDC19","abstract":[{"text":"Xcode 11, Swift 5.1, iOS 13, macOS 10.15 (Catalina), tvOS 13, watchOS 6.","type":"text"},{"text":" ","type":"text"},{"text":"New APIs: ","type":"text"},{"code":"Combine","type":"codeVoice"},{"text":", ","type":"text"},{"code":"Core Haptics","type":"codeVoice"},{"text":", ","type":"text"},{"code":"Create ML","type":"codeVoice"},{"text":", and more.","type":"text"}],"images":[{"type":"icon","identifier":"WWDC19-Icon.png"},{"type":"card","identifier":"WWDC19.jpeg"}],"type":"topic","role":"collectionGroup","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19","url":"\/documentation\/wwdcnotes\/wwdc19","kind":"article"},"https://developer.apple.com/documentation/backgroundtasks/bgapprefreshtask":{"identifier":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgapprefreshtask","title":"BGAppRefreshTask","titleInlineContent":[{"code":"BGAppRefreshTask","type":"codeVoice"}],"url":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgapprefreshtask","type":"link"},"https://github.com/zntfdr":{"identifier":"https:\/\/github.com\/zntfdr","title":"GitHub","titleInlineContent":[{"type":"text","text":"GitHub"}],"url":"https:\/\/github.com\/zntfdr","type":"link"},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","kind":"article","url":"\/documentation\/wwdcnotes\/zntfdr","images":[{"identifier":"zntfdr.jpeg","type":"card"},{"identifier":"zntfdr.jpeg","type":"icon"}],"role":"sampleCode","title":"Federico Zanetello (332 notes)","type":"topic","abstract":[{"type":"text","text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more."}]},"WWDCNotes.png":{"identifier":"WWDCNotes.png","variants":[{"url":"\/images\/WWDCNotes.png","traits":["1x","light"]}],"type":"image","alt":null},"zntfdr.jpeg":{"identifier":"zntfdr.jpeg","variants":[{"traits":["1x","light"],"url":"\/images\/zntfdr.jpeg"}],"type":"image","alt":null},"https://developer.apple.com/documentation/foundation/processinfo/1617030-performexpiringactivity":{"identifier":"https:\/\/developer.apple.com\/documentation\/foundation\/processinfo\/1617030-performexpiringactivity","title":"ProcessInfo.performExpiringActivity(withReason:using:)","titleInlineContent":[{"code":"ProcessInfo.performExpiringActivity(withReason:using:)","type":"codeVoice"}],"url":"https:\/\/developer.apple.com\/documentation\/foundation\/processinfo\/1617030-performexpiringactivity","type":"link"},"zntfdr":{"identifier":"zntfdr","variants":[{"traits":["1x","light"],"url":"\/images\/zntfdr.jpeg"}],"type":"image","alt":"Profile image of Federico Zanetello"},"https://developer.apple.com/documentation/backgroundtasks/bgtask/3142236-settaskcompleted":{"identifier":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgtask\/3142236-settaskcompleted","title":"setTaskCompleted","titleInlineContent":[{"code":"setTaskCompleted","type":"codeVoice"}],"url":"https:\/\/developer.apple.com\/documentation\/backgroundtasks\/bgtask\/3142236-settaskcompleted","type":"link"}}}