{"kind":"article","schemaVersion":{"major":0,"minor":3,"patch":0},"variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc21-10258-understand-and-eliminate-hangs-from-your-app"],"traits":[{"interfaceLanguage":"swift"}]}],"metadata":{"roleHeading":"WWDC21","title":"Understand and eliminate hangs from your app","role":"sampleCode","modules":[{"name":"WWDC Notes"}]},"sampleCodeDownload":{"kind":"sampleDownload","action":{"identifier":"https:\/\/developer.apple.com\/wwdc21\/10258","overridingTitle":"Watch Video (24 min)","isActive":true,"type":"reference"}},"primaryContentSections":[{"content":[{"type":"heading","text":"Overview","level":2,"anchor":"overview"},{"type":"paragraph","inlineContent":[{"text":"What is a hang?","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"text":"Whenever the app hangs, is unresponsive, lags, slows down, spins, or is just stuck","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"This period of unresponsiveness is called ","type":"text"},{"type":"strong","inlineContent":[{"type":"text","text":"hang"}]}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"What is the app main runloop?","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The main runloop is a loop your application’s main thread enters to run event handlers in response to incoming events, primarily user interactions"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"When a user interacts with an app:","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"the runloop receives the event"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the runloop processes it","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"then the runloop updates the UI, if needed","type":"text"}]}]}],"type":"orderedList"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"this all happens in one turn of the runloop, and on the main thread"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"this process repeats for each user input"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"events are buffered and cannot be handled by the main thread during a hang","type":"text"}]}]}],"type":"unorderedList"},{"type":"heading","text":"What causes a hang?","level":2,"anchor":"What-causes-a-hang"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The high-level cause for hangs is too much work being done on, or on behalf of, the main thread."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"To ensure performance, it’s important the main thread of your application focuses on what’s necessary to update UI","type":"text"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"Common cases:","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"text":"proactive work in the main thread (e.g., reading, preparing and composite more images than necessary","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"performing irrelevant work on the main thread","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"use sub-optimal API (e.g. use CPU instead of GPU for rounding corners of views)"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"network and I\/O on the main thread","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"synchronization on the main thread (locks, semaphores and similar)"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"The main thread services blocks from the main dispatch queue, but it can also service blocks from other queues via dispatch sync:","type":"text"},{"text":"\n","type":"text"},{"text":"anytime a queue dispatch syncs onto another queue, all pending blocks on the other queue have to execute before the newly enqueued one","type":"text"}]},{"type":"heading","text":"How to diagnose hangs?","level":2,"anchor":"How-to-diagnose-hangs"},{"type":"paragraph","inlineContent":[{"text":"During development:","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"text":"The time profiler instrument shows you what the app is executing by showing your application’s callstacks over time","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"The system trace instrument adds more context with data on system calls, VM faults, I\/O, as well as inter and intra-process interactions."}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"On production:","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"use MetricKit, MetricKit returns a call tree by aggregating callstacks taken during a hang","type":"text"}]}]}],"type":"unorderedList"},{"type":"heading","text":"How to eliminate hangs?","level":2,"anchor":"How-to-eliminate-hangs"},{"type":"paragraph","inlineContent":[{"text":"Reduce work on the main thread:","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"optimize work on the main thread, to reduce execution time."}]}]},{"content":[{"inlineContent":[{"type":"text","text":"move work off the main thread in a non-blocking manner to keep it responsive"}],"type":"paragraph"}]}],"type":"orderedList"},{"type":"heading","text":"Caching","level":3,"anchor":"Caching"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"quickly access frequently used assets or previously queried values","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"in-memory store, but can be persisted to disk, if needed across multiple app invocations","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"formatted assets (e.g. images) are great candidates for caching","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"It is important to have an accurate cache invalidation mechanism to strike a balance between having stale data and constantly updating a cache.","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"cache invalidation should happen asynchronously on a secondary dispatch queue to keep the main thread responsive to events"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"codeVoice","code":"NSCache"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"heading","text":"Notification observers","level":3,"anchor":"Notification-observers"},{"items":[{"content":[{"inlineContent":[{"text":"allow your app to react to changes in a value or state, without having to do expensive, on-demand computation","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"to find all observable system notifications, check out the ","type":"text"},{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/foundation\/nsnotification\/name"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"heading","text":"Written By","level":2,"anchor":"Written-By"},{"columns":[{"size":1,"content":[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"zntfdr"}]}]},{"size":4,"content":[{"level":3,"text":"Federico Zanetello","type":"heading","anchor":"Federico-Zanetello"},{"inlineContent":[{"overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"overridingTitle":"Contributed Notes","isActive":true,"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"identifier":"https:\/\/github.com\/zntfdr","type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"identifier":"https:\/\/zntfdr.dev","type":"reference"}],"type":"paragraph"}]}],"type":"row","numberOfColumns":5},{"type":"paragraph","inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}]},{"type":"heading","text":"Related Sessions","level":2,"anchor":"Related-Sessions"},{"items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10248-Analyze-hangs-with-Instruments","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-10082-Track-down-hangs-with-Xcode-and-ondevice-detection","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10087-Diagnose-Power-and-Performance-regressions-in-your-app","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10181-Ultimate-application-performance-survival-guide","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10081-Whats-new-in-MetricKit","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-417-Improving-Battery-Life-and-Performance","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC17-706-Modernizing-Grand-Central-Dispatch-Usage","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC16-418-Using-Time-Profiler-in-Instruments"],"type":"links","style":"list"},{"type":"small","inlineContent":[{"type":"strong","inlineContent":[{"text":"Legal Notice","type":"text"}]}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}],"kind":"content"}],"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10258-Understand-and-eliminate-hangs-from-your-app","interfaceLanguage":"swift"},"sections":[],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"abstract":[{"text":"Discover how you can track down hangs and delays in your app. We’ll show you tools and methods to discover hangs and their causes, learn about anti-patterns that can lead to hangs, explore best practices for eliminating hangs like GCD, and provide guidance on when you should consider asynchronous code to improve your app performance.","type":"text"}],"references":{"doc://WWDCNotes/documentation/WWDCNotes/WWDC16-418-Using-Time-Profiler-in-Instruments":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC16-418-Using-Time-Profiler-in-Instruments","title":"Using Time Profiler in Instruments","abstract":[{"text":"Learn how to make your apps faster and more efficient in this introduction to Time Profiler in Instruments. Walk through how to use Time Profiler to measure your app’s performance. Learn how Time Profiler works and can be used to identify problems and verify your fixes. Discover how easy it is to improve your app’s power usage and performance by using Instruments throughout your development process.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc16-418-using-time-profiler-in-instruments","role":"sampleCode","kind":"article"},"doc://WWDCNotes/documentation/WWDCNotes":{"kind":"symbol","abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"role":"collection","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","type":"topic","url":"\/documentation\/wwdcnotes","title":"WWDC Notes"},"https://developer.apple.com/documentation/foundation/nsnotification/name":{"type":"link","title":"NSNotification.Name documentation","titleInlineContent":[{"code":"NSNotification.Name","type":"codeVoice"},{"text":" documentation","type":"text"}],"identifier":"https:\/\/developer.apple.com\/documentation\/foundation\/nsnotification\/name","url":"https:\/\/developer.apple.com\/documentation\/foundation\/nsnotification\/name"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC17-706-Modernizing-Grand-Central-Dispatch-Usage":{"kind":"article","type":"topic","title":"Modernizing Grand Central Dispatch Usage","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC17-706-Modernizing-Grand-Central-Dispatch-Usage","url":"\/documentation\/wwdcnotes\/wwdc17-706-modernizing-grand-central-dispatch-usage","role":"sampleCode","abstract":[{"text":"macOS 10.13 and iOS 11 have reinvented how Grand Central Dispatch and the Darwin kernel collaborate, enabling your applications to run concurrent workloads more efficiently. Learn how to modernize your code to take advantage of these improvements and make optimal use of hardware resources.","type":"text"}]},"WWDC21.jpeg":{"alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC21.jpeg"}],"identifier":"WWDC21.jpeg"},"zntfdr":{"alt":"Profile image of Federico Zanetello","type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/zntfdr.jpeg"}],"identifier":"zntfdr"},"WWDCNotes.png":{"alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes.png"}],"identifier":"WWDCNotes.png"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"title":"WWDC21","kind":"article","type":"topic","url":"\/documentation\/wwdcnotes\/wwdc21","role":"collectionGroup","images":[{"identifier":"WWDC21-Icon.png","type":"icon"},{"identifier":"WWDC21.jpeg","type":"card"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21","abstract":[{"type":"text","text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"MusicKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"DocC"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit 2"},{"type":"text","text":", and more."}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC19-417-Improving-Battery-Life-and-Performance":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC19-417-Improving-Battery-Life-and-Performance","url":"\/documentation\/wwdcnotes\/wwdc19-417-improving-battery-life-and-performance","type":"topic","title":"Improving Battery Life and Performance","role":"sampleCode","abstract":[{"type":"text","text":"Learn about new ways to find and fix performance issues during daily development, beta testing, and public release on the App Store. Learn how to catch performance issues during daily development by measuring CPU, memory, and more in your XCTests. Discover how to find issues in the field during beta testing and public release using MetricKit. See how the Xcode Organizer now displays the most important metrics from your app aggregated from each version on the App Store."}],"kind":"article"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10087-Diagnose-Power-and-Performance-regressions-in-your-app":{"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10087-diagnose-power-and-performance-regressions-in-your-app","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10087-Diagnose-Power-and-Performance-regressions-in-your-app","type":"topic","title":"Diagnose Power and Performance regressions in your app","abstract":[{"text":"Quickly discover how to identify priorities when viewing power and performance regressions. Learn how to track metrics that have regressed with device-and percentile-specific information, so you can focus your efforts on optimization and save valuable development time. We’ll also show you how to track down common anti-patterns in your app that wear out device storage, help you customize your workflows, and add App Store Connect APIs to help you stay up to date on your app’s real-world performance.","type":"text"}]},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","url":"\/documentation\/wwdcnotes\/zntfdr","kind":"article","title":"Federico Zanetello (332 notes)","abstract":[{"type":"text","text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more."}],"images":[{"type":"card","identifier":"zntfdr.jpeg"},{"type":"icon","identifier":"zntfdr.jpeg"}]},"https://github.com/zntfdr":{"type":"link","title":"GitHub","titleInlineContent":[{"text":"GitHub","type":"text"}],"identifier":"https:\/\/github.com\/zntfdr","url":"https:\/\/github.com\/zntfdr"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-10082-Track-down-hangs-with-Xcode-and-ondevice-detection":{"url":"\/documentation\/wwdcnotes\/wwdc22-10082-track-down-hangs-with-xcode-and-ondevice-detection","abstract":[{"text":"Learn how you can increase responsiveness and eliminate hangs in your app and make even better experiences. Hang out with the Performance Tools team as we explore how you can track down these issues — and even stop them from occurring in the first place. We’ll take you through the latest detection mechanisms for iOS to help track hangs during pre-release testing, show you how to identify issues in release builds using the Xcode Organizer, and more.","type":"text"}],"role":"sampleCode","title":"Track down hangs with Xcode and on-device detection","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-10082-Track-down-hangs-with-Xcode-and-ondevice-detection","kind":"article"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10181-Ultimate-application-performance-survival-guide":{"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10181-Ultimate-application-performance-survival-guide","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10181-ultimate-application-performance-survival-guide","abstract":[{"type":"text","text":"Performance optimization can seem like a daunting task — with many metrics to track and tools to use. Fear not: Our survival guide to app performance is here to help you understand tooling, metrics, and paradigms that can help smooth your development process and contribute to a great experience for people using your app."}],"title":"Ultimate application performance survival guide","role":"sampleCode"},"zntfdr.jpeg":{"alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/zntfdr.jpeg"}],"identifier":"zntfdr.jpeg"},"WWDC21-Icon.png":{"alt":null,"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDC21-Icon.png"}],"identifier":"WWDC21-Icon.png"},"https://zntfdr.dev":{"type":"link","title":"Blog","titleInlineContent":[{"text":"Blog","type":"text"}],"identifier":"https:\/\/zntfdr.dev","url":"https:\/\/zntfdr.dev"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"type":"link","title":"Contributions are welcome!","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}],"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10081-Whats-new-in-MetricKit":{"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc20-10081-whats-new-in-metrickit","type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10081-Whats-new-in-MetricKit","abstract":[{"type":"text","text":"Quickly detect power and performance regressions and troubleshoot app issues when you adopt MetricKit. Discover the latest trackable metrics for your app, including CPU instructions, animation hitches, and exit reasons. And learn about diagnostics in MetricKit that can help you troubleshoot hangs, crashes, and disk writes."}],"title":"What’s new in MetricKit"},"https://developer.apple.com/wwdc21/10258":{"checksum":null,"type":"download","identifier":"https:\/\/developer.apple.com\/wwdc21\/10258","url":"https:\/\/developer.apple.com\/wwdc21\/10258"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10248-Analyze-hangs-with-Instruments":{"kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10248-Analyze-hangs-with-Instruments","url":"\/documentation\/wwdcnotes\/wwdc23-10248-analyze-hangs-with-instruments","abstract":[{"type":"text","text":"User interface elements often mimic real-world interactions, including real-time responses. Apps with a noticeable delay in user interaction — a hang — can break that illusion and create frustration. We’ll show you how to use Instruments to analyze, understand, and fix hangs in your apps on all Apple platforms. Discover how you can efficiently navigate an Instruments trace document, interpret trace data, and record additional profiling data to better understand your specific hang."}],"role":"sampleCode","title":"Analyze hangs with Instruments"}}}