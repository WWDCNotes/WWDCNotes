{"schemaVersion":{"major":0,"minor":3,"patch":0},"primaryContentSections":[{"content":[{"anchor":"overview","type":"heading","text":"Overview","level":2},{"type":"paragraph","inlineContent":[{"type":"text","text":"Speaker: Julian Yu, Core Audio"}]},{"text":"Voice Processing APIs","type":"heading","level":2,"anchor":"Voice-Processing-APIs"},{"type":"paragraph","inlineContent":[{"text":"Both APIs provides the same voice processing capabilities.","type":"text"}]},{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"NEW:","type":"text"}],"type":"strong"},{"text":" Voice processing now available on tvOS","type":"text"}]},{"inlineContent":[{"type":"emphasis","inlineContent":[{"type":"text","text":"See more in the session ‚ÄúDiscover Continuity Camera on tvOS‚Äù."}]}],"type":"paragraph"},{"level":3,"anchor":"AUVoiceIO-aka-AUVoiceProcessingIO","text":"AUVoiceIO (aka AUVoiceProcessingIO)","type":"heading"},{"inlineContent":[{"text":"For apps that interact with I\/O audio unit directly","type":"text"}],"type":"paragraph"},{"level":3,"anchor":"AVAudioEngine","text":"AVAudioEngine","type":"heading"},{"inlineContent":[{"text":"Higher-level API, easier to use, less code","type":"text"}],"type":"paragraph"},{"level":2,"anchor":"New-APIs","text":"New APIs","type":"heading"},{"inlineContent":[{"text":"AUVoiceIO and AVAudioEngine get new API to provide more controls over voice processing.","type":"text"}],"type":"paragraph"},{"level":3,"anchor":"Ducking-behavior","text":"Ducking behavior","type":"heading"},{"name":"Note","content":[{"inlineContent":[{"text":"There also could be other apps playing audio at the same time as your app. All the audio streams other than the voice audio stream from your app are considered as ‚Äúother audio‚Äù by Apple‚Äôs voice processing, and your voice audio gets mixed in with other audio before getting played to the output device. For voice chat apps, typically the primary focus of the playback audio is the voice chat audio. That‚Äôs why we duck the volume level of other audio, in order improve the intelligibility of the voice audio. In the past, we applied a fixed amount of ducking to other audio. This has worked well for most apps, and if your app is happy with the current ducking behavior, then you don‚Äôt need to do anything.","type":"text"}],"type":"paragraph"}],"type":"aside","style":"note"},{"inlineContent":[{"text":"When enable advanced ducking a ducking level can be set. There is default (the current behavior), minimum, medium and maximum, where maximum lowers the other apps playing audio the most.","type":"text"}],"type":"paragraph"},{"level":4,"anchor":"Enabling-it-with-AUVoiceIO","text":"Enabling it with AUVoiceIO","type":"heading"},{"code":["const AUVoiceIOOtherAudioDuckingConfiguration duckingConfig = {","\t.mEnableAdvancedDucking = true,","\t.mDuckingLevel = AUVoiceIOOtherAudioDuckingLevel::kAUVoiceIOOtherAudioDuckingLevelMin","};","\/\/ AUVoiceIO creation code omitted","OSStatus err = AudioUnitSetProperty(auVoiceIO, kAUVoiceIOProperty_OtherAudioDuckingConfiguration, kAudioUnitScope_Global, 0, &duckingConfig, sizeof(duckingConfig));"],"type":"codeListing","syntax":"swift"},{"level":4,"anchor":"Enabling-it-with-AVAudioEngine","text":"Enabling it with AVAudioEngine","type":"heading"},{"code":["let engine = AVAudioEngine()","let inputNode = engine.inputNode","do {","\ttry inputNode.setVoiceProcessingEnabled(true)","} catch {","\tprint(\"Could not enable voice processing \\(error)\")","}","let duckingConfig = AVAudioVoiceProcessingOtherAudioDuckingConfiguration(mEnableAdvancedDucking: false, mDuckingLevel: .max)","inputNode.voiceProcessingOtherAudioDuckingConfiguration = duckingConfig"],"type":"codeListing","syntax":"swift"},{"level":3,"anchor":"Detect-muted-speakers","text":"Detect muted speakers","type":"heading"},{"inlineContent":[{"text":"There is an API to detect presence of a muted talker","type":"text"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"It was first introduced in iOS 15, and now available in macOS 14 and tvOS 17."}],"type":"paragraph"},{"level":4,"anchor":"How-to-use-the-API","text":"How to use the API","type":"heading"},{"items":[{"content":[{"inlineContent":[{"text":"Provide a listener block to receive the notification of muted talker detection","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Implement your handling of this notification in your listener block","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Implement mute via the mute API"}]}]}],"type":"orderedList"},{"level":4,"anchor":"Using-it-with-AUVoiceIO","text":"Using it with AUVoiceIO","type":"heading"},{"code":["UVoiceIOMutedSpeechActivityEventListener listener = ","^(AUVoiceIOMutedSpeechActivityEvent event) {\t\t","    if (event == kAUVoiceIOSpeechActivityHasStarted) {","\t\t\/\/ User has started talking while muted. Prompt the user to un-mute","\t} else if (event == kAUVoiceIOSpeechActivityHasEnded) {","\t\t\/\/ User has stopped talking while muted","\t}","};","OSStatus err = AudioUnitSetProperty(auVoiceIO, kAUVoiceIOProperty_MutedSpeechActivityEventListener, kAudioUnitScope_Global, 0, &listener,  sizeof(AUVoiceIOMutedSpeechActivityEventListener));","\/\/ When user mutes","UInt32 muteUplinkOutput = 1;","result = AudioUnitSetProperty(auVoiceIO, kAUVoiceIOProperty_MuteOutput, kAudioUnitScope_Global, 0, &muteUplinkOutput, sizeof(muteUplinkOutput));"],"type":"codeListing","syntax":"swift"},{"level":4,"anchor":"Using-it-with-AVAudioEngine","text":"Using it with AVAudioEngine","type":"heading"},{"code":["let listener =  { (event : AVAudioVoiceProcessingSpeechActivityEvent) in","\tif (event == AVAudioVoiceProcessingSpeechActivityEvent.started) {","\t\t\/\/ User has started talking while muted. Prompt the user to un-mute","\t} else if (event == AVAudioVoiceProcessingSpeechActivityEvent.ended) {","\t\t\/\/ User has stopped talking while muted","\t}","}","inputNode.setMutedSpeechActivityEventListener(listener)","\/\/ When user mutes","inputNode.isVoiceProcessingInputMuted = true"],"type":"codeListing","syntax":"swift"},{"level":4,"anchor":"Alternative-macOS-APIs-if-not-ready-for-the-new-one","text":"Alternative macOS APIs (if not ready for the new one)","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Enable voice activity detection on input device via "},{"code":"kAudioDevicePropertyVoiceActivityDetectionEnable","type":"codeVoice"},{"type":"text","text":"."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Register a listener callback on HAL property "},{"code":"kAudioDevicePropertyVoiceActivityDetectionState","type":"codeVoice"},{"type":"text","text":"."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"When notified, query ","type":"text"},{"code":"kAudioDevicePropertyVoiceActivityDetectionState","type":"codeVoice"},{"text":" for its current value","type":"text"}]}]}],"type":"orderedList"},{"code":["\/\/ Enable Voice Activity Detection on the input device","const AudioObjectPropertyAddress kVoiceActivityDetectionEnable{","        kAudioDevicePropertyVoiceActivityDetectionEnable,","        kAudioDevicePropertyScopeInput,","        kAudioObjectPropertyElementMain };","OSStatus status = kAudioHardwareNoError;","UInt32 shouldEnable = 1;","status = AudioObjectSetPropertyData(deviceID, &kVoiceActivityDetectionEnable, 0, NULL, sizeof(UInt32), &shouldEnable);","\/\/ Register a listener on the Voice Activity Detection State property","const AudioObjectPropertyAddress kVoiceActivityDetectionState{","        kAudioDevicePropertyVoiceActivityDetectionState,","        kAudioDevicePropertyScopeInput,","        kAudioObjectPropertyElementMain };","status = AudioObjectAddPropertyListener(deviceID, &kVoiceActivityDetectionState, (AudioObjectPropertyListenerProc)listener_callback, NULL); \/\/ ‚Äúlistener_callback‚Äù is the name of your listener function"],"type":"codeListing","syntax":"swift"},{"code":["OSStatus listener_callback(","    AudioObjectID                 inObjectID,","    UInt32                        inNumberAddresses,","    const AudioObjectPropertyAddress*   __nullable inAddresses,","    void* __nullable              inClientData)","{","  \/\/ Assuming this is the only property we are listening for, therefore no need to go through inAddresses","       UInt32 voiceDetected = 0;","     UInt32 propertySize = sizeof(UInt32);","     OSStatus status = AudioObjectGetPropertyData(inObjectID, &kVoiceActivityState, 0, NULL, &propertySize, &voiceDetected);","  ","       if (kAudioHardwareNoError == status) {"," if (voiceDetected == 1) {","    \/\/ voice activity detected","\t} else if (voiceDetected == 0) {","\t\t    \/\/ voice activity not detected","\t}"," }"," return status;","};"],"type":"codeListing","syntax":"swift"},{"name":"Note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"For HAL API clients to implement mute we highly recommend using HAL‚Äôs process mute API. It suppresses the recording indicator light in the menu bar, and gives user confidence that their privacy is protected under mute."}]}],"type":"aside","style":"note"},{"level":2,"anchor":"Written-By","text":"Written By","type":"heading"},{"type":"row","columns":[{"size":1,"content":[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"MortenGregersen"}]}]},{"size":4,"content":[{"anchor":"Morten-Bjerg-Gregersen","type":"heading","level":3,"text":"Morten Bjerg Gregersen"},{"type":"paragraph","inlineContent":[{"overridingTitle":"Contributed Notes","overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"isActive":true,"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/MortenGregersen","type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"identifier":"https:\/\/github.com\/MortenGregersen","type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"identifier":"https:\/\/x.com\/mortengregersen","type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"identifier":"http:\/\/atterdagapps.com","type":"reference"}]}]}],"numberOfColumns":5},{"inlineContent":[{"type":"text","text":"Missing anything? Corrections? "},{"type":"reference","isActive":true,"identifier":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing"}],"type":"paragraph"},{"level":2,"anchor":"Related-Sessions","text":"Related Sessions","type":"heading"},{"items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10233-Enhance-your-apps-audio-experience-with-AirPods","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10256-Discover-Continuity-Camera-for-tvOS"],"type":"links","style":"list"},{"inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Legal Notice"}]}],"type":"small"},{"inlineContent":[{"type":"text","text":"All content copyright ¬© 2012 ‚Äì 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}],"type":"small"}],"kind":"content"}],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10235-Whats-new-in-voice-processing"},"abstract":[{"type":"text","text":"Learn how to use the Apple voice processing APIs to achieve the best possible audio experience in your VoIP apps. We‚Äôll show you how to detect when someone is talking while muted, adjust ducking behavior of other audio, and more."}],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc23-10235-whats-new-in-voice-processing"]}],"sections":[],"sampleCodeDownload":{"kind":"sampleDownload","action":{"identifier":"https:\/\/developer.apple.com\/wwdc23\/10235","isActive":true,"overridingTitle":"Watch Video (15 min)","type":"reference"}},"kind":"article","hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23"]]},"metadata":{"title":"What‚Äôs new in voice processing","roleHeading":"WWDC23","role":"sampleCode","modules":[{"name":"WWDC Notes"}]},"references":{"WWDC23-Icon.png":{"alt":null,"variants":[{"url":"\/images\/WWDC23-Icon.png","traits":["1x","light"]}],"type":"image","identifier":"WWDC23-Icon.png"},"doc://WWDCNotes/documentation/WWDCNotes":{"type":"topic","title":"WWDC Notes","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"kind":"symbol","url":"\/documentation\/wwdcnotes","role":"collection"},"MortenGregersen.jpeg":{"alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/MortenGregersen.jpeg"}],"type":"image","identifier":"MortenGregersen.jpeg"},"https://github.com/MortenGregersen":{"type":"link","identifier":"https:\/\/github.com\/MortenGregersen","titleInlineContent":[{"text":"GitHub","type":"text"}],"title":"GitHub","url":"https:\/\/github.com\/MortenGregersen"},"https://x.com/mortengregersen":{"type":"link","identifier":"https:\/\/x.com\/mortengregersen","titleInlineContent":[{"type":"text","text":"X\/Twitter"}],"title":"X\/Twitter","url":"https:\/\/x.com\/mortengregersen"},"https://wwdcnotes.github.io/WWDCNotes/documentation/wwdcnotes/contributing":{"type":"link","identifier":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}],"title":"Contributions are welcome!","url":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing"},"https://developer.apple.com/wwdc23/10235":{"type":"download","identifier":"https:\/\/developer.apple.com\/wwdc23\/10235","checksum":null,"url":"https:\/\/developer.apple.com\/wwdc23\/10235"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10233-Enhance-your-apps-audio-experience-with-AirPods":{"kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10233-Enhance-your-apps-audio-experience-with-AirPods","title":"Enhance your app‚Äôs audio experience with AirPods","role":"sampleCode","abstract":[{"text":"Discover how you can create transformative audio experiences in your app using AirPods. Learn how to incorporate AirPods Automatic Switching, use AVAudioApplication to support Mute Control, and take advantage of Spatial Audio to create immersive soundscapes in your app or game.","type":"text"}],"url":"\/documentation\/wwdcnotes\/wwdc23-10233-enhance-your-apps-audio-experience-with-airpods","type":"topic"},"MortenGregersen":{"alt":"Profile image of Morten Bjerg Gregersen","variants":[{"traits":["1x","light"],"url":"\/images\/MortenGregersen.jpeg"}],"identifier":"MortenGregersen","type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/MortenGregersen":{"abstract":[{"type":"text","text":"Hi üëã I am Morten - I live in Denmark üá©üá∞"}],"title":"Morten Bjerg Gregersen (21 notes)","images":[{"identifier":"MortenGregersen.jpeg","type":"card"},{"identifier":"MortenGregersen.jpeg","type":"icon"}],"kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/MortenGregersen","url":"\/documentation\/wwdcnotes\/mortengregersen","role":"sampleCode"},"http://atterdagapps.com":{"title":"Blog","url":"http:\/\/atterdagapps.com","identifier":"http:\/\/atterdagapps.com","titleInlineContent":[{"type":"text","text":"Blog"}],"type":"link"},"WWDC23.jpeg":{"alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDC23.jpeg"}],"identifier":"WWDC23.jpeg","type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23":{"abstract":[{"type":"text","text":"Xcode 15, Swift 5.9, iOS 17, macOS 14 (Sonoma), tvOS 17, visionOS 1, watchOS 10."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"code":"SwiftData","type":"codeVoice"},{"type":"text","text":", "},{"type":"codeVoice","code":"Observation"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit"},{"type":"text","text":" views, and more."}],"title":"WWDC23","images":[{"type":"icon","identifier":"WWDC23-Icon.png"},{"type":"card","identifier":"WWDC23.jpeg"}],"kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23","url":"\/documentation\/wwdcnotes\/wwdc23","role":"collectionGroup"},"WWDCNotes.png":{"alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes.png"}],"identifier":"WWDCNotes.png","type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10256-Discover-Continuity-Camera-for-tvOS":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10256-Discover-Continuity-Camera-for-tvOS","url":"\/documentation\/wwdcnotes\/wwdc23-10256-discover-continuity-camera-for-tvos","title":"Discover Continuity Camera for tvOS","type":"topic","role":"sampleCode","abstract":[{"type":"text","text":"Discover how you can bring AVFoundation, AVFAudio, and AudioToolbox to your apps on tvOS and create camera and microphone experiences for the living room. Find out how to support tvOS in your existing iOS camera experience with the Device Discovery API, build apps that use iPhone as a webcam or FaceTime source, and explore special considerations when developing for tvOS. We‚Äôll also show you how to enable audio recording for tvOS, and how to use echo cancellation to create great voice-driven experiences."}],"kind":"article"}}}