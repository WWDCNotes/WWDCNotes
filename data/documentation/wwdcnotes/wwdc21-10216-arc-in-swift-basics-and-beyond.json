{"schemaVersion":{"minor":3,"patch":0,"major":0},"kind":"article","abstract":[{"type":"text","text":"Learn about the basics of object lifetimes and ARC in Swift. Dive deep into what language features make object lifetimes observable, consequences of relying on observed object lifetimes and some safe techniques to fix them."}],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10216-ARC-in-Swift-Basics-and-beyond"},"primaryContentSections":[{"content":[{"level":2,"text":"Overview","type":"heading","anchor":"overview"},{"items":[{"content":[{"inlineContent":[{"text":"prefer value types to avoid the dangers of unintended sharing that comes with reference types","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":2,"text":"Object lifetimes and ARC","type":"heading","anchor":"Object-lifetimes-and-ARC"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"An object’s lifetime in Swift begins at initialization (","type":"text"},{"type":"codeVoice","code":"init()"},{"type":"text","text":") and ends at last use"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"ARC automatically manages memory, by deallocating an object after its lifetime ends"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"ARC determines an object’s lifetime by keeping track of its reference counts"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"ARC is mainly driven by the Swift compiler which inserts retain and release operations","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"At runtime, retain increments the reference count and release decrements it"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"When the reference count drops to zero, the object will be deallocated","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":2,"text":"Example","type":"heading","anchor":"Example"},{"type":"paragraph","inlineContent":[{"text":"Let’s say that we have the following code:","type":"text"}]},{"syntax":"swift","code":["class Traveler {","  var name: String","  var destination: String?","}","","func test() {","  let traveler1 = Traveler(name: \"Lily\")","  let traveler2 = traveler1","  traveler2.destination = \"Big Sur\"","  print(\"Done traveling\")","}"],"type":"codeListing"},{"type":"paragraph","inlineContent":[{"text":"In ","type":"text"},{"code":"test()","type":"codeVoice"},{"text":", first, a ","type":"text"},{"code":"Traveler","type":"codeVoice"},{"text":" object is created, then its reference is copied, and finally, its destination is updated","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"In order to automatically manage the memory of the "},{"type":"codeVoice","code":"Traveler"},{"type":"text","text":" object, the Swift compiler inserts:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"a ","type":"text"},{"text":"retain","type":"text"},{"text":" operation when a reference begins","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"a "},{"type":"text","text":"release"},{"type":"text","text":" operation after the last use of the reference"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Note how in "},{"type":"codeVoice","code":"test()"},{"type":"text","text":":"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"code":"traveler1","type":"codeVoice"},{"type":"text","text":" is the first reference to the "},{"code":"Traveler","type":"codeVoice"},{"type":"text","text":" object, and its last use is the copy"}]}]},{"content":[{"inlineContent":[{"type":"codeVoice","code":"traveler2"},{"type":"text","text":" is another reference to the "},{"type":"codeVoice","code":"Traveler"},{"type":"text","text":" object, and its last use is the destination update"}],"type":"paragraph"}]}],"type":"orderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"In "},{"type":"codeVoice","code":"test()"},{"type":"text","text":"’s body the Swift compiler:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"inserts a "},{"type":"text","text":"release"},{"type":"text","text":" operation immediately after the last use of the "},{"type":"codeVoice","code":"traveler1"},{"type":"text","text":" reference"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"it does "},{"type":"strong","inlineContent":[{"text":"not","type":"text"}]},{"type":"text","text":" insert a "},{"type":"text","text":"retain"},{"type":"text","text":" operation when the reference begins, because initialization sets the reference count to "},{"type":"text","text":"1"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"inserts a ","type":"text"},{"text":"retain","type":"text"},{"text":" operation when the ","type":"text"},{"code":"traveler2","type":"codeVoice"},{"text":" reference begins","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"inserts a "},{"type":"text","text":"release"},{"type":"text","text":" operation immediately after the last use of the "},{"type":"codeVoice","code":"traveler2"},{"type":"text","text":" reference"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"identifier":"WWDC21-10216-compile-time","type":"image"}]},{"type":"paragraph","inlineContent":[{"text":"Let’s step through the code and see what happens at runtime:","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"text":"the ","type":"text"},{"code":"Traveler","type":"codeVoice"},{"text":" object is created on the heap and initialized with a reference count of ","type":"text"},{"text":"1","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"in preparation of the new ","type":"text"},{"code":"traveler2","type":"codeVoice"},{"text":" reference, the ","type":"text"},{"text":"retain","type":"text"},{"text":" operation (added by the compiler) executes, incrementing the reference count to ","type":"text"},{"text":"2","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"after the last use of the "},{"code":"traveler1","type":"codeVoice"},{"type":"text","text":" reference, the "},{"type":"text","text":"release"},{"type":"text","text":" operation executes, decrementing the reference count to "},{"type":"text","text":"1"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"after the last use of the "},{"type":"codeVoice","code":"traveler2"},{"type":"text","text":" reference, the "},{"type":"text","text":"release"},{"type":"text","text":" operation executes, decrementing the reference count to "},{"type":"text","text":"0"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Once the reference count drops to zero, the object can be deallocated","type":"text"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC21-10216-runtime"}]},{"level":2,"text":"Observable object lifetimes","type":"heading","anchor":"Observable-object-lifetimes"},{"items":[{"content":[{"inlineContent":[{"text":"Object lifetimes in Swift are use-based","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"An object’s guaranteed ","type":"text"},{"type":"emphasis","inlineContent":[{"type":"text","text":"minimum"}]},{"text":" lifetime begins at initialization and ends at last use","type":"text"}]}]}],"type":"unorderedList"},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"This is different from languages like C++, in which an object’s lifetime is guaranteed to end at the closing brace"}]}],"style":"note","type":"aside","name":"Note"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"in the example above, we saw the object was deallocated immediately after the last use, however, in practice, object lifetimes are determined by the retain and release operations inserted by the Swift compiler"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"depending on the ARC optimizations, the observed object lifetimes may differ from their guaranteed minimum, ending beyond the last use of the object","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"text":"In such cases, the object is deallocated at a program point beyond its last use","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"level":2,"text":"Deinitialization side effects","type":"heading","anchor":"Deinitialization-side-effects"},{"type":"paragraph","inlineContent":[{"type":"text","text":"In most cases, it doesn’t matter what the exact lifetime of an object is. However, with language features like "},{"type":"codeVoice","code":"weak"},{"type":"text","text":" and "},{"type":"codeVoice","code":"unowned"},{"type":"text","text":" references and deinitializer side effects, it is possible to observe object lifetimes:"}]},{"items":[{"content":[{"inlineContent":[{"text":"if you have programs that rely on observed object lifetimes instead of guaranteed object lifetimes, you can end up with problems in the future","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"because relying on observed object lifetimes may work today, but it is only a coincidence","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Observed object lifetimes are an emergent property of the Swift compiler and "},{"type":"strong","inlineContent":[{"text":"can change as implementation details change","type":"text"}]}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":2,"text":"Safe techniques for using `weak` and `unowned` references","type":"heading","anchor":"Safe-techniques-for-using-weak-and-unowned-references"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Swift’s ","type":"text"},{"code":"withExtendedLifetime()","type":"codeVoice"},{"text":" - explicitly extends the lifetime of an object","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"With this approach, you should ensure "},{"type":"codeVoice","code":"withExtendedLifetime()"},{"type":"text","text":" is used every time a weak reference has a potential to cause bugs"}]}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Redesign to access via "},{"type":"codeVoice","code":"strong"},{"type":"text","text":" reference"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Redesign to avoid "},{"type":"codeVoice","code":"weak"},{"type":"text","text":"\/"},{"type":"codeVoice","code":"unowned"},{"type":"text","text":" reference"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Reference cycles can often be avoided by rethinking algorithms and transforming cyclic class relationships to tree structures."}]},{"type":"paragraph","inlineContent":[{"text":"Avoiding the need for weak and unowned references may have additional implementation cost, but this is a definite way to eliminate all potential object lifetime bugs.","type":"text"}]},{"level":2,"text":"Safe techniques for using deinitializer side-effects","type":"heading","anchor":"Safe-techniques-for-using-deinitializer-side-effects"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Swift’s "},{"type":"codeVoice","code":"withExtendedLifetime()"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Redesign to limit visibility of internal class details"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Redesign to avoid deinitializer side-effects (e.g., use ","type":"text"},{"type":"codeVoice","code":"defer"},{"text":" instead of ","type":"text"},{"type":"codeVoice","code":"deinit"},{"text":")","type":"text"}]}]}],"type":"unorderedList"},{"level":2,"text":"Optimize Object Lifetimes","type":"heading","anchor":"Optimize-Object-Lifetimes"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"New in Xcode 13, a new experimental "},{"type":"text","text":"Optimize Object Lifetimes"},{"type":"text","text":" build setting is available for the Swift compiler"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"This enables powerful lifetime shortening ARC optimizations"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"With this build setting turned on, you may see objects being deallocated immediately after last use much more consistently, bringing observed object lifetimes closer to their guaranteed minimum"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"This may expose hidden object lifetime bugs"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":2,"text":"Written By","type":"heading","anchor":"Written-By"},{"columns":[{"content":[{"inlineContent":[{"identifier":"zntfdr","type":"image"}],"type":"paragraph"}],"size":1},{"content":[{"level":3,"type":"heading","text":"Federico Zanetello","anchor":"Federico-Zanetello"},{"type":"paragraph","inlineContent":[{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","isActive":true,"type":"reference","overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"overridingTitle":"Contributed Notes"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/github.com\/zntfdr","isActive":true,"type":"reference"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/zntfdr.dev","isActive":true,"type":"reference"}]}],"size":4}],"numberOfColumns":5,"type":"row"},{"type":"thematicBreak"},{"type":"paragraph","inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"type":"reference","isActive":true,"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}]},{"level":2,"text":"Related Sessions","type":"heading","anchor":"Related-Sessions"},{"type":"small","inlineContent":[{"inlineContent":[{"type":"text","text":"Legal Notice"}],"type":"strong"}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2025 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}],"kind":"content"}],"sampleCodeDownload":{"action":{"type":"reference","overridingTitle":"Watch Video (20 min)","isActive":true,"identifier":"https:\/\/developer.apple.com\/wwdc21\/10216"},"kind":"sampleDownload"},"variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc21-10216-arc-in-swift-basics-and-beyond"],"traits":[{"interfaceLanguage":"swift"}]}],"metadata":{"role":"sampleCode","roleHeading":"WWDC21","title":"ARC in Swift: Basics and beyond","modules":[{"name":"WWDC Notes"}]},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"sections":[],"references":{"https://zntfdr.dev":{"title":"Blog","titleInlineContent":[{"text":"Blog","type":"text"}],"url":"https:\/\/zntfdr.dev","type":"link","identifier":"https:\/\/zntfdr.dev"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"url":"\/documentation\/wwdcnotes\/wwdc21","title":"WWDC21","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21","type":"topic","abstract":[{"type":"text","text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"MusicKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"DocC"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit 2"},{"type":"text","text":", and more."}],"kind":"article","role":"collectionGroup","images":[{"type":"icon","identifier":"WWDC21-Icon.png"},{"type":"card","identifier":"WWDC21.jpeg"}]},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"url":"\/documentation\/wwdcnotes\/zntfdr","type":"topic","title":"Federico Zanetello (332 notes)","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","abstract":[{"text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more.","type":"text"}],"kind":"article","images":[{"type":"card","identifier":"zntfdr.jpeg"},{"type":"icon","identifier":"zntfdr.jpeg"}]},"WWDC21-10216-compile-time":{"alt":null,"identifier":"WWDC21-10216-compile-time","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21-10216-compile-time.gif"}],"type":"image"},"WWDC21-10216-runtime":{"alt":null,"type":"image","identifier":"WWDC21-10216-runtime","variants":[{"url":"\/images\/WWDCNotes\/WWDC21-10216-runtime.gif","traits":["1x","light"]}]},"zntfdr.jpeg":{"alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/zntfdr.jpeg"}],"type":"image","identifier":"zntfdr.jpeg"},"WWDC21.jpeg":{"alt":null,"identifier":"WWDC21.jpeg","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21.jpeg"}],"type":"image"},"WWDC21-Icon.png":{"alt":null,"type":"image","identifier":"WWDC21-Icon.png","variants":[{"url":"\/images\/WWDCNotes\/WWDC21-Icon.png","traits":["1x","light"]}]},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"title":"Contributions are welcome!","titleInlineContent":[{"text":"Contributions are welcome!","type":"text"}],"url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"link","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"doc://WWDCNotes/documentation/WWDCNotes":{"kind":"symbol","title":"WWDC Notes","type":"topic","images":[{"type":"icon","identifier":"WWDCNotes.png"}],"abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","url":"\/documentation\/wwdcnotes","role":"collection"},"zntfdr":{"alt":"Profile image of Federico Zanetello","identifier":"zntfdr","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/zntfdr.jpeg"}],"type":"image"},"https://github.com/zntfdr":{"titleInlineContent":[{"text":"GitHub","type":"text"}],"title":"GitHub","url":"https:\/\/github.com\/zntfdr","type":"link","identifier":"https:\/\/github.com\/zntfdr"},"WWDCNotes.png":{"alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDCNotes.png"}],"type":"image","identifier":"WWDCNotes.png"},"https://developer.apple.com/wwdc21/10216":{"identifier":"https:\/\/developer.apple.com\/wwdc21\/10216","checksum":null,"url":"https:\/\/developer.apple.com\/wwdc21\/10216","type":"download"}}}