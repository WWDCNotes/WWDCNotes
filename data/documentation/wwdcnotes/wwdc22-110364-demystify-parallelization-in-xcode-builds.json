{"variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc22-110364-demystify-parallelization-in-xcode-builds"],"traits":[{"interfaceLanguage":"swift"}]}],"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110364-Demystify-parallelization-in-Xcode-builds","interfaceLanguage":"swift"},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22"]]},"schemaVersion":{"major":0,"patch":0,"minor":3},"kind":"article","sections":[],"metadata":{"title":"Demystify parallelization in Xcode builds","roleHeading":"WWDC22","role":"sampleCode","modules":[{"name":"WWDC Notes"}]},"abstract":[{"text":"Learn how the Xcode build system extracts maximum parallelism from your builds. We’ll explore how you can structure your project to improve build efficiency, take you through the process for resolving relationships between targets’ build phases in Xcode, and share how you can take full advantage of available hardware resources when compiling in Swift. We’ll also introduce you to Build Timeline — a powerful tool to help you monitor your build efficiency and performance.","type":"text"}],"sampleCodeDownload":{"action":{"isActive":true,"overridingTitle":"Watch Video (25 min)","type":"reference","identifier":"https:\/\/developer.apple.com\/wwdc22\/110364"},"kind":"sampleDownload"},"primaryContentSections":[{"kind":"content","content":[{"type":"heading","text":"Core concepts","level":2,"anchor":"Core-concepts"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"When we start a build in Xcode, the build system gets invoked with a representation of your project (source files, assets, build settings, run destination)","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the build system knows which tools to invoke using which settings and which intermediate files to produce to eventually create an app","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the build system invokes the tools to process the project’s input files whose outputs can then processed by other tools recursively until we reach the final target of our build","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"e.g., the source files ","type":"text"},{"text":".swift","type":"text"},{"text":", ","type":"text"},{"text":".h","type":"text"},{"text":" ","type":"text"},{"text":".c","type":"text"},{"text":" are fed to the Clang and the Swift compilers, which then produce relocatable objects ","type":"text"},{"text":".o","type":"text"},{"text":" as output, which can then be processed by Apple’s static linker ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/apple-opensource\/ld64"},{"text":", which in turn create a mach-o file or a ","type":"text"},{"text":".dylib","type":"text"},{"text":", etc","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"any step in our build process might fail, thus failing the entire build"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"build tasks\/steps have a dependency based on what they consume and produce (their input and output), putting together all these dependencies creates a build system dependency graph"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"a build task can’t start until its input are ready, which means that it might need to wait for another task to produces said input first","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"tasks that get unblocked when another task finishes are called ","type":"text"},{"text":"downstream","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"tasks that block other tasks are called "},{"type":"text","text":"upstream"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"in incremental builds, the build system is able to skip tasks for which inputs haven’t changed while the output is still up to date"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the dependencies and duration of the task execution defines the first possible time a downstream task can start","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"it’s possible to calculate the critical path which is the shortest time the build needs to run with theoretical unlimited resources","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"your goal is to shorten this path to create a highly parallelizable and scalable build graph","type":"text"}],"type":"paragraph"}]}]},{"type":"heading","text":"Xcode Build Timeline","level":3,"anchor":"Xcode-Build-Timeline"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"new feature in Xcode 14","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"shown when opening the assistant window in the build log"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"enhance the build log by visually showing you the tasks execution of your builds","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"in this chart:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"the number of rows at given time represents the level of parallelism during that time","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the horizontal length of individual tasks represent the duration they needed to finish their work","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"empty space in the graph shows where unfinished tasks blocked downstream tasks from starting to execute.","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"different colors applied to the timeline elements help distinguish the different targets that were part of the build","type":"text"}]}]}]}]}]},{"type":"paragraph","inlineContent":[{"text":"For incremental builds, the chart will only show executed tasks","type":"text"}]},{"type":"heading","text":"Build phases","level":2,"anchor":"Build-phases"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"build phases describe the work that needs to be done to produce that target’s product"}]}]},{"content":[{"inlineContent":[{"text":"can contain a set of source code files and assets to compile, files that need to be copied like headers or resources, as well as libraries that should be linked or scripts that should be executed","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"build phases might describe tasks with inputs or outputs from other build phases, creating dependencies between them"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the build system will consider the inputs and outputs of build phases to determine if they can run in parallel","type":"text"}]}]}]},{"type":"heading","text":"Script phases","level":3,"anchor":"Script-phases"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"the build system runs consecutive script phases one at a time to avoid introducing a data race in the build process","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"If the scripts in a target are configured to run based on dependency analysis and specify their complete list of inputs and outputs, then the build setting "},{"type":"codeVoice","code":"FUSE_BUILD_SCRIPT_PHASES"},{"type":"text","text":" can be set to "},{"type":"codeVoice","code":"YES"},{"type":"text","text":" to indicate the build system should attempt to run them in parallel"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"enable the build setting "},{"type":"codeVoice","code":"ENABLE_USER_SCRIPT_SANDBOXING"},{"type":"text","text":" to block shell scripts phases from accidentally accessing source files ("},{"type":"codeVoice","code":"PROJECT_DIR"},{"type":"text","text":") and intermediate build objects, unless those are explicitly declared as an input or output for the phase"}]}]}]},{"type":"heading","text":"Cross-Target builds","level":2,"anchor":"Cross-Target-builds"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Two new cross-target optimizations:"}]},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"eager emission of modules"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"eager linking"}]}]}]},{"type":"heading","text":"Swift driver","level":3,"anchor":"Swift-driver"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"building a Swift target’s source code into binary product’s is a complex operation that typically consists of many sub-tasks for build planning, compilation, and linking"}]}]},{"content":[{"inlineContent":[{"text":"coordination of these tasks is delegated to the Swift Driver","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the Driver has specialized knowledge on when and how to construct the required compiler and linker invocations for the target’s source code","type":"text"}]}]}]},{"type":"heading","text":"Eager emission of modules","level":3,"anchor":"Eager-emission-of-modules"},{"type":"paragraph","inlineContent":[{"text":"Swift modules\/libraries that depend on other Swift modules\/libraries need to wait for their dependency libraries tasks to emit a binary module file that captures the dependent’s public interface","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"Before Xcode 14, this meant:","type":"text"}]},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"waiting for all module source code to be compiled"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"assemble all the objects "},{"type":"text","text":".o"},{"type":"text","text":" into a binary module file"}],"type":"paragraph"}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Because the assembling of this binary module file was done in a single task, it meant that most machine cores were in idle during that phase (only one core is needed for the assembling)"}]},{"type":"paragraph","inlineContent":[{"text":"New in Xcode 14 and Swift 5.7 we have eager emission of modules:","type":"text"},{"text":"\n","type":"text"},{"text":"the construction of a target’s module binary file is done in a separate ","type":"text"},{"text":"emit-module","type":"text"},{"text":" task, directly from all program source files (no need to wait ","type":"text"},{"text":".o","type":"text"},{"text":" files)","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"This means target’s dependencies can begin compilation as soon as the emit-module task is complete without waiting for all of the other compiler tasks of the dependency target","type":"text"}]},{"type":"table","header":"row","rows":[[[{"type":"paragraph","inlineContent":[{"type":"text","text":"Before Xcode 14 and Swift 5.7"}]}],[{"type":"paragraph","inlineContent":[{"text":"after Xcode 14 and Swift 5.7","type":"text"}]}]],[[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC22-110364-before"}]}],[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC22-110364-after"}]}]]]},{"type":"paragraph","inlineContent":[{"type":"text","text":"The gain becomes even more obvious if we look at a bigger project with more modules"}]},{"type":"table","header":"row","rows":[[[{"inlineContent":[{"text":"Before Xcode 14 and Swift 5.7","type":"text"}],"type":"paragraph"}],[{"inlineContent":[{"text":"after Xcode 14 and Swift 5.7","type":"text"}],"type":"paragraph"}]],[[{"inlineContent":[{"identifier":"WWDC22-110364-before2","type":"image"}],"type":"paragraph"}],[{"inlineContent":[{"identifier":"WWDC22-110364-after2","type":"image"}],"type":"paragraph"}]]]},{"type":"heading","text":"Eager linking","level":3,"anchor":"Eager-linking"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"Linking a dependent target requires the linked product of its dependencies in addition to the target’s own compilation outputs","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"from this year, linking the dependent target only needs to wait for the emit-task of its dependencies and its own source code compilation before starting","type":"text"}],"type":"paragraph"}]}]},{"type":"table","header":"row","rows":[[[{"type":"paragraph","inlineContent":[{"text":"Before Xcode 14 and Swift 5.7","type":"text"}]}],[{"type":"paragraph","inlineContent":[{"type":"text","text":"after Xcode 14 and Swift 5.7"}]}]],[[{"type":"paragraph","inlineContent":[{"identifier":"WWDC22-110364-before3","type":"image"}]}],[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC22-110364-after3"}]}]]]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"This is possible because, instead of depending on a linked product of the dependency, linking now depends on a text-based dynamic library stub produced earlier in the build process by the emit-module task"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"This stub contains a list of symbols which will appear in the linked product for use by dependents","type":"text"}]}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"To enable this:"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"enable ","type":"text"},{"text":"Eager Linking","type":"text"},{"text":" build settings","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"target must be Swift-only and dynamically linked by their dependents to participate in the optimization","type":"text"}],"type":"paragraph"}]}]},{"type":"heading","text":"Written By","level":2,"anchor":"Written-By"},{"type":"row","numberOfColumns":5,"columns":[{"content":[{"type":"paragraph","inlineContent":[{"identifier":"zntfdr","type":"image"}]}],"size":1},{"content":[{"type":"heading","level":3,"text":"Federico Zanetello","anchor":"Federico-Zanetello"},{"type":"paragraph","inlineContent":[{"overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"isActive":true,"overridingTitle":"Contributed Notes","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","type":"reference"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"identifier":"https:\/\/github.com\/zntfdr","type":"reference"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"isActive":true,"identifier":"https:\/\/zntfdr.dev","type":"reference"}]}],"size":4}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Missing anything? Corrections? "},{"type":"reference","isActive":true,"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}]},{"type":"heading","text":"Related Sessions","level":2,"anchor":"Related-Sessions"},{"type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110354-Whats-new-in-Swift","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110362-Link-fast-Improve-build-and-launch-times","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110427-Whats-new-in-Xcode","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC18-415-Behind-the-Scenes-of-the-Xcode-Build-Process"],"style":"list"},{"type":"small","inlineContent":[{"inlineContent":[{"type":"text","text":"Legal Notice"}],"type":"strong"}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}]}],"references":{"zntfdr.jpeg":{"type":"image","identifier":"zntfdr.jpeg","alt":null,"variants":[{"url":"\/images\/zntfdr.jpeg","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110427-Whats-new-in-Xcode":{"url":"\/documentation\/wwdcnotes\/wwdc22-110427-whats-new-in-xcode","title":"What’s new in Xcode","abstract":[{"type":"text","text":"Discover the latest productivity and performance advancements in Xcode 14. We’ll introduce you to the fully redesigned SwiftUI canvas experience, explore enhancements to code completion and navigation, and take you through performance improvements we’ve made throughout the entire development process. We’ll also show you how you can now read and respond to feedback on your TestFlight builds without ever leaving Xcode."}],"role":"sampleCode","kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110427-Whats-new-in-Xcode"},"WWDC22-Icon.png":{"type":"image","identifier":"WWDC22-Icon.png","alt":null,"variants":[{"url":"\/images\/WWDC22-Icon.png","traits":["1x","light"]}]},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"title":"Contributions are welcome!","type":"link","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"zntfdr":{"type":"image","identifier":"zntfdr","alt":"Profile image of Federico Zanetello","variants":[{"url":"\/images\/zntfdr.jpeg","traits":["1x","light"]}]},"https://github.com/apple-opensource/ld64":{"url":"https:\/\/github.com\/apple-opensource\/ld64","titleInlineContent":[{"type":"codeVoice","code":"ld64"}],"title":"ld64","type":"link","identifier":"https:\/\/github.com\/apple-opensource\/ld64"},"WWDC22.jpeg":{"type":"image","identifier":"WWDC22.jpeg","alt":null,"variants":[{"url":"\/images\/WWDC22.jpeg","traits":["1x","light"]}]},"WWDC22-110364-before2":{"type":"image","identifier":"WWDC22-110364-before2","alt":null,"variants":[{"url":"\/images\/WWDC22-110364-before2.png","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110362-Link-fast-Improve-build-and-launch-times":{"url":"\/documentation\/wwdcnotes\/wwdc22-110362-link-fast-improve-build-and-launch-times","title":"Link fast: Improve build and launch times","abstract":[{"type":"text","text":"Discover how to improve your app’s build and runtime linking performance. We’ll take you behind the scenes to learn more about linking, your options, and the latest updates that improve the link performance of your app."}],"role":"sampleCode","kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110362-Link-fast-Improve-build-and-launch-times"},"https://developer.apple.com/wwdc22/110364":{"url":"https:\/\/developer.apple.com\/wwdc22\/110364","type":"download","identifier":"https:\/\/developer.apple.com\/wwdc22\/110364","checksum":null},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22":{"abstract":[{"type":"text","text":"Xcode 14, Swift 5.7, iOS 16, macOS 13 (Ventura), tvOS 16, watchOS 9."},{"text":" ","type":"text"},{"text":"New APIs: ","type":"text"},{"code":"WeatherKit","type":"codeVoice"},{"text":", ","type":"text"},{"code":"ScreenCaptureKit","type":"codeVoice"},{"text":", ","type":"text"},{"code":"Swift Regex","type":"codeVoice"},{"type":"text","text":", and more."}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22","url":"\/documentation\/wwdcnotes\/wwdc22","title":"WWDC22","role":"collectionGroup","images":[{"type":"icon","identifier":"WWDC22-Icon.png"},{"type":"card","identifier":"WWDC22.jpeg"}],"type":"topic","kind":"article"},"WWDC22-110364-after3":{"type":"image","identifier":"WWDC22-110364-after3","alt":null,"variants":[{"url":"\/images\/WWDC22-110364-after3.png","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes":{"abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes","kind":"symbol","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","images":[{"type":"icon","identifier":"WWDCNotes.png"}],"title":"WWDC Notes","role":"collection"},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"abstract":[{"text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more.","type":"text"}],"type":"topic","url":"\/documentation\/wwdcnotes\/zntfdr","kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","images":[{"type":"card","identifier":"zntfdr.jpeg"},{"type":"icon","identifier":"zntfdr.jpeg"}],"title":"Federico Zanetello (332 notes)","role":"sampleCode"},"WWDC22-110364-before3":{"type":"image","identifier":"WWDC22-110364-before3","alt":null,"variants":[{"url":"\/images\/WWDC22-110364-before3.png","traits":["1x","light"]}]},"WWDC22-110364-after2":{"type":"image","identifier":"WWDC22-110364-after2","alt":null,"variants":[{"url":"\/images\/WWDC22-110364-after2.png","traits":["1x","light"]}]},"WWDCNotes.png":{"type":"image","identifier":"WWDCNotes.png","alt":null,"variants":[{"url":"\/images\/WWDCNotes.png","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC18-415-Behind-the-Scenes-of-the-Xcode-Build-Process":{"kind":"article","role":"sampleCode","url":"\/documentation\/wwdcnotes\/wwdc18-415-behind-the-scenes-of-the-xcode-build-process","abstract":[{"type":"text","text":"Ever wonder what happens when you build your project in Xcode? Learn how Xcode automates the steps required to build an application, and go behind the scenes to learn how clang, swiftc, and the linker work together to turn your source code into a working program."}],"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC18-415-Behind-the-Scenes-of-the-Xcode-Build-Process","title":"Behind the Scenes of the Xcode Build Process"},"WWDC22-110364-before":{"type":"image","identifier":"WWDC22-110364-before","alt":null,"variants":[{"url":"\/images\/WWDC22-110364-before.png","traits":["1x","light"]}]},"https://zntfdr.dev":{"url":"https:\/\/zntfdr.dev","titleInlineContent":[{"type":"text","text":"Blog"}],"title":"Blog","type":"link","identifier":"https:\/\/zntfdr.dev"},"WWDC22-110364-after":{"type":"image","identifier":"WWDC22-110364-after","alt":null,"variants":[{"url":"\/images\/WWDC22-110364-after.png","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110354-Whats-new-in-Swift":{"url":"\/documentation\/wwdcnotes\/wwdc22-110354-whats-new-in-swift","title":"What’s new in Swift","abstract":[{"type":"text","text":"Join us for an update on Swift. We’ll take you through performance improvements, explore more secure and extensible Swift packages, and share advancements in Swift concurrency. We’ll also introduce you to Swift Regex, better generics, and other tools built into the language to help you write more flexible & expressive code."}],"role":"sampleCode","kind":"article","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110354-Whats-new-in-Swift"},"https://github.com/zntfdr":{"url":"https:\/\/github.com\/zntfdr","titleInlineContent":[{"type":"text","text":"GitHub"}],"title":"GitHub","type":"link","identifier":"https:\/\/github.com\/zntfdr"}}}