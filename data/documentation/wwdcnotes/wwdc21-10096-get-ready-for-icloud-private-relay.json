{"kind":"article","metadata":{"role":"sampleCode","title":"Get ready for iCloud Private Relay","roleHeading":"WWDC21","modules":[{"name":"WWDC Notes"}]},"schemaVersion":{"minor":3,"major":0,"patch":0},"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10096-Get-ready-for-iCloud-Private-Relay","interfaceLanguage":"swift"},"abstract":[{"text":"iCloud Private Relay is an iCloud+ service that prevents networks and servers from monitoring a person’s activity across the internet. Discover how your app can participate in this transition to a more secure and private internet: We’ll show you how to prepare your apps, servers, and networks to work with iCloud Private Relay.","type":"text"}],"primaryContentSections":[{"kind":"content","content":[{"level":2,"text":"What is iCloud Private Relay?","anchor":"What-is-iCloud-Private-Relay","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"new service that prevents networks and servers from monitoring user activity across the internet"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"built into iOS and macOS"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"available as part of every iCloud+ subscription (can be disabled by user or in certain regions)","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"affects:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"all Safari browsing"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"all DNS queries","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"all http (","type":"text"},{"inlineContent":[{"text":"not","type":"text"}],"type":"emphasis"},{"text":" https) apps traffic","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"if you app provides a content filter or a parental controls filter, it will still see traffic before it goes through Private Relay","type":"text"}]}]}],"type":"unorderedList"}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"Not applicable traffic:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Local network connections"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Private domains"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Network Extensions and VPNs"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Proxy configurations"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":3,"text":"Without iCloud Private Relay","anchor":"Without-iCloud-Private-Relay","type":"heading"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"when a user accesses the internet, anyone on their local network can see the names of all of the websites they access based on inspecting DNS queries"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"this information can be used to fingerprint a user and build a history of their activity over time"}],"type":"paragraph"}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"when connections reach the servers that run websites, those servers can see the user’s IP address","type":"text"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"this allows the servers to determine user location without explicit permission"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the servers are able to fingerprint user identity and recognize users across different websites, even when tools are preventing correlation via cookies (e.g., Safari’s Intelligent Tracking Prevention)","type":"text"}]}]}]}]}],"type":"unorderedList"},{"level":3,"text":"With iCloud Private Relay","anchor":"With-iCloud-Private-Relay","type":"heading"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"iCloud Private Relay adds multiple secure proxies to help route user traffic and keep it private"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"the proxies are run by separate entities"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"one is Apple, and one is a content provider","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"when a user accesses the internet, only the client IP address is visible to both the network provider and to the first proxy","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"the second proxy only sees the name the user is requesting and uses that to build the connection to the server"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"no one in this chain, ","type":"text"},{"inlineContent":[{"type":"text","text":"not even Apple"}],"type":"emphasis"},{"text":", can see both the client IP address and what the user is accessing","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"level":2,"text":"(Best practices) Prepare your app","anchor":"Best-practices-Prepare-your-app","type":"heading"},{"inlineContent":[{"type":"text","text":"Most apps don’t need to do anything."}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"avoid insecure connections - Private Relay will add encryption up to the egress proxy","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"use ","type":"text"},{"type":"codeVoice","code":"URLSession"},{"text":" and ","type":"text"},{"type":"codeVoice","code":"NWConnection"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"you can use the "},{"type":"text","text":"Network Xcode Instrument"},{"type":"text","text":" to inspect your tasks, even when they are going through Private Relay"}]}]},{"content":[{"inlineContent":[{"text":"you can use metrics APIs in both ","type":"text"},{"type":"codeVoice","code":"URLSession"},{"text":" and ","type":"text"},{"text":"Network.framework","type":"text"},{"text":" to understand when your connections use Private Relay:","type":"text"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"codeVoice","code":"URLSessionTaskTransactionMetrics"},{"text":" - you can check if your task used a proxy","type":"text"}]}]},{"content":[{"inlineContent":[{"code":"NWConnection.EstablishmentReport","type":"codeVoice"},{"type":"text","text":" - you can inspect the timings of DNS name resolution and each stage of the proxied connection establishment"}],"type":"paragraph"}]}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"prefer CoreLocation to IP address geolocation"}]}]}],"type":"unorderedList"},{"level":2,"text":"Prepare your server","anchor":"Prepare-your-server","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"make sure your server supports TLS"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Proxy UP address pools","type":"text"}]},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"your servers can identify connections that come in using Private Relay by recognizing the proxy IP addresses"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"these addresses may be shared by many users within a region"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"each address is mapped to a specific city or region"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"if you apply the correct geo IP mapping databases, your servers will still have the relevant information"}],"type":"paragraph"}]}],"type":"unorderedList"}]}],"type":"unorderedList"}]},{"content":[{"inlineContent":[{"type":"text","text":"stop solely relying on client IP address to determine user location or identity"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"if you need location access, consider requesting the user’s location explicitly (via ","type":"text"},{"text":"CoreLocation","type":"text"},{"text":")","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"if you need to identify users, request a login or some other form of explicit identification rather than assuming that the IP address is tied to the identity"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":2,"text":"Manage your network","anchor":"Manage-your-network","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"if you’re running a packet trace on your local network when Private Relay is in use, you’ll see some new traffic patterns:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"you’ll now see a lot more traffic running on UDP port 443"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"This is "},{"type":"codeVoice","code":"QUIC"},{"type":"text","text":" – or "},{"type":"codeVoice","code":"HTTP\/3"},{"type":"text","text":" – traffic that’s being used to communicate with the Private Relay proxy"}]}]},{"content":[{"inlineContent":[{"text":"you can make sure your traffic works well by allowing ","type":"text"},{"code":"UDP","type":"codeVoice"},{"text":" port ","type":"text"},{"code":"443","type":"codeVoice"},{"text":" on your network and by making sure your routers or Network Address Translators are tuned to handle it well","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"}]}],"type":"unorderedList"}]},{"content":[{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"you’ll also see fewer cleartext UDP DNS queries on your network"}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"with Private Relay, the device first sets up a connection to the ingress Proxy using ","type":"text"},{"code":"QUIC","type":"codeVoice"},{"text":", or ","type":"text"},{"code":"HTTP\/3","type":"codeVoice"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"once the network connection is established to the ingress proxy, access to a server is secured within the connection to the ingress proxy"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"on the server end, there is no change in protocol","type":"text"}],"type":"paragraph"}]}]}]}],"type":"unorderedList"}]},{"content":[{"inlineContent":[{"text":"if you need to audit\/monitor all user traffic (e.g., if you run an enterprise or school network, your network may have policies that require intercepting all traffic), you can block the hostname of the iCloud Private Relay proxy server","type":"text"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"when a device connects to your network, the user will receive a prompt indicating that Private Relay is blocked on the current network"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"they can then choose to either disable Private Relay for that network or switch networks","type":"text"}]}]}]}]}]}]}],"type":"unorderedList"},{"content":[{"type":"paragraph","inlineContent":[{"text":"For parental controls, the best solution is to use content filter APIs provided by NetworkExtension framework. This allows traffic to be audited on device even when Private Relay is enabled.","type":"text"}]}],"type":"aside","name":"Note","style":"note"},{"level":2,"text":"Written By","anchor":"Written-By","type":"heading"},{"type":"row","columns":[{"size":1,"content":[{"inlineContent":[{"identifier":"zntfdr","type":"image"}],"type":"paragraph"}]},{"size":4,"content":[{"type":"heading","anchor":"Federico-Zanetello","text":"Federico Zanetello","level":3},{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","overridingTitle":"Contributed Notes","overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/zntfdr"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/zntfdr.dev"}]}]}],"numberOfColumns":5},{"type":"thematicBreak"},{"inlineContent":[{"type":"text","text":"Missing anything? Corrections? "},{"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","isActive":true,"type":"reference"}],"type":"paragraph"},{"level":2,"text":"Related Sessions","anchor":"Related-Sessions","type":"heading"},{"items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10002-Ready-set-relay-Protect-app-traffic-with-network-relays","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10085-Apples-privacy-pillars-in-focus","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10123-Meet-the-Screen-Time-API"],"type":"links","style":"list"},{"inlineContent":[{"inlineContent":[{"type":"text","text":"Legal Notice"}],"type":"strong"}],"type":"small"},{"inlineContent":[{"text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved.","type":"text"},{"text":" ","type":"text"},{"text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries.","type":"text"},{"text":" ","type":"text"},{"text":"This website is not made by, affiliated with, nor endorsed by Apple.","type":"text"}],"type":"small"}]}],"variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc21-10096-get-ready-for-icloud-private-relay"],"traits":[{"interfaceLanguage":"swift"}]}],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"sampleCodeDownload":{"kind":"sampleDownload","action":{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/wwdc21\/10096","overridingTitle":"Watch Video (15 min)"}},"sections":[],"references":{"doc://WWDCNotes/documentation/WWDCNotes/WWDC23-10002-Ready-set-relay-Protect-app-traffic-with-network-relays":{"title":"Ready, set, relay: Protect app traffic with network relays","role":"sampleCode","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC23-10002-Ready-set-relay-Protect-app-traffic-with-network-relays","kind":"article","abstract":[{"text":"Learn how relays can make your app’s network traffic more private and secure without the overhead of a VPN. We’ll show you how to integrate relay servers in your own app and explore how enterprise networks can use relays to securely access internal resources.","type":"text"}],"url":"\/documentation\/wwdcnotes\/wwdc23-10002-ready-set-relay-protect-app-traffic-with-network-relays"},"https://zntfdr.dev":{"url":"https:\/\/zntfdr.dev","identifier":"https:\/\/zntfdr.dev","type":"link","title":"Blog","titleInlineContent":[{"text":"Blog","type":"text"}]},"zntfdr":{"identifier":"zntfdr","alt":"Profile image of Federico Zanetello","variants":[{"url":"\/images\/WWDCNotes\/zntfdr.jpeg","traits":["1x","light"]}],"type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"abstract":[{"type":"text","text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"MusicKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"DocC"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit 2"},{"type":"text","text":", and more."}],"url":"\/documentation\/wwdcnotes\/wwdc21","title":"WWDC21","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21","role":"collectionGroup","kind":"article","images":[{"identifier":"WWDC21-Icon.png","type":"icon"},{"identifier":"WWDC21.jpeg","type":"card"}]},"WWDCNotes.png":{"variants":[{"url":"\/images\/WWDCNotes\/WWDCNotes.png","traits":["1x","light"]}],"type":"image","alt":null,"identifier":"WWDCNotes.png"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10123-Meet-the-Screen-Time-API":{"kind":"article","title":"Meet the Screen Time API","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10123-Meet-the-Screen-Time-API","type":"topic","role":"sampleCode","abstract":[{"text":"Explore the Screen Time API and learn how you can build apps that support customized parental controls — all while putting privacy first. Learn how you can use key features like core restrictions and device activity monitoring to create safe, secure experiences in your app while providing measurable control for parents and guardians.","type":"text"}],"url":"\/documentation\/wwdcnotes\/wwdc21-10123-meet-the-screen-time-api"},"https://github.com/zntfdr":{"url":"https:\/\/github.com\/zntfdr","identifier":"https:\/\/github.com\/zntfdr","type":"link","title":"GitHub","titleInlineContent":[{"text":"GitHub","type":"text"}]},"WWDC21-Icon.png":{"identifier":"WWDC21-Icon.png","alt":null,"variants":[{"url":"\/images\/WWDCNotes\/WWDC21-Icon.png","traits":["1x","light"]}],"type":"image"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"title":"Contributions are welcome!","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","type":"link","titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10085-Apples-privacy-pillars-in-focus":{"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10085-apples-privacy-pillars-in-focus","title":"Apple’s privacy pillars in focus","type":"topic","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10085-Apples-privacy-pillars-in-focus","abstract":[{"type":"text","text":"At Apple, we believe that privacy is a fundamental human right. Learn about our four pillars of privacy, how we brought these principles together to design iCloud Private Relay, and how you can approach building privacy in your app in line with those fundamentals. Explore how you can build data minimization, on-device processing, transparency and control, and security protections right into your app."}]},"zntfdr.jpeg":{"identifier":"zntfdr.jpeg","type":"image","alt":null,"variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/zntfdr.jpeg"}]},"WWDC21.jpeg":{"identifier":"WWDC21.jpeg","alt":null,"variants":[{"url":"\/images\/WWDCNotes\/WWDC21.jpeg","traits":["1x","light"]}],"type":"image"},"https://developer.apple.com/wwdc21/10096":{"url":"https:\/\/developer.apple.com\/wwdc21\/10096","type":"download","checksum":null,"identifier":"https:\/\/developer.apple.com\/wwdc21\/10096"},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"kind":"article","url":"\/documentation\/wwdcnotes\/zntfdr","role":"sampleCode","abstract":[{"type":"text","text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more."}],"type":"topic","title":"Federico Zanetello (332 notes)","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","images":[{"type":"card","identifier":"zntfdr.jpeg"},{"type":"icon","identifier":"zntfdr.jpeg"}]},"doc://WWDCNotes/documentation/WWDCNotes":{"abstract":[{"type":"text","text":"Session notes shared by the community for the community."}],"url":"\/documentation\/wwdcnotes","title":"WWDC Notes","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","role":"collection","kind":"symbol","images":[{"type":"icon","identifier":"WWDCNotes.png"}]}}}