{"abstract":[{"type":"text","text":"Learn how to easily build apps that share data between multiple iCloud users with NSPersistentCloudKitContainer. Discover how to create informative experiences around shared data and learn about the CloudKit technologies that support these features in Core Data."}],"schemaVersion":{"minor":3,"patch":0,"major":0},"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10015-Build-apps-that-share-data-through-CloudKit-and-Core-Data-"},"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"metadata":{"role":"sampleCode","modules":[{"name":"WWDC Notes"}],"title":"Build apps that share data through CloudKit and Core Data","roleHeading":"WWDC21"},"kind":"article","primaryContentSections":[{"kind":"content","content":[{"text":"Overview","type":"heading","anchor":"overview","level":2},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"New databaseScope: "},{"type":"codeVoice","code":".shared"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"New APIs for sharing objects and accepting invitations"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Record Zone Sharing","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Allows cloud encryption"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"What is “sharing?”","type":"heading","anchor":"What-is-sharing","level":2},{"name":"Note","type":"aside","style":"note","content":[{"inlineContent":[{"text":"The presenter shows the process of creating a shared album. Then uses a ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/CoreData\/synchronizing-a-local-store-to-the-cloud"},{"text":" to demonstrate how to share a newly created post to others through email.","type":"text"}],"type":"paragraph"}]},{"text":"How do we share?","type":"heading","anchor":"How-do-we-share","level":2},{"name":"Note","type":"aside","style":"note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"“Sharing” is by far the most complicated feature built in NSPersistentCloudKitContainer."}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Data is stored in different stores. Using a single managedObjectContext, an application can manage objects in both stores."}]},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC21-10015-stores"}]},{"type":"paragraph","inlineContent":[{"text":"To do this, we have to tell NSPersistentCloudKitContainer to mirror the shared CloudKit database to a new persistence store:","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"add a new description by copying the private store description with a different URL","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"set the databaseScope to "},{"type":"codeVoice","code":".shared"},{"type":"text","text":" (This is new in iOS 15)"}],"type":"paragraph"}]}],"type":"orderedList"},{"code":["let containerIdentifier = \/\/...","let sharedStoreDescription = privateStoreDescription.copy()","let sharedStoreURL = storesURL.appendingPathComponent(\"shared.sqlite\")","sharedStoreDescription.url = sharedStoreURL ","","let sharedStoreOptions = NSPersistentCloudKitContainerOptions(containerIdentifier: containerIdentifier)","","sharedStoreOptions.databaseScope = .shared \/\/ new in iOS 15","sharedStoreDescription.cloudKitContainerOptions = sharedStoreOptions","container.persistentStoreDescriptions.append(sharedStoreDescription)"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"And then we can adopt a new method on NSPersistentCloudKitContainer to create the share:"}]},{"code":["open func share(_ managedObjects: [NSManagedObject],","                to share: CKShare?,","                completion completion: @escaping (Set<NSManagedObjectID>?,","                                                  CKShare?,","                                                  CKContainer?,","                                                  Error?) -> Void)"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"This is how the demo uses it:"}]},{"code":["\/\/ DetailViewController+Sharing.swift","@IBAction func shareNoteAction(_ sender: Any) {","  let container = AppDelegate.sharedAppDelegate.coreDataStack.persistentContainer","  let cloudSharingController = UICloudSharingController {","    (controller, completion: @escaping (CKShare?, CKContainer?, Error?) -> Void) in","    \/\/ HERE!","    container.share([self.post!], ","                    to: nil) { objectIDs, share, container, error in","            completion(share, container, error)","        }","  }","  cloudSharingController.delegate = self","","  if let popover = cloudSharingController.popoverPresentationController {","    popover.barButtonItem = barButtonItem","  }","  present(cloudSharingController, animated: true) {}","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The new method is invoked in the create-share phase of a UICloudSharingController’s workflow."}]},{"type":"paragraph","inlineContent":[{"text":"Last thing is to be able to accept invitation by using another new method:","type":"text"}]},{"code":["open func  acceptShareInvitations(fromMetadata metadata: [CKShare.Metadata],","                                  into persistentStore: NSPersistentStore,","                                  completion: (([CKShare.Metadata]?, Error?) -> Void)? = nil)"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"It is used in the AppDelegate:"}]},{"code":["func application(_ application: UIApplication,","                 userDidAcceptCloudKitShare cloudKitShareMetadata: CKShare.Metadata) {","    let sharedStore = AppDelegate.sharedAppDelegate.coreDataStack.sharedPersistentStore","    let container = AppDelegate.sharedAppDelegate.coreDataStack.persistentContainer","    container.acceptShareInvitations(from: [cloudKitShareMetadata], ","                                     into: sharedStore, ","                                     completion: nil)","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"After we accept the share invitations, the NSPersistentCloudKitContainer will automatically save all of the shared objects to the local store."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"For further clarification, there are some crucial concepts to be identified."}]},{"text":"Owners and participants","type":"heading","anchor":"Owners-and-participants","level":3},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Owners create and share objects","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Participants operate on shared objects","type":"text"}]}]}],"type":"unorderedList"},{"text":"Shared objects","type":"heading","anchor":"Shared-objects","level":3},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"NSManagedObject is turned into CKRecord","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"NSPersistentCloudKitContainer uses ","type":"text"},{"type":"strong","inlineContent":[{"type":"text","text":"Record Zone Sharing"}]},{"text":" to share objects","type":"text"}],"type":"paragraph"}]}],"type":"orderedList"},{"text":"Record Zone Sharing","type":"heading","anchor":"Record-Zone-Sharing","level":4},{"type":"paragraph","inlineContent":[{"identifier":"WWDC21-10015-zones","type":"image"}]},{"type":"paragraph","inlineContent":[{"text":"NSPersistentCloudKitContainer will create zones we owned, whether or not they are shared, in the private database. For shared zones, NSPersistentCloudKitContainer will also create a CKShare record to control who can access these zones. Other paticipants, if allowed, can add and modify records in these shared zones.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"In the shared database, we would see shared zone that other users have shared with us. And if we are allowed to, we can add and modify records in these zones just as they can in the zones we owned."}]},{"type":"paragraph","inlineContent":[{"text":"Most of the time, NSPersistentCloudKitContainer can infer where records belong. But we can also tell it to store objects in a specific zone:","type":"text"}]},{"code":["\/\/ DetailViewController+Sharing.swift","@IBAction func shareNoteAction(_ sender: Any) {","  let container = AppDelegate.sharedAppDelegate.coreDataStack.persistentContainer","  let cloudSharingController = UICloudSharingController {","    (controller, completion: @escaping (CKShare?, CKContainer?, Error?) -> Void) in","    \/\/ HERE! Using an existing share","    container.share([self.post!], ","                    to: self.share) { objectIDs, share, container, error in","            completion(share, container, error)","        }","  }","  cloudSharingController.delegate = self","","  if let popover = cloudSharingController.popoverPresentationController {","    popover.barButtonItem = barButtonItem","  }","  present(cloudSharingController, animated: true) {}","}"],"syntax":"swift","type":"codeListing"},{"text":"Applications change with sharing","type":"heading","anchor":"Applications-change-with-sharing","level":4},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Decorate shared objects"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Conditionalize editing"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Display participants"}],"type":"paragraph"}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"We can get the CKShare for a specific shared object with the new API:","type":"text"}]},{"code":["\/\/ Fetch Shares to access metadata","open func fetchShares(matching objectIDs: [NSManagedObjectID]","                      throws -> [NSManagedObjectID: CKShare])","","\/\/ Conditionalize Editing","open func canUpdateRecord(forManagedObjectWith objectID: NSManagedObjectID) -> Bool","open func canDeleteRecord(forManagedObjectWith objectID: NSManagedObjectID) -> Bool","open func canModifyManagedObjects(in store: NSPersistentStore) -> Bool"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"While in the demo, there is a protocol "},{"type":"codeVoice","code":"SharingProvider"},{"type":"text","text":" built to accomplish these customizations:"}]},{"code":["protocol SharingProvider {","  func isShared(object: NSManagedObject) -> Bool","  func isShared(objectID: NSManagedObjectID) -> Bool","  func participants(for object: NSManagedObject) -> [RenderableShareParticipant]","  func shares(matching objectIDs: [NSManagedObjectID]) throws -> [NSManagedObjectID: RenderableShare]","  func canEdit(object: NSManagedObject) -> Bool","  func canDelete(object: NSManagedObject) -> Bool","}"],"syntax":"swift","type":"codeListing"},{"name":"Note","type":"aside","style":"note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Check out "},{"type":"codeVoice","code":"BlockBasedShareProvider"},{"type":"text","text":" if you are interesting in testing."}]}]},{"text":"Sensitive data","type":"heading","anchor":"Sensitive-data","level":2},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"New "},{"type":"codeVoice","code":"CKRecord.encryptedValues"},{"type":"text","text":" payload"}]}]},{"content":[{"inlineContent":[{"text":"Encryption using the user’s keychain","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"One click adoption in Core Data"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"type":"image","identifier":"WWDC21-10015-encryption"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Or if you prefer to do it in code:"}]},{"code":["open class NSAttributeDescription: NSPropertyDescription {","    @available(iOS 15.0, *)","    open var allowsCloudEncryption: Bool","}"],"syntax":"swift","type":"codeListing"},{"text":"A note about encrypted values","type":"heading","anchor":"A-note-about-encrypted-values","level":3},{"items":[{"content":[{"inlineContent":[{"text":"CKRecord field types can only be set once","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Once the schema is pushed to production it is forever"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Remember to use initializeSchema"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Written By","type":"heading","anchor":"Written-By","level":2},{"type":"row","columns":[{"size":1,"content":[{"inlineContent":[{"identifier":"davidleee","type":"image"}],"type":"paragraph"}]},{"size":4,"content":[{"type":"heading","text":"David Lee","level":3,"anchor":"David-Lee"},{"inlineContent":[{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/davidleee","isActive":true,"overridingTitle":"Contributed Notes","overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/github.com\/davidleee","isActive":true,"type":"reference"},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/davidleee.com","isActive":true,"type":"reference"}],"type":"paragraph"}]}],"numberOfColumns":5},{"type":"thematicBreak"},{"type":"paragraph","inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"}]},{"text":"Related Sessions","type":"heading","anchor":"Related-Sessions","level":2},{"items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-10119-Optimize-your-use-of-Core-Data-and-CloudKit","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10003-There-and-back-again-Data-transfer-on-Apple-Watch","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10017-Bring-Core-Data-concurrency-to-Swift-and-SwiftUI","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10086-Whats-new-in-CloudKit"],"type":"links","style":"list"},{"type":"small","inlineContent":[{"inlineContent":[{"text":"Legal Notice","type":"text"}],"type":"strong"}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}]}],"variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc21-10015-build-apps-that-share-data-through-cloudkit-and-core-data-"],"traits":[{"interfaceLanguage":"swift"}]}],"sections":[],"sampleCodeDownload":{"kind":"sampleDownload","action":{"identifier":"https:\/\/developer.apple.com\/wwdc21\/10015","overridingTitle":"Watch Video (24 min)","type":"reference","isActive":true}},"references":{"doc://WWDCNotes/documentation/WWDCNotes":{"abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","url":"\/documentation\/wwdcnotes","kind":"symbol","role":"collection","images":[{"type":"icon","identifier":"WWDCNotes.png"}],"type":"topic","title":"WWDC Notes"},"WWDC21.jpeg":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21.jpeg"}],"identifier":"WWDC21.jpeg","alt":null},"WWDCNotes.png":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDCNotes.png"}],"alt":null,"identifier":"WWDCNotes.png"},"https://github.com/davidleee":{"url":"https:\/\/github.com\/davidleee","identifier":"https:\/\/github.com\/davidleee","type":"link","titleInlineContent":[{"type":"text","text":"GitHub"}],"title":"GitHub"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"type":"link","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","title":"Contributions are welcome!","titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"WWDC21-10015-zones":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21-10015-zones.png"}],"alt":null,"identifier":"WWDC21-10015-zones"},"https://developer.apple.com/wwdc21/10015":{"checksum":null,"identifier":"https:\/\/developer.apple.com\/wwdc21\/10015","type":"download","url":"https:\/\/developer.apple.com\/wwdc21\/10015"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-10119-Optimize-your-use-of-Core-Data-and-CloudKit":{"kind":"article","abstract":[{"type":"text","text":"Join us as we explore the three parts of the development cycle that can help you optimize your Core Data and CloudKit implementation. We’ll show you how you can analyze your app’s architecture and feature set to verify assumptions, explore changes in behavior after ingesting large data sets, and get actionable feedback to make improvements to your workflow."}],"type":"topic","role":"sampleCode","title":"Optimize your use of Core Data and CloudKit","url":"\/documentation\/wwdcnotes\/wwdc22-10119-optimize-your-use-of-core-data-and-cloudkit","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-10119-Optimize-your-use-of-Core-Data-and-CloudKit"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10086-Whats-new-in-CloudKit":{"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10086-whats-new-in-cloudkit","title":"What’s new in CloudKit","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10086-Whats-new-in-CloudKit","abstract":[{"type":"text","text":"CloudKit provides a secure, convenient, and reliable cloud database for your apps — and it’s only getting better. Discover how you can unravel your threads with support for async\/await and convenience API additions. We’ll also show you how to encourage collaboration between people using your app through sharing entire record zones of data, and explore how to adopt CloudKit features like encrypted values and help protect sensitive data within your app."}],"role":"sampleCode","type":"topic"},"davidleee.jpeg":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/davidleee.jpeg"}],"identifier":"davidleee.jpeg","alt":null},"WWDC21-10015-encryption":{"alt":null,"identifier":"WWDC21-10015-encryption","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21-10015-encryption.png"}],"type":"image"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10003-There-and-back-again-Data-transfer-on-Apple-Watch":{"type":"topic","title":"There and back again: Data transfer on Apple Watch","url":"\/documentation\/wwdcnotes\/wwdc21-10003-there-and-back-again-data-transfer-on-apple-watch","abstract":[{"text":"Advances in Apple Watch give you more ways to communicate to and from your app, and new audiences to consider. Learn what strategies are available for data communication and how to choose the right tool for the job. Compare and contrast the benefits of using technologies such as iCloud Keychain, Watch Connectivity, Core Data, and more.","type":"text"}],"role":"sampleCode","kind":"article","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10003-There-and-back-again-Data-transfer-on-Apple-Watch"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10017-Bring-Core-Data-concurrency-to-Swift-and-SwiftUI":{"kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10017-bring-core-data-concurrency-to-swift-and-swiftui","title":"Bring Core Data concurrency to Swift and SwiftUI","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10017-Bring-Core-Data-concurrency-to-Swift-and-SwiftUI","abstract":[{"type":"text","text":"Discover how Core Data is adopting the new concurrency capabilities of Swift 5.5, leading to more concise, efficient, and safe asynchronous code. We’ll show you how to update Core Data in your apps to work with concurrency, and detail the many other improvements throughout the framework that make working with Swift and SwiftUI more expressive and powerful."}],"role":"sampleCode","type":"topic"},"WWDC21-10015-stores":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21-10015-stores.png"}],"alt":null,"identifier":"WWDC21-10015-stores"},"https://developer.apple.com/documentation/CoreData/synchronizing-a-local-store-to-the-cloud":{"type":"link","identifier":"https:\/\/developer.apple.com\/documentation\/CoreData\/synchronizing-a-local-store-to-the-cloud","title":"demo project","titleInlineContent":[{"text":"demo project","type":"text"}],"url":"https:\/\/developer.apple.com\/documentation\/CoreData\/synchronizing-a-local-store-to-the-cloud"},"https://davidleee.com":{"url":"https:\/\/davidleee.com","identifier":"https:\/\/davidleee.com","type":"link","titleInlineContent":[{"type":"text","text":"Blog"}],"title":"Blog"},"doc://WWDCNotes/documentation/WWDCNotes/davidleee":{"title":"David Lee (4 notes)","abstract":[{"type":"text","text":"Indie iOS developer🧑🏻‍💻"}],"url":"\/documentation\/wwdcnotes\/davidleee","kind":"article","role":"sampleCode","images":[{"type":"card","identifier":"davidleee.jpeg"},{"type":"icon","identifier":"davidleee.jpeg"}],"type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/davidleee"},"davidleee":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/davidleee.jpeg"}],"alt":"Profile image of David Lee","identifier":"davidleee"},"WWDC21-Icon.png":{"type":"image","variants":[{"traits":["1x","light"],"url":"\/images\/WWDCNotes\/WWDC21-Icon.png"}],"identifier":"WWDC21-Icon.png","alt":null},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"kind":"article","type":"topic","abstract":[{"type":"text","text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"MusicKit"},{"type":"text","text":", "},{"type":"codeVoice","code":"DocC"},{"type":"text","text":", "},{"type":"codeVoice","code":"StoreKit 2"},{"type":"text","text":", and more."}],"role":"collectionGroup","title":"WWDC21","url":"\/documentation\/wwdcnotes\/wwdc21","images":[{"identifier":"WWDC21-Icon.png","type":"icon"},{"identifier":"WWDC21.jpeg","type":"card"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"}}}