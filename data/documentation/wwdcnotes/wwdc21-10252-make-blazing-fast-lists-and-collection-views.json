{"metadata":{"roleHeading":"WWDC21","title":"Make blazing fast lists and collection views","modules":[{"name":"WWDC Notes"}],"role":"sampleCode"},"abstract":[{"text":"Build consistently smooth scrolling list and collection views: Explore the lifecycle of a cell and learn how to apply that knowledge to eliminate rough scrolling and missed frames. We‚Äôll also show you how to improve your overall scrolling experience and avoid costly hitches, with optimized image loading and automatic cell prefetching.","type":"text"}],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10252-Make-blazing-fast-lists-and-collection-views"},"schemaVersion":{"patch":0,"major":0,"minor":3},"sections":[],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"primaryContentSections":[{"kind":"content","content":[{"anchor":"overview","level":2,"text":"Overview","type":"heading"},{"content":[{"inlineContent":[{"identifier":"https:\/\/developer.apple.com\/documentation\/uikit\/uiimage\/building_high-performance_lists_and_collection_views","isActive":true,"type":"reference"}],"type":"paragraph"}],"style":"note","name":"Note","type":"aside"},{"level":2,"anchor":"Performance-fundamentals","text":"Performance fundamentals","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Diffable data source is built to store identifiers of items in your model, and not the model objects themselves","type":"text"}]}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"Improvements to diffable data source:"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"Before iOS 15, applying a snapshot without animation would do a ","type":"text"},{"code":"reloadData","type":"codeVoice"},{"text":" internally","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"From iOS 15 onwards, applying a snapshot without animation will only apply the differences and not perform any extra work","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"diffable data source also gains a new ","type":"text"},{"type":"codeVoice","code":"reconfigureItems"},{"text":" method that makes it easy to update the contents of visible cells","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":3,"anchor":"Life-of-a-cell","text":"Life of a cell","type":"heading"},{"inlineContent":[{"text":"Two phases:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"preparation"}]}]}],"type":"orderedList"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"the collection view is asked to dequeue a new cell using a registration"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"if a cell exists in the reuse pool, "},{"code":"UICollectionView","type":"codeVoice"},{"type":"text","text":" will call "},{"code":"prepareForReuse","type":"codeVoice"},{"type":"text","text":" on it, and then dequeue the cell. Otherwise it will create a new one"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the cell is then passed in to the configuration handler from the registration","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"the collection view queries the cell for its preferred layout attributes and sizes the cell appropriately"}],"type":"paragraph"}]}],"type":"unorderedList"},{"start":2,"items":[{"content":[{"inlineContent":[{"type":"text","text":"display"}],"type":"paragraph"}]}],"type":"orderedList"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"code":"willDisplayCell","type":"codeVoice"},{"text":" is called on the delegate","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"the cell is made visible inside the ","type":"text"},{"code":"UICollectionView","type":"codeVoice"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"when the cell is scrolled off screen, "},{"type":"codeVoice","code":"didEndDisplaying"},{"type":"text","text":" is called for the cell, and it ends up in the reuse pool"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"How an app updates the display","level":3,"anchor":"How-an-app-updates-the-display","type":"heading"},{"inlineContent":[{"type":"text","text":"How an app produces a frame:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"commit"}]}]}],"type":"orderedList"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"for each frame, events such as touches are delivered to the app","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"in response, the app updates the properties of its views and layers"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"as a result of those changes, the app‚Äôs views and layers perform layout"}],"type":"paragraph"}]}],"type":"unorderedList"},{"start":2,"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"rendering"}]}]}],"type":"orderedList"},{"items":[{"content":[{"inlineContent":[{"text":"the layer tree is sent to the render server","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"each frame has a commit deadline, this is the time by which all commits for that frame need to finish"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the amount of time an app has to commit for each frame depends on the refresh rate of the display","type":"text"}]}]}],"type":"unorderedList"},{"inlineContent":[{"text":"What is a hitch?","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"when the commit for a frame takes too long and misses the deadline, those updates don‚Äôt get incorporated into the intended frame"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"the display keeps the previous frame on screen until the commit finishes, and this delayed frame can render"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"this is a commit hitch and is perceived as a momentary interruption when scrolling"}],"type":"paragraph"}]}],"type":"unorderedList"},{"text":"Cell prefetching","level":2,"anchor":"Cell-prefetching","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"from iOS 15 cells are pre-fetched after finishing a short commit","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"this makes them pre-ready for when they‚Äôre needed"}],"type":"paragraph"}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"How prefetching effects the cell lifecycle:"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"it is possible for a prepared cell to never be displayed, which could happen if the user suddenly changed the scroll direction"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"once a cell is displayed, it can go right back into the waiting state after it goes off screen"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"the same cell can be displayed more than once for the same index path","type":"text"}]}]}],"type":"unorderedList"},{"inlineContent":[{"text":"This means that a cell will not be immediately added to the reuse pool when it ends displaying.","type":"text"}],"type":"paragraph"},{"text":"Updating cell content","level":2,"anchor":"Updating-cell-content","type":"heading"},{"inlineContent":[{"type":"text","text":"When a cell needs to get\/display remote data, we shouldn‚Äôt update its content directly, as the cell might have been already reused to display other content."}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"iOS 15 introduces the "},{"type":"codeVoice","code":"reconfigureItems"},{"type":"text","text":" snapshot method: this method will rerun the associated cells registration‚Äôs configuration handler."}],"type":"paragraph"}]}],"type":"unorderedList"},{"code":["private func setPostNeedsUpdate(id: DestinationPost.ID) {","  var snapshot = dataSource.snapshot()","  snapshot.reconfigureItems([id]) \/\/ üëàüèª","  dataSource.apply(snapshot, animatingDifferences: true)","}"],"syntax":"swift","type":"codeListing"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"use this instead of "},{"code":"reloadItems","type":"codeVoice"},{"type":"text","text":", because it reuses the item‚Äôs existing cell, rather than dequeuing and configuring new cells"}],"type":"paragraph"}]}],"type":"unorderedList"},{"inlineContent":[{"text":"Example:","type":"text"}],"type":"paragraph"},{"code":["\/\/ Updating cells asynchronously","","let cellRegistration = UICollectionView.CellRegistration<DestinationPostCell,","                                                         DestinationPost.ID> {","  (cell, indexPath, postID) in","","  let post = self.postsStore.fetchByID(postID)","  let asset = self.assetsStore.fetchByID(post.assetID)","  ","  if asset.isPlaceholder {","    self.assetsStore.downloadAsset(post.assetID) { _ in","      self.setPostNeedsUpdate(id: post.id) \/\/ üëàüèª","    }","  }","  ","  cell.titleView.text = post.region","  cell.imageView.image = asset.image","}"],"syntax":"swift","type":"codeListing"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"to maximize prepare time, trigger downloads during the data-source prefetching."}]}]}],"type":"unorderedList"},{"text":"Image preparation APIs","level":3,"anchor":"Image-preparation-APIs","type":"heading"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"decoding and displaying images takes time","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"ideally, we could prepare the image in advance and only update the UI when the image decoding is completed"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"new in iOS 15, we have image preparation APIs, giving us control over where and when image preparation happens"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"these APIs produce a new "},{"type":"codeVoice","code":"UIImage"},{"type":"text","text":", which only contains the pixel data that the renderer needs"}]}]},{"content":[{"inlineContent":[{"text":"two forms:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"synchronous, which can on any thread","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"asynchronous, which run on an internal UIKit serial queue","type":"text"}]}]}],"type":"unorderedList"}]}],"type":"unorderedList"},{"code":["\/\/ Using prepareForDisplay","","\/\/ Initialize the full image","let fullImage = UIImage()","","\/\/ Set a placeholder before preparation","imageView.image = placeholderImage","","\/\/ Prepare the full image (in the background)","fullImage.prepareForDisplay { preparedImage in","  DispatchQueue.main.async {","    self.imageView.image = preparedImage","  }","}"],"syntax":"swift","type":"codeListing"},{"inlineContent":[{"type":"text","text":"Warning:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"these prepared images are not to be stored on disk, but should be cached","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"they take large amount of memory"}],"type":"paragraph"}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"Usage example:"}],"type":"paragraph"},{"code":["\/\/ Asset downloading ‚Äì with image preparation","","func downloadAsset(","  _ id: Asset.ID,"," completionHandler: @escaping (Asset) -> Void",") -> Cancellable {","  \/\/ Check for an already prepared image","  if let preparedAsset = imageCache.fetchByID(id) {","      completionHandler(preparedAsset)","      return AnyCancellable {}","  }","  return fetchAssetFromServer(assetID: id) { asset in","    asset.image.prepareForDisplay { preparedImage in","      \/\/ Store the image in the cache.","      self.imageCache.add(asset: asset.withImage(preparedImage!))","      DispatchQueue.main.async {","        completionHandler(asset)","      }","    }","  }","}"],"syntax":"swift","type":"codeListing"},{"inlineContent":[{"text":"New thumbnail API:","type":"text"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"text":"use less memory and computation","type":"text"}],"type":"paragraph"}]}]},{"type":"codeListing","syntax":"swift","code":["\/\/ Using prepareThumbnail","","\/\/ Initialize the full image","let profileImage = UIImage(...)","","\/\/ Set a placeholder before preparation","posterAvatarView.image = placeholderImage","","\/\/ Prepare the image","profileImage.prepareThumbnail(of: posterAvatarView.bounds.size) { thumbnailImage in","  DispatchQueue.main.async {","    self.posterAvatarView.image = thumbnailImage","  }","}"]},{"type":"heading","text":"Written By","level":2,"anchor":"Written-By"},{"type":"row","columns":[{"content":[{"type":"paragraph","inlineContent":[{"type":"image","identifier":"zntfdr"}]}],"size":1},{"content":[{"type":"heading","text":"Federico Zanetello","level":3,"anchor":"Federico-Zanetello"},{"type":"paragraph","inlineContent":[{"overridingTitle":"Contributed Notes","type":"reference","overridingTitleInlineContent":[{"text":"Contributed Notes","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","isActive":true},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"type":"reference","identifier":"https:\/\/github.com\/zntfdr","isActive":true},{"text":" ","type":"text"},{"text":"|","type":"text"},{"text":" ","type":"text"},{"type":"reference","identifier":"https:\/\/zntfdr.dev","isActive":true}]}],"size":4}],"numberOfColumns":5},{"type":"paragraph","inlineContent":[{"type":"text","text":"Missing anything? Corrections? "},{"type":"reference","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","isActive":true}]},{"type":"heading","text":"Related Sessions","level":2,"anchor":"Related-Sessions"},{"type":"links","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10059-Whats-new-in-UIKit","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10045-Advances-in-diffable-data-sources","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10097-Advances-in-UICollectionView"],"style":"list"},{"type":"small","inlineContent":[{"inlineContent":[{"type":"text","text":"Legal Notice"}],"type":"strong"}]},{"type":"small","inlineContent":[{"type":"text","text":"All content copyright ¬© 2012 ‚Äì 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}]}]}],"sampleCodeDownload":{"action":{"isActive":true,"overridingTitle":"Watch Video (22 min)","identifier":"https:\/\/developer.apple.com\/wwdc21\/10252","type":"reference"},"kind":"sampleDownload"},"kind":"article","variants":[{"paths":["\/documentation\/wwdcnotes\/wwdc21-10252-make-blazing-fast-lists-and-collection-views"],"traits":[{"interfaceLanguage":"swift"}]}],"references":{"WWDCNotes.png":{"type":"image","alt":null,"variants":[{"url":"\/images\/WWDCNotes.png","traits":["1x","light"]}],"identifier":"WWDCNotes.png"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"role":"collectionGroup","url":"\/documentation\/wwdcnotes\/wwdc21","title":"WWDC21","type":"topic","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21","abstract":[{"text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8.","type":"text"},{"text":" ","type":"text"},{"text":"New APIs: ","type":"text"},{"code":"MusicKit","type":"codeVoice"},{"text":", ","type":"text"},{"code":"DocC","type":"codeVoice"},{"text":", ","type":"text"},{"code":"StoreKit 2","type":"codeVoice"},{"text":", and more.","type":"text"}],"images":[{"identifier":"WWDC21-Icon.png","type":"icon"},{"identifier":"WWDC21.jpeg","type":"card"}],"kind":"article"},"doc://WWDCNotes/documentation/WWDCNotes":{"title":"WWDC Notes","url":"\/documentation\/wwdcnotes","images":[{"identifier":"WWDCNotes.png","type":"icon"}],"kind":"symbol","abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","role":"collection","type":"topic"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10059-Whats-new-in-UIKit":{"type":"topic","role":"sampleCode","abstract":[{"text":"Discover the latest updates and improvements to UIKit and learn how to build better iPadOS, iOS, and Mac Catalyst apps. We‚Äôll take you through UI refinements, productivity updates, and API enhancements, and help you explore performance improvements and security & privacy features.","type":"text"}],"title":"What‚Äôs new in UIKit","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10059-Whats-new-in-UIKit","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10059-whats-new-in-uikit"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10045-Advances-in-diffable-data-sources":{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10045-Advances-in-diffable-data-sources","abstract":[{"text":"Diffable data sources dramatically simplify the work involved in managing and updating collection and table views to create dynamic and responsive experiences in your apps. Discover how you can use section snapshots to efficiently build lists and outline collection views for iOS and iPadOS and provide support for implementing the sidebar in an iPad app. We‚Äôll also show you how to simplify cell reordering using UICollectionViewDiffableDataSource to help you streamline your code and build app interfaces more quickly.","type":"text"}],"url":"\/documentation\/wwdcnotes\/wwdc20-10045-advances-in-diffable-data-sources","role":"sampleCode","type":"topic","kind":"article","title":"Advances in diffable data sources"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC20-10097-Advances-in-UICollectionView":{"type":"topic","kind":"article","title":"Advances in UICollectionView","abstract":[{"type":"text","text":"Learn about new features of UICollectionView that make it easier to use and unlock powerful new functionality. We‚Äôll show you how to use section snapshots with your diffable data source to create outlines that can expand and collapse, and introduce you to building lists with compositional layout to create UITableView-like interfaces with a collection view. And discover modern techniques for dequeuing cells and configuring their content and styling."}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC20-10097-Advances-in-UICollectionView","url":"\/documentation\/wwdcnotes\/wwdc20-10097-advances-in-uicollectionview","role":"sampleCode"},"https://zntfdr.dev":{"titleInlineContent":[{"type":"text","text":"Blog"}],"type":"link","title":"Blog","identifier":"https:\/\/zntfdr.dev","url":"https:\/\/zntfdr.dev"},"https://developer.apple.com/wwdc21/10252":{"type":"download","identifier":"https:\/\/developer.apple.com\/wwdc21\/10252","url":"https:\/\/developer.apple.com\/wwdc21\/10252","checksum":null},"zntfdr.jpeg":{"type":"image","alt":null,"variants":[{"url":"\/images\/zntfdr.jpeg","traits":["1x","light"]}],"identifier":"zntfdr.jpeg"},"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"type":"topic","kind":"article","images":[{"identifier":"zntfdr.jpeg","type":"card"},{"identifier":"zntfdr.jpeg","type":"icon"}],"abstract":[{"text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more.","type":"text"}],"role":"sampleCode","title":"Federico Zanetello (332 notes)","url":"\/documentation\/wwdcnotes\/zntfdr","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr"},"https://github.com/zntfdr":{"titleInlineContent":[{"type":"text","text":"GitHub"}],"type":"link","title":"GitHub","identifier":"https:\/\/github.com\/zntfdr","url":"https:\/\/github.com\/zntfdr"},"WWDC21-Icon.png":{"type":"image","alt":null,"variants":[{"url":"\/images\/WWDC21-Icon.png","traits":["1x","light"]}],"identifier":"WWDC21-Icon.png"},"zntfdr":{"type":"image","alt":"Profile image of Federico Zanetello","variants":[{"url":"\/images\/zntfdr.jpeg","traits":["1x","light"]}],"identifier":"zntfdr"},"https://wwdcnotes.com/documentation/wwdcnotes/contributing":{"titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"type":"link","title":"Contributions are welcome!","identifier":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing","url":"https:\/\/wwdcnotes.com\/documentation\/wwdcnotes\/contributing"},"https://developer.apple.com/documentation/uikit/uiimage/building_high-performance_lists_and_collection_views":{"titleInlineContent":[{"type":"text","text":"Session code sample"}],"type":"link","title":"Session code sample","identifier":"https:\/\/developer.apple.com\/documentation\/uikit\/uiimage\/building_high-performance_lists_and_collection_views","url":"https:\/\/developer.apple.com\/documentation\/uikit\/uiimage\/building_high-performance_lists_and_collection_views"},"WWDC21.jpeg":{"type":"image","alt":null,"variants":[{"url":"\/images\/WWDC21.jpeg","traits":["1x","light"]}],"identifier":"WWDC21.jpeg"}}}