{"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/wwdcnotes\/wwdc21-10058-meet-asyncsequence"]}],"sections":[],"hierarchy":{"paths":[["doc:\/\/WWDCNotes\/documentation\/WWDCNotes","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21"]]},"schemaVersion":{"minor":3,"major":0,"patch":0},"identifier":{"url":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10058-Meet-AsyncSequence","interfaceLanguage":"swift"},"abstract":[{"type":"text","text":"Iterating over a sequence of values over time is now as easy as writing a “for” loop. Find out how the new AsyncSequence protocol enables a natural, simple syntax for iterating over anything from notifications to bytes being streamed from a server. We’ll also show you how to adapt existing code to provide asynchronous sequences of your own."}],"metadata":{"roleHeading":"WWDC21","role":"sampleCode","title":"Meet AsyncSequence","modules":[{"name":"WWDC Notes"}]},"primaryContentSections":[{"content":[{"level":2,"type":"heading","anchor":"overview","text":"Overview"},{"type":"paragraph","inlineContent":[{"text":"Map, filter, reduce, dropFirst all work in async sequences, for example:","type":"text"}]},{"syntax":"swift","code":["\/\/\/ This tool prints lines as we receive the `all_month.csv` file, ","\/\/\/ we don't need to wait for the complete file to download first.","@main","struct QuakesTool {","  static func main() async throws {","    let endpointURL = URL(string: \"https:\/\/earthquake.usgs.gov\/earthquakes\/feed\/v1.0\/summary\/all_month.csv\")!","","    \/\/ Skip the header line and iterate each one to extract the magnitude, time, latitude and longitude","    for try await event in endpointURL.lines.dropFirst() {","      let values = event.split(separator: \",\")","      let time = values[0]","      let latitude = values[1]","      let longitude = values[2]","      let magnitude = values[4]","      print(\"Magnitude \\(magnitude) on \\(time) at \\(latitude) \\(longitude)\")","    }","  }","}"],"type":"codeListing"},{"inlineContent":[{"text":"Async\/await key points:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"Async functions let you write concurrent code without the need for callbacks, by using the ","type":"text"},{"code":"await","type":"codeVoice"},{"text":" keyword","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"calling an async function will suspend the current flow, which is then resumed whenever a value or error is produced"}]}]}],"type":"unorderedList"},{"text":"What is AsyncSequence","level":2,"anchor":"What-is-AsyncSequence","type":"heading"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"AsyncSequence will suspend on each element and resume when the underlying iterator produces a value or throws"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"just like other sequences, except async - each element is delivered asynchronously","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"may throw","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"AsyncSequences either completes with success or stops when an error is thrown - depending if failure is an option"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"An async iterator also consumes its underlying collection.","type":"text"}]}]}],"type":"unorderedList"},{"inlineContent":[{"text":"Generally speaking, asynchronous sequences are a description of how to produce values over time:","type":"text"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"an async sequence may be zero or more values and then signify completion with returning a nil from its iterator, just like sequences"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"When an error occurs, the async sequence is at a terminal state - after an error happens, they’ll return ","type":"text"},{"type":"codeVoice","code":"nil"},{"text":" for any subsequent calls to ","type":"text"},{"type":"codeVoice","code":"next"},{"text":" on their iterator","type":"text"}]}]}],"type":"unorderedList"},{"inlineContent":[{"type":"text","text":"Things like "},{"type":"codeVoice","code":"break"},{"type":"text","text":" and "},{"type":"codeVoice","code":"continue"},{"type":"text","text":" work in async sequences too."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"You can cancel an iteration by holding on to its "},{"type":"codeVoice","code":"Task.Handle"},{"type":"text","text":" when you wrap it in "},{"type":"codeVoice","code":"async"},{"type":"text","text":":"}],"type":"paragraph"},{"syntax":"swift","code":["let handle = async {","  for await thing in list {","    \/\/ ...","  }","}","","handle.cancel()"],"type":"codeListing"},{"text":"Compiler transformation","level":2,"anchor":"Compiler-transformation","type":"heading"},{"inlineContent":[{"type":"text","text":"Take the following code:"}],"type":"paragraph"},{"syntax":"swift","code":["for quake in quakes {","  if quake.magnitude > 3 {","    displaySignificantEarthquake(quake)","  }","}"],"type":"codeListing"},{"inlineContent":[{"text":"The compiler will transform it into:","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["var iterator = quakes.makeIterator()","while let quake = iterator.next() {","  if quake.magnitude > 3 {","    displaySignificantEarthquake(quake)","  }","}"],"type":"codeListing"},{"inlineContent":[{"text":"if ","type":"text"},{"code":"quakes","type":"codeVoice"},{"text":" was an asyncSequence, it’d turn into:","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["var iterator = quakes.makeAsyncIterator()","while let quake = await iterator.next() {","  if quake.magnitude > 3 {","    displaySignificantEarthquake(quake)","  }","}"],"type":"codeListing"},{"text":"API highlight","level":2,"anchor":"API-highlight","type":"heading"},{"inlineContent":[{"type":"text","text":"Read bytes asynchronously from a "},{"code":"FileHandle","type":"codeVoice"},{"type":"text","text":":"}],"type":"paragraph"},{"syntax":"swift","code":["\/\/ bytes: AsyncBytes","for try await line in FileHandle.standardInput.bytes.lines {","  ...","}"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"Read lines asynchronously from a "},{"type":"codeVoice","code":"URL"},{"type":"text","text":":"}],"type":"paragraph"},{"syntax":"swift","code":["\/\/ lines: AsyncLineSequence<AsyncBytes>","let url = URL(fileURLWithPath: \"\/tmp\/somefile.txt\")","for try await line in url.lines {","  ...","}"],"type":"codeListing"},{"inlineContent":[{"text":"Read bytes asynchronously from a ","type":"text"},{"code":"URLSession","type":"codeVoice"},{"text":":","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["\/\/ you can use:","\/\/ func bytes(from: URL) async throws -> (AsyncBytes, URLResponse)","\/\/ func bytes(for: URLRequest) async throws -> (AsyncBytes, URLResponse)","","let (bytes, response) = try await URLSession.shared.bytes(from: url)","","guard let httpResponse = response as? HTTPURLResponse, httpResponse.statusCode == 200 \/* OK *\/","else { throw MyNetworkingError.invalidServerResponse }","","for try await byte in bytes {","  ...","}"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"Await notifications asynchronously:"}],"type":"paragraph"},{"syntax":"swift","code":["let center = NotificationCenter.default","let notification = await center.notifications(named: .NSPersistentStoreRemoteChange).first {","  $0.userInfo[NSStoreUUIDKey] == storeUUID","}"],"type":"codeListing"},{"text":"How to create async sequences","level":2,"anchor":"How-to-create-async-sequences","type":"heading"},{"inlineContent":[{"type":"text","text":"Pretty much anything that does not need a response back and is just informing of a new value that occurs can be a prime candidate for making an async sequence."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"Definition:"}],"type":"paragraph"},{"syntax":"swift","code":["public struct AsyncStream<Element>: AsyncSequence {","  public init(","    elementType: Element.Type = Element.self,","    maxBufferedElements limit: Int = .max,","    _ build: (Continuation) -> Void","  )","}","","\/\/ If we need to handle errors:","public struct AsynchrowingStream<Element>: AsyncSequence {","  public init(","    elementType: Element.Type = Element.self,","    maxBufferedElements limit: Int = .max,","    _ build: (Continuation) -> Void","  )","}"],"type":"codeListing"},{"inlineContent":[{"text":"Example:","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["class QuakeMonitor {","  var quakeHandler: (Quake) -> Void ","  func startMonitoring()","  func stopMonitoring()","}","","let quakes = AsyncStream(Quake.self) { continuation in","  let monitor = QuakeMonitor()","  monitor.quakeHandler = { quake in","    continuation.yield(quake)","  }","  continuation.onTermination = { @Sendable _ in","    monitor.stopMonitoring()","  }","  monitor.startMonitoring()","}","","let significantQuakes = quakes.filter { quake in","  quake.magnitude > 3","}","","for await quake in significantQuakes {","  ...","}"],"type":"codeListing"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"when constructing an async stream, an element type ("},{"type":"codeVoice","code":"Quake"},{"type":"text","text":") and construction closure is specified"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"The closure has a ","type":"text"},{"code":"continuation","type":"codeVoice"},{"text":" that can yield values more than once, finish, or handle termination","type":"text"}]}]}],"type":"unorderedList"},{"text":"Written By","level":2,"anchor":"Written-By","type":"heading"},{"type":"row","columns":[{"size":1,"content":[{"inlineContent":[{"type":"image","identifier":"https:\/\/avatars.githubusercontent.com\/u\/1272208?v=4"}],"type":"paragraph"}]},{"size":4,"content":[{"anchor":"Donny-Wals","text":"Donny Wals","type":"heading","level":3},{"inlineContent":[{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/donnywals","overridingTitle":"Contributed Notes","type":"reference","overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"isActive":true},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/github.com\/donnywals","type":"reference","isActive":true},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/www.donnywals.com","type":"reference","isActive":true}],"type":"paragraph"}]}],"numberOfColumns":5},{"type":"row","columns":[{"content":[{"type":"paragraph","inlineContent":[{"identifier":"https:\/\/avatars.githubusercontent.com\/u\/5277837?v=4","type":"image"}]}],"size":1},{"content":[{"text":"Federico Zanetello","anchor":"Federico-Zanetello","level":3,"type":"heading"},{"inlineContent":[{"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","overridingTitleInlineContent":[{"type":"text","text":"Contributed Notes"}],"overridingTitle":"Contributed Notes","isActive":true,"type":"reference"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/github.com\/zntfdr","isActive":true,"type":"reference"},{"type":"text","text":" "},{"type":"text","text":"|"},{"type":"text","text":" "},{"identifier":"https:\/\/zntfdr.dev","isActive":true,"type":"reference"}],"type":"paragraph"}],"size":4}],"numberOfColumns":5},{"inlineContent":[{"text":"Missing anything? Corrections? ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing"}],"type":"paragraph"},{"text":"Related Sessions","level":2,"anchor":"Related-Sessions","type":"heading"},{"style":"list","items":["doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-10020-Compose-advanced-models-with-Create-ML-Components","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110355-Meet-Swift-Async-Algorithms","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110379-Create-a-more-responsive-media-app","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10095-Use-asyncawait-with-URLSession","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10109-Whats-new-in-Foundation","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10132-Meet-asyncawait-in-Swift","doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10134-Explore-structured-concurrency-in-Swift"],"type":"links"},{"inlineContent":[{"type":"strong","inlineContent":[{"text":"Legal Notice","type":"text"}]}],"type":"small"},{"inlineContent":[{"type":"text","text":"All content copyright © 2012 – 2024 Apple Inc. All rights reserved."},{"type":"text","text":" "},{"type":"text","text":"Swift, the Swift logo, Swift Playgrounds, Xcode, Instruments, Cocoa Touch, Touch ID, FaceID, iPhone, iPad, Safari, Apple Vision, Apple Watch, App Store, iPadOS, watchOS, visionOS, tvOS, Mac, and macOS are trademarks of Apple Inc., registered in the U.S. and other countries."},{"type":"text","text":" "},{"type":"text","text":"This website is not made by, affiliated with, nor endorsed by Apple."}],"type":"small"}],"kind":"content"}],"sampleCodeDownload":{"action":{"identifier":"https:\/\/developer.apple.com\/wwdc21\/10058","overridingTitle":"Watch Video (14 min)","type":"reference","isActive":true},"kind":"sampleDownload"},"kind":"article","references":{"doc://WWDCNotes/documentation/WWDCNotes/zntfdr":{"kind":"article","title":"Federico Zanetello (330 notes)","url":"\/documentation\/wwdcnotes\/zntfdr","type":"topic","abstract":[{"text":"Software engineer with a strong passion for well-written code, thought-out composable architectures, automation, tests, and more.","type":"text"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/zntfdr","role":"sampleCode"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10132-Meet-asyncawait-in-Swift":{"type":"topic","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10132-meet-asyncawait-in-swift","role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10132-Meet-asyncawait-in-Swift","title":"Meet async\/await in Swift","abstract":[{"type":"text","text":"Swift now supports asynchronous functions — a pattern commonly known as async\/await. Discover how the new syntax can make your code easier to read and understand. Learn what happens when a function suspends, and find out how to adapt existing completion handlers to asynchronous functions."}]},"WWDCNotes.png":{"identifier":"WWDCNotes.png","type":"image","alt":null,"variants":[{"url":"\/images\/WWDCNotes.png","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes":{"kind":"symbol","title":"WWDC Notes","url":"\/documentation\/wwdcnotes","type":"topic","abstract":[{"text":"Session notes shared by the community for the community.","type":"text"}],"images":[{"identifier":"WWDCNotes.png","type":"icon"}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes","role":"collection"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110379-Create-a-more-responsive-media-app":{"role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110379-Create-a-more-responsive-media-app","abstract":[{"type":"text","text":"Discover how you can use AVFoundation to keep people focused on your media app’s content — not your loading spinner. We’ll show you how to support a responsive and fluid interface in your app, all while you create rich audiovisual compositions, load audiovisual assets, and prepare media thumbnails. Find out how you can perform these tasks on your app’s main thread while I\/O processes in parallel, learn how to get top-notch playback performance when loading data from custom storage, and more."}],"kind":"article","title":"Create a more responsive media app","type":"topic","url":"\/documentation\/wwdcnotes\/wwdc22-110379-create-a-more-responsive-media-app"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10095-Use-asyncawait-with-URLSession":{"kind":"article","title":"Use async\/await with URLSession","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10095-Use-asyncawait-with-URLSession","url":"\/documentation\/wwdcnotes\/wwdc21-10095-use-asyncawait-with-urlsession","role":"sampleCode","abstract":[{"text":"Discover how you can adopt Swift concurrency in URLSession using async\/await and AsyncSequence, and how you can apply Swift concurrency concepts to improve your networking code.","type":"text"}],"type":"topic"},"https://developer.apple.com/wwdc21/10058":{"identifier":"https:\/\/developer.apple.com\/wwdc21\/10058","url":"https:\/\/developer.apple.com\/wwdc21\/10058","checksum":null,"type":"download"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-110355-Meet-Swift-Async-Algorithms":{"role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-110355-Meet-Swift-Async-Algorithms","url":"\/documentation\/wwdcnotes\/wwdc22-110355-meet-swift-async-algorithms","abstract":[{"type":"text","text":"Discover the latest open source Swift package from Apple: Swift Async Algorithms. We’ll explore algorithms from this package that you can use with AsyncSequence, including zip, merge, and throttle. Follow along with us as we use these algorithms to build a great messaging app. We’ll also share best practices for combining multiple AsyncSequences and using the Swift Clock type to work with values over time."}],"type":"topic","title":"Meet Swift Async Algorithms","kind":"article"},"https://zntfdr.dev":{"identifier":"https:\/\/zntfdr.dev","url":"https:\/\/zntfdr.dev","titleInlineContent":[{"type":"text","text":"Blog"}],"type":"link","title":"Blog"},"doc://WWDCNotes/documentation/WWDCNotes/donnywals":{"role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/donnywals","url":"\/documentation\/wwdcnotes\/donnywals","abstract":[{"type":"text","text":"No Bio on GitHub"}],"type":"topic","title":"Donny Wals (3 notes)","kind":"article"},"https://avatars.githubusercontent.com/u/1272208?v=4":{"identifier":"https:\/\/avatars.githubusercontent.com\/u\/1272208?v=4","type":"image","alt":"Profile image of Donny Wals","variants":[{"url":"https:\/\/avatars.githubusercontent.com\/u\/1272208?v=4","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10109-Whats-new-in-Foundation":{"role":"sampleCode","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10109-Whats-new-in-Foundation","title":"What’s new in Foundation","kind":"article","url":"\/documentation\/wwdcnotes\/wwdc21-10109-whats-new-in-foundation","type":"topic","abstract":[{"text":"Discover how the latest updates to Foundation can help you improve your app’s localization and internationalization support. Find out about the new AttributedString, designed specifically for Swift, and learn how you can use Markdown to apply style to your localized strings. Explore the grammar agreement engine, which automatically fixes up localized strings so they match grammatical gender and pluralization. And we’ll take you through improvements to date and number formatting that simplify complex requirements while also improving performance.","type":"text"}]},"https://github.com/zntfdr":{"identifier":"https:\/\/github.com\/zntfdr","url":"https:\/\/github.com\/zntfdr","titleInlineContent":[{"type":"text","text":"GitHub"}],"type":"link","title":"GitHub"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC22-10020-Compose-advanced-models-with-Create-ML-Components":{"abstract":[{"type":"text","text":"Take your custom machine learning models to the next level with Create ML Components. We’ll show you how to work with temporal data like video or audio and compose models that can count repetitive human actions or provide advanced sound classification. We’ll also share best practices on using incremental fitting to speed up model training with new data."}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc22-10020-compose-advanced-models-with-create-ml-components","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC22-10020-Compose-advanced-models-with-Create-ML-Components","kind":"article","title":"Compose advanced models with Create ML Components","role":"sampleCode"},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21-10134-Explore-structured-concurrency-in-Swift":{"kind":"article","title":"Explore structured concurrency in Swift","url":"\/documentation\/wwdcnotes\/wwdc21-10134-explore-structured-concurrency-in-swift","role":"sampleCode","abstract":[{"type":"text","text":"When you have code that needs to run at the same time as other code, it’s important to choose the right tool for the job. We’ll take you through the different kinds of concurrent tasks you can create in Swift, show you how to create groups of tasks, and find out how to cancel tasks in progress. We’ll also provide guidance on when you may want to use unstructured tasks."}],"identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21-10134-Explore-structured-concurrency-in-Swift","type":"topic"},"https://avatars.githubusercontent.com/u/5277837?v=4":{"identifier":"https:\/\/avatars.githubusercontent.com\/u\/5277837?v=4","type":"image","alt":"Profile image of Federico Zanetello","variants":[{"url":"https:\/\/avatars.githubusercontent.com\/u\/5277837?v=4","traits":["1x","light"]}]},"doc://WWDCNotes/documentation/WWDCNotes/WWDC21":{"role":"collectionGroup","identifier":"doc:\/\/WWDCNotes\/documentation\/WWDCNotes\/WWDC21","abstract":[{"type":"text","text":"Xcode 13, Swift 5.5, iOS 15, macOS 12 (Monterey), tvOS 15, watchOS 8."},{"type":"text","text":" "},{"type":"text","text":"New APIs: "},{"type":"codeVoice","code":"MusicKit"},{"type":"text","text":", "},{"code":"DocC","type":"codeVoice"},{"text":", ","type":"text"},{"code":"StoreKit 2","type":"codeVoice"},{"text":", and more.","type":"text"}],"title":"WWDC21","images":[{"type":"icon","identifier":"WWDCNotes.png"}],"type":"topic","url":"\/documentation\/wwdcnotes\/wwdc21","kind":"article"},"https://www.donnywals.com":{"identifier":"https:\/\/www.donnywals.com","url":"https:\/\/www.donnywals.com","titleInlineContent":[{"type":"text","text":"Blog"}],"type":"link","title":"Blog"},"https://wwdcnotes.github.io/WWDCNotes/documentation/wwdcnotes/contributing":{"identifier":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing","url":"https:\/\/wwdcnotes.github.io\/WWDCNotes\/documentation\/wwdcnotes\/contributing","titleInlineContent":[{"type":"text","text":"Contributions are welcome!"}],"type":"link","title":"Contributions are welcome!"},"https://github.com/donnywals":{"identifier":"https:\/\/github.com\/donnywals","url":"https:\/\/github.com\/donnywals","titleInlineContent":[{"type":"text","text":"GitHub"}],"type":"link","title":"GitHub"}}}